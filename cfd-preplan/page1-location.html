<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pre-Fire Plan: Location</title>
<link rel="stylesheet" href="styles-preplan.css">

</head>
<body>
<div class="page-wrapper">
    <div class="container">
        <header class="report-header">
            <div class="header-top">
                <img src="images/cfd-logo.png" alt="Centerville Fire Department" class="patch-logo">
                <div class="header-text">
                    <h1>Centerville Fire Department</h1>
                    <h2>Pre-Fire Plan Data Sheet</h2>
                </div>
            </div>
        </header>

        <div class="progress-indicator">Page 1 of 12: Location</div>
        <div class="progress-bar-container">
            <div class="progress-bar" style="width: 8.33%"></div>
        </div>


        <h3 class="section-title">1. Location Information</h3>
        <form id="theForm">
            <div class="form-row">
                        <div class="form-field"><label for="pfp_number">Pre-Plan #:<span class="required">*</span></label><input type="text" id="pfp_number" name="pfp_number" required placeholder="PFP-2026-001"></div>
                        <div class="form-field"><label for="business_name">Business / Building Name:<span class="required">*</span></label><input type="text" id="business_name" name="business_name" required placeholder="Walmart Supercenter"></div>
            </div>
            <div class="form-row">
                        <div class="form-field"><label for="address">Address:<span class="required">*</span></label><input type="text" id="address" name="address" required placeholder="123 Main St, Centerville, GA 31028"></div>
                        <div class="form-field"><label for="telephone_no">Telephone:</label><input type="tel" id="telephone_no" name="telephone_no" placeholder="(478) 555-1234"></div>
            </div>
            <div class="form-row">
                        <div class="form-field"><label for="tax_id">Tax ID:</label><input type="text" id="tax_id" name="tax_id" placeholder="T001-234-567"></div>
                        <div class="form-field"><label for="fire_district">Fire District:</label><input type="text" id="fire_district" name="fire_district" placeholder="District 1"></div>
            </div>
            <div class="form-row">
                        <div class="form-field"><label for="latitude">Latitude:</label><input type="text" id="latitude" name="latitude" placeholder="32.8407"></div>
                        <div class="form-field"><label for="longitude">Longitude:</label><input type="text" id="longitude" name="longitude" placeholder="-83.6499"></div>
                        <div class="form-field" style="flex:0 0 auto;align-self:flex-end;">
                            <button type="button" id="gpsBtn" class="btn-secondary" onclick="getGPS()" style="white-space:nowrap;display:flex;align-items:center;gap:6px;padding:8px 14px;">
                                <span id="gpsIcon">üìç</span> <span id="gpsText">Get GPS</span>
                            </button>
                        </div>
            </div>
                    <div class="form-field"><label for="general_directions">General Directions to Site:</label><textarea id="general_directions" name="general_directions" rows="3" placeholder="Main entrance off Houston Rd, 2nd driveway past the light..."></textarea></div>
        </form>


        <div class="nav-buttons">
            <a href="preplan-index.html" class="btn-secondary">‚Üê Overview</a>
            <button type="button" class="btn-primary" onclick="navigate('page2-operating.html',document.getElementById('theForm'))">Next ‚Üí</button>
        </div>
    </div>
</div>
<footer>
    <img src="images/city-logo.png" alt="City of Centerville" class="city-logo">
    <p>¬© 2026 City of Centerville Fire Department</p>
</footer>
<div class="toast-container" id="toast-container"></div>
<script src="preplan-common.js"></script>
<script>
var form=document.getElementById('theForm');
if(form){loadFormData(form);autoSave(form);}

// Safari / iOS detection
var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

function getGPS(){
    var btn=document.getElementById('gpsBtn');
    var icon=document.getElementById('gpsIcon');
    var txt=document.getElementById('gpsText');
    if(!navigator.geolocation){
        showToast('GPS not available on this device','error');
        return;
    }
    btn.disabled=true;
    icon.textContent='‚è≥';
    txt.textContent='Locating...';

    // Check permission status first if available
    if(navigator.permissions && navigator.permissions.query){
        navigator.permissions.query({name:'geolocation'}).then(function(result){
            if(result.state === 'denied'){
                handleDenied(btn, icon, txt);
            } else {
                doGeolocate(btn, icon, txt);
            }
        }).catch(function(){
            // Safari doesn't support permissions.query for geolocation ‚Äî just try it
            doGeolocate(btn, icon, txt);
        });
    } else {
        doGeolocate(btn, icon, txt);
    }
}

function doGeolocate(btn, icon, txt){
    navigator.geolocation.getCurrentPosition(
        function(pos){
            document.getElementById('latitude').value=pos.coords.latitude.toFixed(6);
            document.getElementById('longitude').value=pos.coords.longitude.toFixed(6);
            document.getElementById('latitude').dispatchEvent(new Event('input',{bubbles:true}));
            document.getElementById('longitude').dispatchEvent(new Event('input',{bubbles:true}));
            icon.textContent='‚úÖ';
            txt.textContent='Got it!';
            showToast('GPS coordinates captured','success');
            setTimeout(function(){icon.textContent='üìç';txt.textContent='Get GPS';btn.disabled=false;},2000);
        },
        function(err){
            if(err.code===1){
                handleDenied(btn, icon, txt);
            } else {
                var msg='GPS failed';
                if(err.code===2) msg='Position unavailable ‚Äî make sure Location Services are on';
                else if(err.code===3) msg='GPS timed out ‚Äî try again';
                icon.textContent='‚ùå';
                txt.textContent='Failed';
                showToast(msg,'error');
                setTimeout(function(){icon.textContent='üìç';txt.textContent='Get GPS';btn.disabled=false;},2500);
            }
        },
        {enableHighAccuracy:true, timeout:15000, maximumAge:0}
    );
}

function handleDenied(btn, icon, txt){
    icon.textContent='üîí';
    txt.textContent='Blocked';
    setTimeout(function(){icon.textContent='üìç';txt.textContent='Get GPS';btn.disabled=false;},3000);
    showLocationHelp();
}

function showLocationHelp(){
    // Remove existing modal if any
    var existing = document.getElementById('gps-help-modal');
    if(existing) existing.remove();

    var overlay = document.createElement('div');
    overlay.id = 'gps-help-modal';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:99999;display:flex;justify-content:center;align-items:center;padding:20px;';

    var instructions = '';
    if(isIOS){
        instructions = '<div style="margin-bottom:12px;font-weight:700;color:#e67e22;font-size:15px;">üì± iPhone / iPad ‚Äî Safari</div>' +
            '<ol style="margin:0 0 0 18px;padding:0;line-height:1.8;font-size:14px;">' +
            '<li>Open the <b>Settings</b> app</li>' +
            '<li>Scroll down and tap <b>Safari</b></li>' +
            '<li>Scroll down to <b>Settings for Websites</b></li>' +
            '<li>Tap <b>Location</b></li>' +
            '<li>Find this website and set it to <b>Allow</b></li>' +
            '<li>Come back here and tap <b>Get GPS</b> again</li>' +
            '</ol>' +
            '<div style="margin-top:12px;padding:10px;background:#1a1a1e;border-radius:6px;border:1px solid #444;font-size:12px;color:#aaa;">' +
            'üí° Also make sure <b>Location Services</b> is turned on:<br>Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí <b>ON</b>, and Safari is set to <b>While Using</b>.' +
            '</div>';
    } else if(isSafari){
        instructions = '<div style="margin-bottom:12px;font-weight:700;color:#e67e22;font-size:15px;">üñ•Ô∏è Mac ‚Äî Safari</div>' +
            '<ol style="margin:0 0 0 18px;padding:0;line-height:1.8;font-size:14px;">' +
            '<li>In Safari, click <b>Safari</b> menu ‚Üí <b>Settings</b> (or Preferences)</li>' +
            '<li>Click the <b>Websites</b> tab</li>' +
            '<li>Select <b>Location</b> in the left sidebar</li>' +
            '<li>Find this website in the list</li>' +
            '<li>Change the dropdown to <b>Allow</b></li>' +
            '<li>Come back here and tap <b>Get GPS</b> again</li>' +
            '</ol>' +
            '<div style="margin-top:12px;padding:10px;background:#1a1a1e;border-radius:6px;border:1px solid #444;font-size:12px;color:#aaa;">' +
            'üí° Also check: System Settings ‚Üí Privacy & Security ‚Üí Location Services ‚Üí make sure it\'s <b>ON</b> and Safari is checked.' +
            '</div>';
    } else {
        instructions = '<div style="margin-bottom:12px;font-weight:700;color:#e67e22;font-size:15px;">üåê Browser Location Access</div>' +
            '<ol style="margin:0 0 0 18px;padding:0;line-height:1.8;font-size:14px;">' +
            '<li>Click the <b>lock icon</b> (üîí) in the address bar</li>' +
            '<li>Find <b>Location</b> and set it to <b>Allow</b></li>' +
            '<li>Reload the page and tap <b>Get GPS</b> again</li>' +
            '</ol>';
    }

    var modal = '<div style="background:#24242a;border-radius:12px;padding:24px;max-width:440px;width:100%;color:#fff;border:1px solid #444;position:relative;max-height:90vh;overflow-y:auto;">' +
        '<button onclick="document.getElementById(\'gps-help-modal\').remove()" style="position:absolute;top:10px;right:14px;background:none;border:none;color:#888;font-size:22px;cursor:pointer;line-height:1;">‚úï</button>' +
        '<h3 style="margin:0 0 14px 0;color:#e74c3c;font-size:17px;">üìç Location Access Blocked</h3>' +
        '<p style="color:#ccc;font-size:13px;margin-bottom:16px;line-height:1.5;">Your browser has blocked location access for this site. Follow these steps to enable it:</p>' +
        instructions +
        '<div style="margin-top:16px;text-align:center;">' +
        '<button onclick="document.getElementById(\'gps-help-modal\').remove();getGPS();" style="background:#e67e22;color:#fff;border:none;border-radius:8px;padding:10px 24px;font-size:14px;font-weight:600;cursor:pointer;margin-right:8px;">Try Again</button>' +
        '<button onclick="document.getElementById(\'gps-help-modal\').remove()" style="background:#555;color:#ccc;border:none;border-radius:8px;padding:10px 24px;font-size:14px;font-weight:600;cursor:pointer;">Close</button>' +
        '</div>' +
        '</div>';

    overlay.innerHTML = modal;
    overlay.addEventListener('click', function(e){ if(e.target === overlay) overlay.remove(); });
    document.body.appendChild(overlay);
}
</script>
</body>
</html>
