<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Fire Plan: Site Plan</title>
    <link rel="stylesheet" href="styles-preplan.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        .upload-area {
            border: 2px dashed var(--slate-300);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-lg);
        }
        .upload-area:hover { border-color: var(--navy-blue); background: var(--slate-50); }
        .upload-area.dragover { border-color: var(--fire-red); background: rgba(200, 16, 46, 0.05); }
        .canvas-wrapper {
            border: 2px solid var(--slate-300);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #f0f0f0;
            margin-bottom: var(--spacing-md);
        }
        #site-canvas { display: block; width: 100%; }
        .tool-group { display: flex; gap: var(--spacing-xs); padding: var(--spacing-xs); background: var(--slate-100); border-radius: var(--radius-md); flex-wrap: wrap; }
        .color-picker { width: 40px; height: 36px; border: 2px solid var(--slate-300); border-radius: var(--radius-sm); cursor: pointer; padding: 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <header class="report-header">
                <div class="header-top">
                    <img src="images/cfd-logo.png" alt="Centerville Fire Department Logo" class="patch-logo">
                    <div class="header-text">
                        <h1>Centerville Fire Department</h1>
                        <h2>Pre-Fire Plan Data Sheet</h2>
                    </div>
                </div>
            </header>

            <div class="progress-indicator">Page 10 of 12: Site Plan</div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 83.33%"></div>
            </div>

            <h3 class="section-title">10. Site Plan</h3>

            <!-- Upload Area -->
            <div id="upload-section">
                <div class="upload-area" id="upload-area">
                    <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">ğŸ—ºï¸</div>
                    <h4>Upload Site Plan Image</h4>
                    <p style="color: var(--slate-500);">Drag & drop an aerial image, site map, or screenshot here<br>or click to browse</p>
                    <p style="color: var(--slate-400); font-size: 0.85rem; margin-top: var(--spacing-sm);">Supports: JPG, PNG, GIF (Max 10MB)</p>
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                </div>
                <p style="text-align: center; color: var(--slate-500);">
                    <strong>Tip:</strong> Use Google Maps satellite view, screenshot your location, and upload it here for annotation.
                </p>
            </div>

            <!-- Annotation Tools (hidden until image loaded) -->
            <div id="annotation-section" class="hidden">
                <div class="annotation-toolbar">
                    <div class="tool-group">
                        <button type="button" class="tool-btn active" data-tool="select">â†–ï¸ Select</button>
                        <button type="button" class="tool-btn" data-tool="text">T Text</button>
                        <button type="button" class="tool-btn" data-tool="line">â€” Line</button>
                        <button type="button" class="tool-btn" data-tool="arrow">â†’ Arrow</button>
                        <button type="button" class="tool-btn" data-tool="rect">â–¢ Rectangle</button>
                        <button type="button" class="tool-btn" data-tool="circle">â—‹ Circle</button>
                    </div>
                    <div class="tool-group">
                        <input type="color" class="color-picker" id="stroke-color" value="#DC2626" title="Line/Border Color">
                        <input type="color" class="color-picker" id="fill-color" value="#FBBF24" title="Fill Color">
                    </div>
                    <div class="tool-group">
                        <button type="button" class="tool-btn" id="delete-btn">ğŸ—‘ï¸ Delete</button>
                        <button type="button" class="tool-btn" id="clear-btn">Clear All</button>
                    </div>
                </div>

                <div class="symbol-toolbar">
                    <span style="font-weight: 600; margin-right: var(--spacing-sm);">Fire Symbols:</span>
                    <button type="button" class="symbol-btn" data-symbol="hydrant">ğŸš° Hydrant</button>
                    <button type="button" class="symbol-btn" data-symbol="fdc">ğŸ”´ FDC</button>
                    <button type="button" class="symbol-btn" data-symbol="shutoff">â›” Shutoff</button>
                    <button type="button" class="symbol-btn" data-symbol="entry">ğŸšª Entry</button>
                    <button type="button" class="symbol-btn" data-symbol="hazmat">â˜¢ï¸ Hazmat</button>
                    <button type="button" class="symbol-btn" data-symbol="north">ğŸ§­ North</button>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="site-canvas" width="850" height="600"></canvas>
                </div>

                <div class="legend">
                    <h4>Symbol Legend</h4>
                    <div class="legend-items">
                        <div class="legend-item"><span style="color: red; font-size: 1.2rem;">â—</span> Fire Hydrant</div>
                        <div class="legend-item"><span style="color: orange; font-size: 1.2rem;">â– </span> FDC</div>
                        <div class="legend-item"><span style="color: red; font-size: 1.2rem;">â›”</span> Utility Shutoff</div>
                        <div class="legend-item"><span style="color: green; font-size: 1.2rem;">â–¶</span> Entry Point</div>
                        <div class="legend-item"><span style="color: purple; font-size: 1.2rem;">â—†</span> Hazmat Storage</div>
                    </div>
                </div>

                <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-md); flex-wrap: wrap;">
                    <button type="button" class="btn-secondary" id="new-image-btn">ğŸ“· New Image</button>
                    <button type="button" class="btn-secondary" id="export-png-btn">ğŸ’¾ Export as PNG</button>
                    <button type="button" class="btn-secondary" id="save-json-btn">ğŸ“ Save Project</button>
                    <button type="button" class="btn-secondary" id="load-json-btn">ğŸ“‚ Load Project</button>
                    <input type="file" id="load-json-input" accept=".json" style="display: none;">
                </div>
            </div>

            <form id="site-plan-form">
                <input type="hidden" name="site_plan_data" id="site-plan-data">
                
                <div class="form-actions">
                    <button type="button" id="prev-btn" class="btn-secondary">â† Previous</button>
                    <button type="button" id="next-btn" class="btn-primary">Next â†’ Floor Plan</button>
                </div>
            </form>
        </div>

        <footer>
            <img src="images/city-logo.png" alt="City of Centerville Logo" class="city-logo">
            <p>Â© 2026 City of Centerville Fire Department</p>
        </footer>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        let canvas = null;
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY, currentShape;
        const strokeColor = document.getElementById('stroke-color');
        const fillColor = document.getElementById('fill-color');

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // Upload handling
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const uploadSection = document.getElementById('upload-section');
        const annotationSection = document.getElementById('annotation-section');

        uploadArea.addEventListener('click', () => imageUpload.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleImageFile(e.dataTransfer.files[0]);
        });
        imageUpload.addEventListener('change', (e) => { if (e.target.files.length) handleImageFile(e.target.files[0]); });

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large (max 10MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => initCanvas(e.target.result);
            reader.readAsDataURL(file);
        }

        function initCanvas(imageUrl) {
            uploadSection.classList.add('hidden');
            annotationSection.classList.remove('hidden');

            if (!canvas) {
                canvas = new fabric.Canvas('site-canvas', { preserveObjectStacking: true });
                setupCanvasEvents();
            }

            fabric.Image.fromURL(imageUrl, (img) => {
                canvas.clear();
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                img.scale(scale);
                img.set({ left: 0, top: 0, selectable: false, evented: false });
                canvas.add(img);
                canvas.sendToBack(img);
                canvas.renderAll();
                showToast('Image loaded - start annotating!', 'success');
            });
        }

        function setupCanvasEvents() {
            canvas.on('mouse:down', (opt) => {
                if (currentTool === 'select') return;
                
                const pointer = canvas.getPointer(opt.e);
                startX = pointer.x;
                startY = pointer.y;
                isDrawing = true;

                if (currentTool === 'text') {
                    const text = new fabric.IText('Label', {
                        left: startX, top: startY,
                        fontSize: 16, fill: strokeColor.value,
                        fontFamily: 'Arial', fontWeight: 'bold'
                    });
                    canvas.add(text).setActiveObject(text);
                    text.enterEditing();
                    isDrawing = false;
                } else if (currentTool === 'line') {
                    currentShape = new fabric.Line([startX, startY, startX, startY], {
                        stroke: strokeColor.value, strokeWidth: 3
                    });
                    canvas.add(currentShape);
                } else if (currentTool === 'arrow') {
                    currentShape = new fabric.Line([startX, startY, startX, startY], {
                        stroke: strokeColor.value, strokeWidth: 3
                    });
                    canvas.add(currentShape);
                } else if (currentTool === 'rect') {
                    currentShape = new fabric.Rect({
                        left: startX, top: startY, width: 1, height: 1,
                        fill: 'transparent', stroke: strokeColor.value, strokeWidth: 3
                    });
                    canvas.add(currentShape);
                } else if (currentTool === 'circle') {
                    currentShape = new fabric.Circle({
                        left: startX, top: startY, radius: 1,
                        fill: 'transparent', stroke: strokeColor.value, strokeWidth: 3
                    });
                    canvas.add(currentShape);
                }
            });

            canvas.on('mouse:move', (opt) => {
                if (!isDrawing || !currentShape) return;
                const pointer = canvas.getPointer(opt.e);

                if (currentTool === 'line' || currentTool === 'arrow') {
                    currentShape.set({ x2: pointer.x, y2: pointer.y });
                } else if (currentTool === 'rect') {
                    const w = pointer.x - startX;
                    const h = pointer.y - startY;
                    currentShape.set({
                        width: Math.abs(w), height: Math.abs(h),
                        left: w < 0 ? pointer.x : startX,
                        top: h < 0 ? pointer.y : startY
                    });
                } else if (currentTool === 'circle') {
                    const radius = Math.sqrt(Math.pow(pointer.x - startX, 2) + Math.pow(pointer.y - startY, 2)) / 2;
                    currentShape.set({ radius: radius });
                }
                canvas.renderAll();
            });

            canvas.on('mouse:up', () => {
                if (currentTool === 'arrow' && currentShape) {
                    // Add arrowhead
                    const coords = currentShape.calcLinePoints();
                    const angle = Math.atan2(coords.y2 - coords.y1, coords.x2 - coords.x1);
                    const headLen = 15;
                    const arrowHead = new fabric.Triangle({
                        left: currentShape.x2, top: currentShape.y2,
                        width: headLen, height: headLen,
                        fill: strokeColor.value, angle: (angle * 180 / Math.PI) + 90,
                        originX: 'center', originY: 'center'
                    });
                    canvas.add(arrowHead);
                }
                isDrawing = false;
                currentShape = null;
                saveCanvasData();
            });
        }

        // Tool selection
        document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tool-btn[data-tool]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
                canvas.isDrawingMode = false;
                canvas.selection = currentTool === 'select';
            });
        });

        // Symbol buttons
        document.querySelectorAll('.symbol-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!canvas) return;
                const symbol = btn.dataset.symbol;
                let obj;

                switch(symbol) {
                    case 'hydrant':
                        obj = new fabric.Circle({ radius: 12, fill: 'red', stroke: 'darkred', strokeWidth: 2 });
                        break;
                    case 'fdc':
                        obj = new fabric.Rect({ width: 24, height: 24, fill: 'orange', stroke: 'darkorange', strokeWidth: 2 });
                        break;
                    case 'shutoff':
                        obj = new fabric.Circle({ radius: 10, fill: 'yellow', stroke: 'red', strokeWidth: 3 });
                        break;
                    case 'entry':
                        obj = new fabric.Triangle({ width: 20, height: 24, fill: 'green', stroke: 'darkgreen', strokeWidth: 2 });
                        break;
                    case 'hazmat':
                        obj = new fabric.Rect({ width: 20, height: 20, fill: 'purple', stroke: 'indigo', strokeWidth: 2, angle: 45 });
                        break;
                    case 'north':
                        obj = new fabric.Text('N', { fontSize: 28, fill: 'black', fontWeight: 'bold', fontFamily: 'Arial' });
                        break;
                }

                if (obj) {
                    obj.set({ left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center' });
                    canvas.add(obj).setActiveObject(obj);
                    canvas.renderAll();
                    saveCanvasData();
                }
            });
        });

        // Delete selected
        document.getElementById('delete-btn').addEventListener('click', () => {
            const active = canvas.getActiveObjects();
            if (active.length) {
                active.forEach(obj => {
                    if (obj.selectable) canvas.remove(obj);
                });
                canvas.discardActiveObject();
                canvas.renderAll();
                saveCanvasData();
            }
        });

        // Clear all annotations (keep background)
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (!confirm('Clear all annotations?')) return;
            const objects = canvas.getObjects();
            const bg = objects[0]; // Background image
            canvas.clear();
            if (bg) canvas.add(bg);
            canvas.renderAll();
            saveCanvasData();
        });

        // New image
        document.getElementById('new-image-btn').addEventListener('click', () => {
            if (confirm('Load a new image? Current annotations will be lost.')) {
                uploadSection.classList.remove('hidden');
                annotationSection.classList.add('hidden');
                if (canvas) canvas.clear();
            }
        });

        // Export PNG
        document.getElementById('export-png-btn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'site-plan.png';
            link.href = canvas.toDataURL({ format: 'png', multiplier: 2 });
            link.click();
            showToast('PNG exported', 'success');
        });

        // Save JSON
        document.getElementById('save-json-btn').addEventListener('click', () => {
            const json = JSON.stringify(canvas.toJSON());
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.download = 'site-plan-project.json';
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast('Project saved', 'success');
        });

        // Load JSON
        document.getElementById('load-json-btn').addEventListener('click', () => {
            document.getElementById('load-json-input').click();
        });

        document.getElementById('load-json-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                uploadSection.classList.add('hidden');
                annotationSection.classList.remove('hidden');
                if (!canvas) {
                    canvas = new fabric.Canvas('site-canvas', { preserveObjectStacking: true });
                    setupCanvasEvents();
                }
                canvas.loadFromJSON(JSON.parse(evt.target.result), () => {
                    canvas.renderAll();
                    // Make first object (background) unselectable
                    const objs = canvas.getObjects();
                    if (objs.length) objs[0].set({ selectable: false, evented: false });
                    showToast('Project loaded', 'success');
                });
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function saveCanvasData() {
            if (canvas) {
                document.getElementById('site-plan-data').value = JSON.stringify(canvas.toJSON());
                saveData();
            }
        }

        function getSavedData() { return JSON.parse(localStorage.getItem('preFirePlan') || '{}'); }

        function saveData() {
            const data = { ...getSavedData() };
            data.site_plan_data = document.getElementById('site-plan-data').value;
            localStorage.setItem('preFirePlan', JSON.stringify(data));
        }

        // Load saved canvas data
        window.addEventListener('load', () => {
            const saved = getSavedData();
            if (saved.site_plan_data) {
                try {
                    uploadSection.classList.add('hidden');
                    annotationSection.classList.remove('hidden');
                    canvas = new fabric.Canvas('site-canvas', { preserveObjectStacking: true });
                    setupCanvasEvents();
                    canvas.loadFromJSON(JSON.parse(saved.site_plan_data), () => {
                        canvas.renderAll();
                        const objs = canvas.getObjects();
                        if (objs.length) objs[0].set({ selectable: false, evented: false });
                    });
                } catch (e) { console.error('Failed to load saved canvas', e); }
            }
        });

        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        function navigate(url) { saveCanvasData(); window.location.href = url; }

        prevBtn.addEventListener('click', () => navigate('page9-hazardous-materials.html'));
        nextBtn.addEventListener('click', () => {
            saveCanvasData();
            showToast('Site plan saved', 'success');
            setTimeout(() => navigate('page11-floor-plan.html'), 500);
        });
    </script>
</body>
</html>
