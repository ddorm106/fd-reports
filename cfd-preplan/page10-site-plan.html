<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pre-Fire Plan: Site Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles-preplan.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
.canvas-wrapper{border:2px solid var(--border);border-radius:8px;overflow:hidden;margin:12px 0}
.site-toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.site-toolbar button{padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:12px;font-weight:600}
.site-toolbar button:hover{background:#e2e8f0}
.site-toolbar button.active{background:var(--primary);color:white;border-color:var(--primary)}
</style>
</head>
<body>
<div class="preplan-container">
    <div class="preplan-header"><h3>Page 10: Site Plan</h3></div>
    <div class="preplan-section">
        <div class="info-tip">Upload a satellite image or screenshot of the building site, then annotate with labels, access points, and hazards.</div>
        <div id="uploadSection">
            <div style="border:2px dashed var(--border);border-radius:12px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('siteImg').click()">
                <p style="font-size:32px;margin-bottom:8px">üó∫Ô∏è</p>
                <p><strong>Upload site image</strong></p>
                <p style="font-size:12px;color:#888">Satellite view, aerial photo, or sketch</p>
                <input type="file" id="siteImg" accept="image/*" style="display:none">
            </div>
            <div style="text-align:center;margin-top:12px"><button class="btn-secondary" onclick="startBlank()">Start Blank Canvas</button></div>
        </div>
        <div id="annotSection" class="hidden">
            <div class="site-toolbar">
                <button class="active" data-tool="select">üîç Select</button>
                <button data-tool="draw">‚úèÔ∏è Draw</button>
                <button data-tool="text">Aa Text</button>
                <button data-tool="label">üè∑Ô∏è Label</button>
                <button onclick="deleteSelected()">üóëÔ∏è Delete</button>
                <input type="color" id="siteColor" value="#ff0000" style="width:28px;height:26px;border:1px solid #ccc;border-radius:4px">
            </div>
            <div class="canvas-wrapper"><canvas id="site-canvas" width="900" height="550"></canvas></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn-secondary" onclick="document.getElementById('siteImg2').click()">üì∑ New Image</button>
                <button class="btn-secondary" onclick="exportPng()">üíæ Export PNG</button>
                <input type="file" id="siteImg2" accept="image/*" style="display:none">
            </div>
        </div>
    </div>
    <div class="form-actions">
        <button type="button" class="btn-secondary" onclick="saveSite();window.location.href='page9-hazardous-materials.html'">‚Üê Previous</button>
        <button type="button" class="btn-primary" onclick="saveSite();window.location.href='page11-floor-plan.html'">Next ‚Üí Floor Plan</button>
    </div>
</div>
<footer><p>¬© 2026 City of Centerville Fire Department</p></footer>
<script>
var canvas,currentTool='select';
function initCanvas(bgUrl){
    canvas=new fabric.Canvas('site-canvas',{preserveObjectStacking:true,backgroundColor:'white'});
    if(bgUrl){fabric.Image.fromURL(bgUrl,function(img){img.scaleToWidth(canvas.width);img.set({selectable:false,evented:false,isBg:true});canvas.add(img);canvas.sendToBack(img);canvas.renderAll()})}
    canvas.on('mouse:down',function(o){
        if(currentTool==='text'&&o.pointer){var t=prompt('Enter text:');if(t)canvas.add(new fabric.IText(t,{left:o.pointer.x,top:o.pointer.y,fontSize:14,fill:document.getElementById('siteColor').value,fontFamily:'Arial'}))}
        if(currentTool==='label'&&o.pointer){var t=prompt('Label:');if(t){var g=new fabric.Group([new fabric.Rect({width:t.length*8+16,height:22,fill:document.getElementById('siteColor').value,rx:4,ry:4,originX:'center',originY:'center'}),new fabric.Text(t,{fontSize:12,fill:'#fff',fontWeight:'bold',originX:'center',originY:'center'})],{left:o.pointer.x,top:o.pointer.y});canvas.add(g)}}
    });
    canvas.on('object:modified',function(){saveSite()});
    canvas.on('path:created',function(){saveSite()});
}
document.querySelectorAll('.site-toolbar button[data-tool]').forEach(function(b){b.onclick=function(){document.querySelectorAll('.site-toolbar button[data-tool]').forEach(function(x){x.classList.remove('active')});b.classList.add('active');currentTool=b.dataset.tool;canvas.isDrawingMode=currentTool==='draw';if(canvas.isDrawingMode){canvas.freeDrawingBrush.color=document.getElementById('siteColor').value;canvas.freeDrawingBrush.width=3}canvas.selection=currentTool==='select'}});
function deleteSelected(){var s=canvas.getActiveObjects();s.forEach(function(o){if(!o.isBg)canvas.remove(o)});canvas.discardActiveObject();canvas.renderAll();saveSite()}
function exportPng(){var a=document.createElement('a');a.download='site-plan.png';a.href=canvas.toDataURL({format:'png',quality:1});a.click()}
function saveSite(){if(!canvas)return;var d=JSON.parse(localStorage.getItem('preFirePlan')||'{}');d.site_plan_data=JSON.stringify(canvas.toJSON(['isBg']));localStorage.setItem('preFirePlan',JSON.stringify(d))}
function loadSite(){try{var d=JSON.parse(localStorage.getItem('preFirePlan')||'{}');if(d.site_plan_data){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(null);canvas.loadFromJSON(d.site_plan_data,function(){canvas.renderAll()})}}catch(e){}}
function startBlank(){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(null)}
document.getElementById('siteImg').onchange=function(){if(this.files[0]){var r=new FileReader();r.onload=function(e){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(e.target.result)};r.readAsDataURL(this.files[0])}};
document.getElementById('siteImg2').onchange=function(){if(this.files[0]){var r=new FileReader();r.onload=function(e){var bg=canvas.getObjects().find(function(o){return o.isBg});if(bg)canvas.remove(bg);fabric.Image.fromURL(e.target.result,function(img){img.scaleToWidth(canvas.width);img.set({selectable:false,evented:false,isBg:true});canvas.add(img);canvas.sendToBack(img);canvas.renderAll();saveSite()})};r.readAsDataURL(this.files[0])}};
window.addEventListener('load',loadSite);
</script>
</body>
</html>
