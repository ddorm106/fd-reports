<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Fire Plan: Fire Flow Data</title>
    <link rel="stylesheet" href="styles-preplan.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .calc-section{background:linear-gradient(135deg,var(--slate-50) 0%,var(--slate-100) 100%);border:2px solid var(--navy-blue);border-radius:var(--radius-lg);padding:var(--spacing-lg);margin-bottom:var(--spacing-lg)}
        .calc-section h4{font-family:var(--font-display);color:var(--navy-blue);margin-bottom:var(--spacing-md);display:flex;align-items:center;gap:8px}
        .formula-box{background:#1e3a5f;color:white;padding:12px 16px;border-radius:8px;font-family:monospace;font-size:0.9rem;margin:12px 0;display:inline-block}
        .formula-box .var{color:#fbbf24}
        .result-box{background:linear-gradient(135deg,var(--navy-blue) 0%,var(--navy-dark) 100%);color:var(--white);padding:var(--spacing-lg);border-radius:var(--radius-lg);margin-top:var(--spacing-md)}
        .result-box .result-value{font-size:2.2rem;font-weight:700;color:var(--amber-400)}
        .result-box .result-label{font-size:0.85rem;color:var(--slate-300);margin-top:4px}
        .calc-btn{background:var(--fire-red);color:white;border:none;padding:var(--spacing-md) var(--spacing-xl);border-radius:var(--radius-md);font-family:var(--font-display);font-weight:600;cursor:pointer;transition:all var(--transition-fast)}
        .calc-btn:hover{background:var(--fire-red-dark);transform:translateY(-2px)}
        .add-row-btn,.upload-btn{background:var(--navy-blue);color:white;border:none;padding:var(--spacing-sm) var(--spacing-md);border-radius:var(--radius-md);cursor:pointer;margin-right:8px}
        .add-row-btn:hover,.upload-btn:hover{background:var(--navy-dark)}
        .hydrant-table{width:100%;border-collapse:collapse;font-size:0.85rem;margin-top:12px}
        .hydrant-table th,.hydrant-table td{padding:8px;border:1px solid #cbd5e1;text-align:left}
        .hydrant-table th{background:#1e3a5f;color:white;font-weight:600}
        .hydrant-table input{width:100%;padding:4px;border:1px solid #cbd5e1;border-radius:4px;font-size:0.8rem}
        .hydrant-table input[readonly]{background:#f1f5f9;color:#475569}
        .hydrant-match{background:#dcfce7;border-left:3px solid #22c55e}
        .info-tip{background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;border-radius:0 8px 8px 0;margin:12px 0;font-size:0.85rem}
        .step-badge{background:var(--fire-red);color:white;width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:bold;margin-right:8px}
        .mini-result{background:#e0f2fe;padding:8px 12px;border-radius:6px;font-weight:600;color:#0369a1;display:inline-block;margin:4px 0}
        .occupancy-examples{font-size:0.75rem;color:#64748b;margin-top:4px}
        .tab-container{display:flex;gap:4px;margin-bottom:0}
        .tab-btn{padding:10px 20px;background:#e2e8f0;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;color:#475569}
        .tab-btn.active{background:#1e3a5f;color:white}
        .tab-content{display:none;border:2px solid #1e3a5f;border-top:none;padding:20px;border-radius:0 0 12px 12px;background:white}
        .tab-content.active{display:block}
        .gps-input{display:flex;gap:8px;align-items:center}
        .gps-input input{flex:1}
        .locate-btn{background:#22c55e;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;white-space:nowrap}
        .locate-btn:hover{background:#16a34a}
        .file-drop{border:2px dashed #cbd5e1;border-radius:12px;padding:30px;text-align:center;cursor:pointer;margin:12px 0;transition:all 0.2s}
        .file-drop:hover{border-color:#1e3a5f;background:#f8fafc}
        .file-drop.dragover{border-color:#22c55e;background:#dcfce7}
        .matched-hydrants{margin-top:16px}
        .matched-hydrant-card{background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:12px;margin:8px 0}
        .matched-hydrant-card h5{color:#166534;margin:0 0 8px 0;font-size:0.9rem}
        .matched-hydrant-card .distance{color:#22c55e;font-weight:600}
    </style>
</head>
<body>
<div class="page-wrapper">
<div class="container">
    <header class="report-header"><div class="header-top">
        <img src="images/cfd-logo.png" alt="Centerville Fire Department Logo" class="patch-logo">
        <div class="header-text"><h1>Centerville Fire Department</h1><h2>Pre-Fire Plan Data Sheet</h2></div>
    </div></header>

    <div class="progress-indicator">Page 8 of 12: Fire Flow Data</div>
    <div class="progress-bar-container"><div class="progress-bar" style="width:66.66%"></div></div>

    <h3 class="section-title">8. Fire Flow Data</h3>

    <!-- Tabs -->
    <div class="tab-container">
        <button class="tab-btn active" data-tab="nff-calc">üî• ISO Needed Fire Flow</button>
        <button class="tab-btn" data-tab="hydrant-calc">üöí Hydrant Flow Test</button>
        <button class="tab-btn" data-tab="hydrant-data">üìä Hydrant Database</button>
    </div>

    <form id="fire-flow-form">
        <!-- Tab 1: ISO Needed Fire Flow Calculator -->
        <div id="nff-calc" class="tab-content active">
            <h4><span class="step-badge">1</span> ISO Needed Fire Flow (NFF) Calculator</h4>
            <div class="info-tip">
                <strong>ISO Formula:</strong> NFF = C √ó O √ó [1 + (X + P)]<br>
                Where C = 18 √ó F √ó ‚àöA (Construction Factor)
            </div>
            
            <div class="formula-box">
                NFF<sub>i</sub> = (<span class="var">C</span><sub>i</sub>)(<span class="var">O</span><sub>i</sub>)[1.0 + (<span class="var">X</span> + <span class="var">P</span>)<sub>i</sub>]
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="construction_class"><span class="step-badge">1</span> ISO Construction Class (F):</label>
                    <select id="construction_class" name="construction_class">
                        <option value="1.5">Class 1 - Frame (F=1.5)</option>
                        <option value="1.0">Class 2 - Joisted Masonry (F=1.0)</option>
                        <option value="0.8">Class 3 - Non-Combustible (F=0.8)</option>
                        <option value="0.8">Class 4 - Masonry Non-Combustible (F=0.8)</option>
                        <option value="0.6">Class 5 - Modified Fire Resistive (F=0.6)</option>
                        <option value="0.6">Class 6 - Fire Resistive (F=0.6)</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="effective_area"><span class="step-badge">2</span> Effective Area (A) sq ft:<span class="required">*</span></label>
                    <input type="number" id="effective_area" name="effective_area" min="0" required placeholder="Total floor area">
                    <div class="occupancy-examples">Classes 1-4: Largest floor + 50% other floors | Classes 5-6: See ISO guide</div>
                </div>
            </div>

            <div id="c-factor-result" class="mini-result" style="display:none">
                C Factor: <span id="c-factor-value">0</span> GPM (rounded to nearest 250)
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="occupancy_factor"><span class="step-badge">3</span> Occupancy Combustibility Class (O):</label>
                    <select id="occupancy_factor" name="occupancy_factor">
                        <option value="0.75">C-1 Noncombustible (O=0.75) - Metal storage, clay</option>
                        <option value="0.85">C-2 Limited Combustible (O=0.85) - Office, church, hospital</option>
                        <option value="1.00" selected>C-3 Combustible (O=1.00) - Retail, restaurant, theater</option>
                        <option value="1.15">C-4 Free Burning (O=1.15) - Lumber, furniture mfg</option>
                        <option value="1.25">C-5 Rapid/Flash Burning (O=1.25) - Flammables, explosives</option>
                    </select>
                    <div class="occupancy-examples" id="occupancy-examples"></div>
                </div>
                <div class="form-field">
                    <label for="exposure_factor"><span class="step-badge">4</span> Exposure Factor (X) 0‚Äì0.40:</label>
                    <input type="number" id="exposure_factor" name="exposure_factor" step="0.01" min="0" max="0.40" value="0" placeholder="Adjacent building exposure">
                    <div class="occupancy-examples">Based on distance & construction of adjacent buildings (Table 330A)</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="comm_factor"><span class="step-badge">5</span> Communication Factor (P) 0‚Äì0.30:</label>
                    <input type="number" id="comm_factor" name="comm_factor" step="0.01" min="0" max="0.30" value="0" placeholder="Passageway factor">
                    <div class="occupancy-examples">Based on passageways between buildings (Table 330B). Max X+P = 0.60</div>
                </div>
                <div class="form-field">
                    <label class="inline-label" style="margin-top:24px">Additional Factors:</label>
                    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="sprinkler_credit" name="sprinkler_credit" value="Yes">
                            <span>NFPA 13 Sprinklered (use sprinkler demand)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                            <input type="checkbox" id="wood_shingle" name="wood_shingle" value="Yes">
                            <span>Wood Shingle Roof (+500 GPM)</span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="button" id="calculate-nff-btn" class="calc-btn">Calculate Needed Fire Flow</button>

            <div id="nff-result" class="result-box" style="display:none">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
                    <div>
                        <div class="result-label">Construction Factor (C)</div>
                        <div class="result-value" id="result-c">0 GPM</div>
                        <div style="color:#94a3b8;font-size:0.8rem">C = 18 √ó F √ó ‚àöA</div>
                    </div>
                    <div>
                        <div class="result-label">Needed Fire Flow (NFF)</div>
                        <div class="result-value" id="result-nff">0 GPM</div>
                        <div style="color:#94a3b8;font-size:0.8rem">NFF = C √ó O √ó [1 + (X+P)]</div>
                    </div>
                    <div>
                        <div class="result-label">Required Duration</div>
                        <div class="result-value" id="result-duration">2 hrs</div>
                        <div style="color:#94a3b8;font-size:0.8rem">At 20 PSI residual</div>
                    </div>
                </div>
                <div id="calc-breakdown" style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.2);font-size:0.85rem;color:#cbd5e1"></div>
            </div>
        </div>

        <!-- Tab 2: Hydrant Flow Test Calculator -->
        <div id="hydrant-calc" class="tab-content">
            <h4>üöí ISO Hydrant Flow Test Calculator</h4>
            <div class="info-tip">
                <strong>ISO Q Formula:</strong> Q = 29.83 √ó C √ó d¬≤ √ó ‚àöp √ó n<br>
                <strong>Hazen-Williams AFF:</strong> Available Fire Flow = Q √ó ((S-20)^0.54 / (S-R)^0.54)
            </div>

            <div class="formula-box">
                <span class="var">Q</span> = 29.83 √ó <span class="var">C</span> √ó <span class="var">d</span>¬≤ √ó ‚àö<span class="var">p</span> √ó <span class="var">n</span>
                &nbsp;&nbsp;|&nbsp;&nbsp;
                <span class="var">AFF</span> = Q √ó ((S-20)<sup>0.54</sup> / (S-R)<sup>0.54</sup>)
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="hydrant_location">Hydrant Location:</label>
                    <input type="text" id="hydrant_location" name="hydrant_location" placeholder="e.g., NE Corner of Main & 1st">
                </div>
                <div class="form-field">
                    <label for="hydrant_gps">GPS Coordinates (optional):</label>
                    <div class="gps-input">
                        <input type="text" id="hydrant_gps" name="hydrant_gps" placeholder="32.6234, -83.6865">
                        <button type="button" class="locate-btn" id="get-location-btn">üìç Get GPS</button>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="static_pressure">Static Pressure (S) psi:<span class="required">*</span></label>
                    <input type="number" id="static_pressure" name="static_pressure" step="0.1" placeholder="e.g., 65">
                </div>
                <div class="form-field">
                    <label for="residual_pressure">Residual Pressure (R) psi:<span class="required">*</span></label>
                    <input type="number" id="residual_pressure" name="residual_pressure" step="0.1" placeholder="e.g., 45">
                </div>
                <div class="form-field">
                    <label for="pitot_pressure">Pitot Pressure (p) psi:<span class="required">*</span></label>
                    <input type="number" id="pitot_pressure" name="pitot_pressure" step="0.1" placeholder="e.g., 25">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="outlet_diameter">Outlet Diameter (d) inches:</label>
                    <select id="outlet_diameter" name="outlet_diameter">
                        <option value="2.5" selected>2.5" (standard)</option>
                        <option value="2.0">2.0"</option>
                        <option value="4.0">4.0" (pumper)</option>
                        <option value="4.5">4.5" (pumper)</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="num_outlets">Number of Outlets Flowing (n):</label>
                    <select id="num_outlets" name="num_outlets">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="coefficient">Coefficient (C):</label>
                    <select id="coefficient" name="coefficient">
                        <option value="0.9" selected>0.90 - Rounded outlet (typical)</option>
                        <option value="0.8">0.80 - Square outlet</option>
                        <option value="0.7">0.70 - Square projecting into barrel</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="flow_test_date">Flow Test Date:</label>
                    <input type="date" id="flow_test_date" name="flow_test_date">
                </div>
                <div class="form-field">
                    <label for="witnessed_by">Witnessed By:</label>
                    <input type="text" id="witnessed_by" name="witnessed_by" placeholder="Name">
                </div>
            </div>

            <button type="button" id="calculate-hydrant-btn" class="calc-btn">Calculate Hydrant Flow</button>

            <div id="hydrant-result" class="result-box" style="display:none">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
                    <div>
                        <div class="result-label">Total Gallons Flowing (Q)</div>
                        <div class="result-value" id="result-q">0 GPM</div>
                        <div style="color:#94a3b8;font-size:0.8rem">Q = 29.83 √ó C √ó d¬≤ √ó ‚àöp √ó n</div>
                    </div>
                    <div>
                        <div class="result-label">Available Fire Flow (AFF)</div>
                        <div class="result-value" id="result-aff">0 GPM</div>
                        <div style="color:#94a3b8;font-size:0.8rem">At 20 PSI residual pressure</div>
                    </div>
                    <div>
                        <div class="result-label">Pressure Drop</div>
                        <div class="result-value" id="result-drop">0 PSI</div>
                        <div style="color:#94a3b8;font-size:0.8rem">Static - Residual</div>
                    </div>
                </div>
                <div id="hydrant-breakdown" style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.2);font-size:0.85rem;color:#cbd5e1"></div>
            </div>
        </div>

        <!-- Tab 3: Hydrant Database Upload -->
        <div id="hydrant-data" class="tab-content">
            <h4>üìä Hydrant Flow Test Database</h4>
            <div class="info-tip">
                Upload your hydrant flow test Excel file (.xlsx) to auto-populate nearby hydrant data based on GPS coordinates. 
                Enter the business address GPS to find the closest tested hydrants.
            </div>
            
            <div style="display:flex;flex-wrap:wrap;gap:12px;margin:12px 0;padding:12px;background:#f8fafc;border-radius:8px">
                <strong style="margin-right:8px">Hydrant Color Legend:</strong>
                <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:16px;height:16px;background:#3b82f6;border-radius:4px"></span> Blue: 1000+ GPM</span>
                <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:16px;height:16px;background:#22c55e;border-radius:4px"></span> Green: 500-999 GPM</span>
                <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:16px;height:16px;background:#f97316;border-radius:4px"></span> Orange: &lt;500 GPM</span>
                <span style="display:inline-flex;align-items:center;gap:4px"><span style="width:16px;height:16px;background:#ef4444;border-radius:4px"></span> Red: Out of Service</span>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label for="business_address">Business Address:</label>
                    <input type="text" id="business_address" name="business_address" placeholder="Enter address" style="flex:1">
                </div>
                <div class="form-field">
                    <label for="business_gps">Business GPS Coordinates:</label>
                    <div class="gps-input">
                        <input type="text" id="business_gps" name="business_gps" placeholder="32.6234, -83.6865">
                        <button type="button" class="locate-btn" id="get-business-location-btn">üìç Get GPS</button>
                    </div>
                </div>
            </div>

            <div class="file-drop" id="file-drop">
                <div style="font-size:2rem;margin-bottom:8px">üìÅ</div>
                <strong>Drop Hydrant Flow Test Excel File Here</strong>
                <p style="color:#64748b;margin-top:8px">or click to browse (.xlsx format)</p>
                <input type="file" id="hydrant-file-input" accept=".xlsx,.xls" style="display:none">
            </div>

            <div id="upload-status" style="display:none;margin:12px 0"></div>

            <button type="button" id="find-hydrants-btn" class="calc-btn" style="display:none">üîç Find Nearest Hydrants</button>

            <div id="matched-hydrants" class="matched-hydrants" style="display:none">
                <h5 style="color:#1e3a5f;margin-bottom:12px">üìç Nearest Hydrants to Business Location</h5>
                <div id="hydrant-matches"></div>
            </div>

            <h5 style="margin-top:24px;color:#1e3a5f">Hydrant Flow Test Records</h5>
            <button type="button" id="add-hydrant-row-btn" class="add-row-btn">+ Add Hydrant</button>
            
            <div style="overflow-x:auto;margin-top:12px">
                <table class="hydrant-table" id="hydrant-flow-table">
                    <thead>
                        <tr>
                            <th style="width:180px">Location</th>
                            <th style="width:100px">GPS</th>
                            <th style="width:50px">Static</th>
                            <th style="width:50px">Residual</th>
                            <th style="width:50px">Pitot</th>
                            <th style="width:70px">Q (GPM)</th>
                            <th style="width:70px">AFF (GPM)</th>
                            <th style="width:60px">Color</th>
                            <th style="width:70px">Distance</th>
                            <th style="width:40px"></th>
                        </tr>
                    </thead>
                    <tbody id="hydrant-table-body">
                        <tr data-row="1">
                            <td><input type="text" name="hyd_loc_1" placeholder="Hydrant location"></td>
                            <td><input type="text" name="hyd_gps_1" placeholder="lat, lng" class="hyd-gps"></td>
                            <td><input type="number" name="hyd_static_1" class="hyd-calc" data-row="1"></td>
                            <td><input type="number" name="hyd_res_1" class="hyd-calc" data-row="1"></td>
                            <td><input type="number" name="hyd_pitot_1" class="hyd-calc" data-row="1"></td>
                            <td><input type="number" name="hyd_q_1" readonly></td>
                            <td><input type="number" name="hyd_aff_1" readonly></td>
                            <td><select name="hyd_color_1" style="padding:2px"><option value="">‚Äî</option><option value="Blue">Blue</option><option value="Green">Green</option><option value="Orange">Orange</option><option value="Red">Red</option></select></td>
                            <td><input type="text" name="hyd_dist_1" readonly placeholder="‚Äî"></td>
                            <td><button type="button" class="del-row-btn" data-row="1" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">√ó</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Building/Area Fire Flow Details -->
        <div class="preplan-section" style="margin-top:24px">
            <h4 style="color:var(--navy-blue)">üìê Building / Area Fire Flow Details</h4>
            <div class="info-tip">
                Each row calculates NFF using: <strong>NFF = 18 √ó F √ó ‚àöA √ó O √ó [1 + (X+P)]</strong>
            </div>
            <button type="button" id="add-building-row-btn" class="add-row-btn">+ Add Building/Area</button>
            
            <div style="overflow-x:auto;margin-top:12px">
                <table class="hydrant-table" id="building-flow-table">
                    <thead>
                        <tr>
                            <th style="width:150px">Building/Area</th>
                            <th style="width:70px">Length (ft)</th>
                            <th style="width:70px">Width (ft)</th>
                            <th style="width:50px">Stories</th>
                            <th style="width:90px">Eff. Area (A)</th>
                            <th style="width:90px">Const. Class (F)</th>
                            <th style="width:90px">Occupancy (O)</th>
                            <th style="width:60px">X+P</th>
                            <th style="width:80px">NFF (GPM)</th>
                            <th style="width:40px"></th>
                        </tr>
                    </thead>
                    <tbody id="building-table-body">
                        <tr data-row="1">
                            <td><input type="text" name="bld_name_1" placeholder="Main Building"></td>
                            <td><input type="number" name="bld_len_1" class="bld-calc" data-row="1"></td>
                            <td><input type="number" name="bld_wid_1" class="bld-calc" data-row="1"></td>
                            <td><input type="number" name="bld_stories_1" class="bld-calc" data-row="1" value="1" min="1"></td>
                            <td><input type="number" name="bld_area_1" class="bld-area" data-row="1"></td>
                            <td>
                                <select name="bld_const_1" class="bld-calc" data-row="1">
                                    <option value="1.5">1-Frame</option>
                                    <option value="1.0">2-Joisted</option>
                                    <option value="0.8">3-NonComb</option>
                                    <option value="0.8">4-MasNC</option>
                                    <option value="0.6">5-ModFR</option>
                                    <option value="0.6">6-FR</option>
                                </select>
                            </td>
                            <td>
                                <select name="bld_occ_1" class="bld-calc" data-row="1">
                                    <option value="0.75">C-1</option>
                                    <option value="0.85">C-2</option>
                                    <option value="1.00" selected>C-3</option>
                                    <option value="1.15">C-4</option>
                                    <option value="1.25">C-5</option>
                                </select>
                            </td>
                            <td><input type="number" name="bld_xp_1" class="bld-calc" data-row="1" value="0" step="0.01" min="0" max="0.60"></td>
                            <td><input type="number" name="bld_nff_1" readonly style="font-weight:bold;color:#c8102e"></td>
                            <td><button type="button" class="del-bld-btn" data-row="1" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">√ó</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <input type="hidden" name="calculated_nff" id="calculated_nff">
        <input type="hidden" name="hydrant_data_json" id="hydrant_data_json">

        <div class="form-actions">
            <button type="button" id="prev-btn" class="btn-secondary">‚Üê Previous</button>
            <button type="button" id="next-btn" class="btn-primary">Next ‚Üí Hazardous Materials</button>
        </div>
    </form>
</div>

<footer><img src="images/city-logo.png" alt="City of Centerville Logo" class="city-logo"><p>¬© 2026 City of Centerville Fire Department</p></footer>
</div>

<div id="toast-container" class="toast-container"></div>

<script>
const form=document.getElementById('fire-flow-form');
let hydrantData=[],hydRowCount=1,bldRowCount=1;

function toast(m,t='info'){const c=document.getElementById('toast-container'),e=document.createElement('div');e.className='toast '+t;e.innerHTML='<span>'+m+'</span>';c.appendChild(e);setTimeout(()=>{e.style.opacity='0';setTimeout(()=>e.remove(),300)},3000)}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
    };
});

// ISO NFF Calculator
document.getElementById('calculate-nff-btn').onclick=()=>{
    const F=parseFloat(document.getElementById('construction_class').value);
    const A=parseFloat(document.getElementById('effective_area').value);
    const O=parseFloat(document.getElementById('occupancy_factor').value);
    const X=parseFloat(document.getElementById('exposure_factor').value)||0;
    const P=parseFloat(document.getElementById('comm_factor').value)||0;
    const sprinklered=document.getElementById('sprinkler_credit').checked;
    const woodShingle=document.getElementById('wood_shingle').checked;

    if(isNaN(A)||A<=0){toast('Enter valid Effective Area','error');return}

    // C = 18 √ó F √ó ‚àöA
    let C=18*F*Math.sqrt(A);
    
    // Round C to nearest 250
    C=Math.round(C/250)*250;
    
    // Apply C limits based on construction class
    const maxC=(F>=1.0)?8000:6000; // Class 1,2 max 8000, Class 3-6 max 6000
    C=Math.max(500,Math.min(maxC,C));

    // Limit X+P to 0.60
    const XP=Math.min(0.60,X+P);

    // NFF = C √ó O √ó [1 + (X+P)]
    let NFF=C*O*(1+XP);

    // Wood shingle roof adds 500 GPM
    if(woodShingle)NFF+=500;

    // Round NFF
    if(NFF<2500)NFF=Math.round(NFF/250)*250;
    else NFF=Math.round(NFF/500)*500;

    // Apply limits
    NFF=Math.max(500,Math.min(12000,NFF));

    // Duration based on NFF
    let duration='2 hrs';
    if(NFF<=2500)duration='2 hrs';
    else if(NFF<=3500)duration='3 hrs';
    else duration='4 hrs';

    // If sprinklered, note that NFF = sprinkler demand + hose stream
    let sprinklerNote='';
    if(sprinklered){
        sprinklerNote='<br><span style="color:#fbbf24">‚ö†Ô∏è Sprinklered: Use sprinkler system demand + hose stream allowance per NFPA 13</span>';
    }

    // Display results
    document.getElementById('nff-result').style.display='block';
    document.getElementById('result-c').textContent=C.toLocaleString()+' GPM';
    document.getElementById('result-nff').textContent=NFF.toLocaleString()+' GPM';
    document.getElementById('result-duration').textContent=duration;
    document.getElementById('calc-breakdown').innerHTML=`
        <strong>Calculation Breakdown:</strong><br>
        C = 18 √ó ${F} √ó ‚àö${A.toLocaleString()} = ${(18*F*Math.sqrt(A)).toFixed(0)} ‚Üí rounded to ${C.toLocaleString()} GPM<br>
        NFF = ${C.toLocaleString()} √ó ${O} √ó [1 + ${XP.toFixed(2)}] = ${(C*O*(1+XP)).toFixed(0)} GPM<br>
        ${woodShingle?'Wood Shingle Roof: +500 GPM<br>':''}
        Final NFF (rounded): <strong>${NFF.toLocaleString()} GPM</strong> for ${duration}${sprinklerNote}
    `;

    document.getElementById('calculated_nff').value=NFF;
    saveData();
    toast('NFF calculated: '+NFF.toLocaleString()+' GPM','success');
};

// Update C factor preview
['construction_class','effective_area'].forEach(id=>{
    document.getElementById(id).addEventListener('input',()=>{
        const F=parseFloat(document.getElementById('construction_class').value);
        const A=parseFloat(document.getElementById('effective_area').value);
        if(!isNaN(A)&&A>0){
            let C=18*F*Math.sqrt(A);
            C=Math.round(C/250)*250;
            const maxC=(F>=1.0)?8000:6000;
            C=Math.max(500,Math.min(maxC,C));
            document.getElementById('c-factor-result').style.display='inline-block';
            document.getElementById('c-factor-value').textContent=C.toLocaleString();
        }
    });
});

// Hydrant Flow Calculator
document.getElementById('calculate-hydrant-btn').onclick=()=>{
    const S=parseFloat(document.getElementById('static_pressure').value);
    const R=parseFloat(document.getElementById('residual_pressure').value);
    const p=parseFloat(document.getElementById('pitot_pressure').value);
    const d=parseFloat(document.getElementById('outlet_diameter').value);
    const n=parseInt(document.getElementById('num_outlets').value);
    const C=parseFloat(document.getElementById('coefficient').value);

    if(isNaN(S)||isNaN(R)||isNaN(p)){toast('Enter all pressure values','error');return}
    if(S<=R){toast('Static must be > Residual','error');return}
    if(R<20){toast('Residual should be ‚â•20 PSI for valid AFF','warning')}

    // Q = 29.83 √ó C √ó d¬≤ √ó ‚àöp √ó n
    const Q=29.83*C*(d*d)*Math.sqrt(p)*n;

    // AFF = Q √ó ((S-20)^0.54 / (S-R)^0.54)
    const AFF=Q*Math.pow((S-20),0.54)/Math.pow((S-R),0.54);

    const drop=S-R;

    document.getElementById('hydrant-result').style.display='block';
    document.getElementById('result-q').textContent=Math.round(Q).toLocaleString()+' GPM';
    document.getElementById('result-aff').textContent=Math.round(AFF).toLocaleString()+' GPM';
    document.getElementById('result-drop').textContent=drop+' PSI';
    document.getElementById('hydrant-breakdown').innerHTML=`
        <strong>Calculation:</strong><br>
        Q = 29.83 √ó ${C} √ó ${d}¬≤ √ó ‚àö${p} √ó ${n} = <strong>${Math.round(Q).toLocaleString()} GPM</strong><br>
        AFF = ${Math.round(Q).toLocaleString()} √ó ((${S}-20)<sup>0.54</sup> / (${S}-${R})<sup>0.54</sup>) = <strong>${Math.round(AFF).toLocaleString()} GPM</strong> @ 20 PSI residual
    `;
    toast('Flow calculated','success');
};

// GPS Location
function getGPS(inputId){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            document.getElementById(inputId).value=pos.coords.latitude.toFixed(6)+', '+pos.coords.longitude.toFixed(6);
            toast('GPS acquired','success');
        },err=>toast('GPS error: '+err.message,'error'));
    }else toast('Geolocation not supported','error');
}
document.getElementById('get-location-btn').onclick=()=>getGPS('hydrant_gps');
document.getElementById('get-business-location-btn').onclick=()=>getGPS('business_gps');

// File Upload for Hydrant Data
const fileDrop=document.getElementById('file-drop');
const fileInput=document.getElementById('hydrant-file-input');

fileDrop.onclick=()=>fileInput.click();
fileDrop.ondragover=e=>{e.preventDefault();fileDrop.classList.add('dragover')};
fileDrop.ondragleave=()=>fileDrop.classList.remove('dragover');
fileDrop.ondrop=e=>{e.preventDefault();fileDrop.classList.remove('dragover');if(e.dataTransfer.files[0])processExcelFile(e.dataTransfer.files[0])};
fileInput.onchange=e=>{if(e.target.files[0])processExcelFile(e.target.files[0])};

function processExcelFile(file){
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            const data=new Uint8Array(e.target.result);
            const workbook=XLSX.read(data,{type:'array'});
            
            // Try to find the best sheet (Full or Hidden usually has all data)
            let sheetName=workbook.SheetNames[0];
            for(const name of workbook.SheetNames){
                if(name.includes('Full')||name.includes('Hidden')){sheetName=name;break}
            }
            
            const sheet=workbook.Sheets[sheetName];
            const json=XLSX.utils.sheet_to_json(sheet,{header:1});
            
            // Find header row
            let headerRow=0;
            for(let i=0;i<5;i++){
                if(json[i]&&json[i].some(c=>String(c).includes('Hydrant ID'))){headerRow=i;break}
            }
            
            // Map column indices
            const headers=json[headerRow]||[];
            const colMap={};
            headers.forEach((h,i)=>{
                const hl=String(h||'').toLowerCase();
                if(hl.includes('hydrant id'))colMap.id=i;
                if(hl.includes('test location'))colMap.location=i;
                if(hl.includes('latitude')&&!colMap.lat)colMap.lat=i;
                if(hl.includes('longitude')&&!colMap.lng)colMap.lng=i;
                if(hl.includes('static'))colMap.static=i;
                if(hl.includes('residual'))colMap.residual=i;
                if(hl.includes('pitot'))colMap.pitot=i;
                if(hl.includes('color'))colMap.color=i;
                if(hl.includes('last tested'))colMap.tested=i;
                if(hl.includes('year'))colMap.year=i;
                if(hl.includes('make'))colMap.make=i;
                if(hl.includes('main'))colMap.mainSize=i;
                if(hl.includes('outlet')&&hl.includes('size'))colMap.outletSize=i;
                if(hl.includes('coefficient'))colMap.coef=i;
            });
            
            hydrantData=[];
            for(let i=headerRow+1;i<json.length;i++){
                const row=json[i];
                if(!row||!row[colMap.id])continue;
                
                // Parse pitot field: "12 / 12 (1163)" format
                const pitotStr=String(row[colMap.pitot]||'');
                const pitotMatch=pitotStr.match(/(\d+)\s*\/\s*(\d+)\s*\((\d+)\)/);
                const pitot1=pitotMatch?parseInt(pitotMatch[1]):0;
                const pitot2=pitotMatch?parseInt(pitotMatch[2]):0;
                const qFromData=pitotMatch?parseInt(pitotMatch[3]):0;
                
                // Parse static/residual which might have "60 / 54" format
                let staticP=row[colMap.static];
                let residualP=row[colMap.residual];
                if(typeof staticP==='string'&&staticP.includes('/')){
                    const parts=staticP.split('/').map(s=>parseInt(s.trim()));
                    staticP=parts[0];
                }
                if(typeof residualP==='string'&&residualP.includes('/')){
                    const parts=residualP.split('/').map(s=>parseInt(s.trim()));
                    residualP=parts[0];
                }
                
                const lat=parseFloat(row[colMap.lat]);
                const lng=parseFloat(row[colMap.lng]);
                
                if(isNaN(lat)||isNaN(lng))continue;
                
                // Calculate AFF using Hazen-Williams if we have data
                const S=parseInt(staticP)||0;
                const R=parseInt(residualP)||0;
                const Q=qFromData||0;
                let AFF=0;
                if(S>20&&R>0&&S>R&&Q>0){
                    AFF=Q*Math.pow((S-20),0.54)/Math.pow((S-R),0.54);
                }
                
                hydrantData.push({
                    id:row[colMap.id],
                    location:String(row[colMap.location]||'').replace(/\n/g,' '),
                    lat:lat,
                    lng:lng,
                    static:S,
                    residual:R,
                    pitot:pitot1||pitot2,
                    q:Q,
                    aff:Math.round(AFF),
                    color:row[colMap.color]||'',
                    lastTested:row[colMap.tested]||'',
                    year:row[colMap.year]||'',
                    make:row[colMap.make]||'',
                    mainSize:row[colMap.mainSize]||'',
                    outletSize:row[colMap.outletSize]||2.5,
                    coefficient:row[colMap.coef]||0.9
                });
            }
            
            document.getElementById('upload-status').style.display='block';
            document.getElementById('upload-status').innerHTML=`
                <div style="background:#dcfce7;padding:12px;border-radius:8px;color:#166534">
                    ‚úÖ Loaded <strong>${hydrantData.length}</strong> hydrants from "${sheetName}"<br>
                    <span style="font-size:0.85rem;color:#15803d">GPS coordinates found for all hydrants</span>
                </div>`;
            document.getElementById('find-hydrants-btn').style.display='inline-block';
            document.getElementById('hydrant_data_json').value=JSON.stringify(hydrantData);
            saveData();
            toast('Loaded '+hydrantData.length+' hydrant records','success');
        }catch(err){
            toast('Error reading file: '+err.message,'error');
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(file);
}

// Find nearest hydrants
document.getElementById('find-hydrants-btn').onclick=()=>{
    const gpsStr=document.getElementById('business_gps').value;
    if(!gpsStr){toast('Enter business GPS coordinates','error');return}
    
    const parts=gpsStr.split(',').map(s=>parseFloat(s.trim()));
    if(parts.length!==2||isNaN(parts[0])||isNaN(parts[1])){toast('Invalid GPS format','error');return}
    
    const bizLat=parts[0],bizLng=parts[1];
    
    // Calculate distances
    const withDist=hydrantData.filter(h=>h.lat&&h.lng).map(h=>{
        const dist=haversine(bizLat,bizLng,h.lat,h.lng);
        return {...h,distance:dist};
    }).sort((a,b)=>a.distance-b.distance);
    
    if(withDist.length===0){toast('No hydrants with GPS data found','warning');return}
    
    // Show top 5 nearest
    const nearest=withDist.slice(0,5);
    document.getElementById('matched-hydrants').style.display='block';
    document.getElementById('hydrant-matches').innerHTML=nearest.map((h,i)=>{
        const colorClass=h.color==='Blue'?'background:#dbeafe;border-color:#3b82f6':
                         h.color==='Green'?'background:#dcfce7;border-color:#22c55e':
                         h.color==='Orange'?'background:#ffedd5;border-color:#f97316':
                         'background:#f0fdf4;border-color:#86efac';
        const colorBadge=h.color?`<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:bold;color:white;background:${h.color==='Blue'?'#3b82f6':h.color==='Green'?'#22c55e':h.color==='Orange'?'#f97316':'#9ca3af'}">${h.color}</span>`:'';
        return `
        <div class="matched-hydrant-card" style="${colorClass}">
            <h5>#${h.id} - ${h.location} ${colorBadge}</h5>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;font-size:0.85rem">
                <div><strong>Distance:</strong> <span class="distance">${h.distance.toFixed(0)} ft</span></div>
                <div><strong>Static:</strong> ${h.static||'‚Äî'} PSI</div>
                <div><strong>Residual:</strong> ${h.residual||'‚Äî'} PSI</div>
                <div><strong>Pitot:</strong> ${h.pitot||'‚Äî'} PSI</div>
                <div><strong>Q:</strong> ${h.q?h.q.toLocaleString():'‚Äî'} GPM</div>
                <div><strong>AFF:</strong> ${h.aff?h.aff.toLocaleString():'‚Äî'} GPM</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;font-size:0.8rem;margin-top:8px;color:#475569">
                <div><strong>Main:</strong> ${h.mainSize||'‚Äî'}"</div>
                <div><strong>Make:</strong> ${h.make||'‚Äî'}</div>
                <div><strong>Year:</strong> ${h.year||'‚Äî'}</div>
                <div><strong>Tested:</strong> ${h.lastTested?new Date(h.lastTested).toLocaleDateString():'‚Äî'}</div>
            </div>
            <button type="button" class="add-row-btn" style="margin-top:8px" onclick="addHydrantFromMatch(${i})">+ Add to Table</button>
        </div>
    `}).join('');
    
    toast('Found '+nearest.length+' nearby hydrants','success');
};

function haversine(lat1,lon1,lat2,lon2){
    const R=20902231; // Earth radius in feet
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

window.addHydrantFromMatch=function(idx){
    const gpsStr=document.getElementById('business_gps').value;
    const parts=gpsStr.split(',').map(s=>parseFloat(s.trim()));
    const bizLat=parts[0],bizLng=parts[1];
    
    const withDist=hydrantData.filter(h=>h.lat&&h.lng).map(h=>({...h,distance:haversine(bizLat,bizLng,h.lat,h.lng)})).sort((a,b)=>a.distance-b.distance);
    const h=withDist[idx];
    if(!h)return;
    
    addHydrantRow();
    const row=hydRowCount;
    form.elements['hyd_loc_'+row].value=`#${h.id} - ${h.location}`;
    form.elements['hyd_gps_'+row].value=h.lat+', '+h.lng;
    form.elements['hyd_static_'+row].value=h.static||'';
    form.elements['hyd_res_'+row].value=h.residual||'';
    form.elements['hyd_pitot_'+row].value=h.pitot||'';
    form.elements['hyd_q_'+row].value=h.q||'';
    form.elements['hyd_aff_'+row].value=h.aff||'';
    if(h.color)form.elements['hyd_color_'+row].value=h.color;
    form.elements['hyd_dist_'+row].value=h.distance.toFixed(0)+' ft';
    
    const rowEl=document.querySelector(`tr[data-row="${row}"]`);
    rowEl.classList.add('hydrant-match');
    // Color code the row based on hydrant color
    if(h.color==='Blue')rowEl.style.background='#dbeafe';
    else if(h.color==='Green')rowEl.style.background='#dcfce7';
    else if(h.color==='Orange')rowEl.style.background='#ffedd5';
    else if(h.color==='Red')rowEl.style.background='#fee2e2';
    
    toast(`Added Hydrant #${h.id} (${h.color||'Unknown'} - ${h.q||0} GPM)`,'success');
    saveData();
};

// Hydrant table row management
function addHydrantRow(){
    hydRowCount++;
    const row=document.createElement('tr');
    row.dataset.row=hydRowCount;
    row.innerHTML=`
        <td><input type="text" name="hyd_loc_${hydRowCount}" placeholder="Hydrant location"></td>
        <td><input type="text" name="hyd_gps_${hydRowCount}" placeholder="lat, lng" class="hyd-gps"></td>
        <td><input type="number" name="hyd_static_${hydRowCount}" class="hyd-calc" data-row="${hydRowCount}"></td>
        <td><input type="number" name="hyd_res_${hydRowCount}" class="hyd-calc" data-row="${hydRowCount}"></td>
        <td><input type="number" name="hyd_pitot_${hydRowCount}" class="hyd-calc" data-row="${hydRowCount}"></td>
        <td><input type="number" name="hyd_q_${hydRowCount}" readonly></td>
        <td><input type="number" name="hyd_aff_${hydRowCount}" readonly></td>
        <td><select name="hyd_color_${hydRowCount}" style="padding:2px"><option value="">‚Äî</option><option value="Blue">Blue</option><option value="Green">Green</option><option value="Orange">Orange</option><option value="Red">Red</option></select></td>
        <td><input type="text" name="hyd_dist_${hydRowCount}" readonly placeholder="‚Äî"></td>
        <td><button type="button" class="del-row-btn" data-row="${hydRowCount}" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">√ó</button></td>
    `;
    document.getElementById('hydrant-table-body').appendChild(row);
    attachHydrantCalcListeners(row);
}
document.getElementById('add-hydrant-row-btn').onclick=addHydrantRow;

function attachHydrantCalcListeners(container){
    container.querySelectorAll('.hyd-calc').forEach(input=>{
        input.addEventListener('input',()=>{
            const row=input.dataset.row;
            const S=parseFloat(form.elements['hyd_static_'+row]?.value)||0;
            const R=parseFloat(form.elements['hyd_res_'+row]?.value)||0;
            const p=parseFloat(form.elements['hyd_pitot_'+row]?.value)||0;
            if(S>0&&R>0&&p>0&&S>R){
                const Q=29.83*0.9*6.25*Math.sqrt(p)*2; // Default: C=0.9, d=2.5, n=2
                const AFF=Q*Math.pow((S-20),0.54)/Math.pow((S-R),0.54);
                form.elements['hyd_q_'+row].value=Math.round(Q);
                form.elements['hyd_aff_'+row].value=Math.round(AFF);
            }
        });
    });
}
attachHydrantCalcListeners(document);

// Building table row management
function addBuildingRow(){
    bldRowCount++;
    const row=document.createElement('tr');
    row.dataset.row=bldRowCount;
    row.innerHTML=`
        <td><input type="text" name="bld_name_${bldRowCount}" placeholder="Building/Area"></td>
        <td><input type="number" name="bld_len_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}"></td>
        <td><input type="number" name="bld_wid_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}"></td>
        <td><input type="number" name="bld_stories_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}" value="1" min="1"></td>
        <td><input type="number" name="bld_area_${bldRowCount}" class="bld-area" data-row="${bldRowCount}"></td>
        <td><select name="bld_const_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}">
            <option value="1.5">1-Frame</option><option value="1.0">2-Joisted</option><option value="0.8">3-NonComb</option>
            <option value="0.8">4-MasNC</option><option value="0.6">5-ModFR</option><option value="0.6">6-FR</option>
        </select></td>
        <td><select name="bld_occ_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}">
            <option value="0.75">C-1</option><option value="0.85">C-2</option><option value="1.00" selected>C-3</option>
            <option value="1.15">C-4</option><option value="1.25">C-5</option>
        </select></td>
        <td><input type="number" name="bld_xp_${bldRowCount}" class="bld-calc" data-row="${bldRowCount}" value="0" step="0.01" min="0" max="0.60"></td>
        <td><input type="number" name="bld_nff_${bldRowCount}" readonly style="font-weight:bold;color:#c8102e"></td>
        <td><button type="button" class="del-bld-btn" data-row="${bldRowCount}" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">√ó</button></td>
    `;
    document.getElementById('building-table-body').appendChild(row);
    attachBuildingCalcListeners(row);
}
document.getElementById('add-building-row-btn').onclick=addBuildingRow;

function attachBuildingCalcListeners(container){
    container.querySelectorAll('.bld-calc, .bld-area').forEach(input=>{
        input.addEventListener('input',()=>calcBuildingNFF(input.dataset.row));
        input.addEventListener('change',()=>calcBuildingNFF(input.dataset.row));
    });
}

function calcBuildingNFF(row){
    const len=parseFloat(form.elements['bld_len_'+row]?.value)||0;
    const wid=parseFloat(form.elements['bld_wid_'+row]?.value)||0;
    const stories=parseInt(form.elements['bld_stories_'+row]?.value)||1;
    const F=parseFloat(form.elements['bld_const_'+row]?.value)||1.0;
    const O=parseFloat(form.elements['bld_occ_'+row]?.value)||1.0;
    const XP=Math.min(0.60,parseFloat(form.elements['bld_xp_'+row]?.value)||0);
    
    // Calculate effective area: largest floor + 50% of other floors (for Class 1-4)
    let A=form.elements['bld_area_'+row]?.value;
    if(!A||A==0){
        const floorArea=len*wid;
        A=floorArea+floorArea*0.5*(stories-1); // Simplified effective area
        if(len>0&&wid>0)form.elements['bld_area_'+row].value=Math.round(A);
    }else{
        A=parseFloat(A);
    }
    
    if(A>0){
        // C = 18 √ó F √ó ‚àöA, rounded to nearest 250
        let C=18*F*Math.sqrt(A);
        C=Math.round(C/250)*250;
        const maxC=(F>=1.0)?8000:6000;
        C=Math.max(500,Math.min(maxC,C));
        
        // NFF = C √ó O √ó [1 + (X+P)]
        let NFF=C*O*(1+XP);
        if(NFF<2500)NFF=Math.round(NFF/250)*250;
        else NFF=Math.round(NFF/500)*500;
        NFF=Math.max(500,Math.min(12000,NFF));
        
        form.elements['bld_nff_'+row].value=NFF;
    }
}
attachBuildingCalcListeners(document);

// Delete row handlers
document.addEventListener('click',e=>{
    if(e.target.classList.contains('del-row-btn')){
        e.target.closest('tr').remove();
        saveData();
    }
    if(e.target.classList.contains('del-bld-btn')){
        e.target.closest('tr').remove();
        saveData();
    }
});

// Save/Load
function getSavedData(){return JSON.parse(localStorage.getItem('preFirePlan')||'{}')}

function saveData(){
    const data={...getSavedData()};
    form.querySelectorAll('input, select, textarea').forEach(el=>{
        if(el.type==='checkbox')data[el.name]=el.checked?el.value:'';
        else if(el.value)data[el.name]=el.value;
    });
    localStorage.setItem('preFirePlan',JSON.stringify(data));
}

window.addEventListener('load',()=>{
    const saved=getSavedData();
    
    // Restore hydrant data JSON
    if(saved.hydrant_data_json){
        try{
            hydrantData=JSON.parse(saved.hydrant_data_json);
            if(hydrantData.length>0){
                document.getElementById('upload-status').style.display='block';
                document.getElementById('upload-status').innerHTML=`<div style="background:#dcfce7;padding:12px;border-radius:8px;color:#166534">‚úÖ ${hydrantData.length} hydrant records loaded from saved data</div>`;
                document.getElementById('find-hydrants-btn').style.display='inline-block';
            }
        }catch(e){}
    }
    
    // Find max row counts
    let maxHydRow=1,maxBldRow=1;
    Object.keys(saved).forEach(key=>{
        let m=key.match(/hyd_\w+_(\d+)/);if(m)maxHydRow=Math.max(maxHydRow,parseInt(m[1]));
        m=key.match(/bld_\w+_(\d+)/);if(m)maxBldRow=Math.max(maxBldRow,parseInt(m[1]));
    });
    
    // Add rows
    for(let i=2;i<=maxHydRow;i++)addHydrantRow();
    for(let i=2;i<=maxBldRow;i++)addBuildingRow();
    
    // Load values
    Object.keys(saved).forEach(key=>{
        const el=form.elements[key];
        if(!el)return;
        if(el.type==='checkbox')el.checked=saved[key]===el.value;
        else el.value=saved[key]||'';
    });
    
    // Recalculate building NFFs
    for(let i=1;i<=maxBldRow;i++)calcBuildingNFF(i);
});

form.addEventListener('input',()=>saveData());
form.addEventListener('change',()=>saveData());

document.getElementById('prev-btn').onclick=()=>{saveData();window.location.href='page7-special-rescue.html'};
document.getElementById('next-btn').onclick=()=>{
    saveData();
    toast('Data saved','success');
    setTimeout(()=>window.location.href='page9-hazardous-materials.html',500);
};
</script>
</body>
</html>
