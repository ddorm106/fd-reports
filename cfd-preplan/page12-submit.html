<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pre-Fire Plan: Review & Submit</title>
<link rel="stylesheet" href="styles-preplan.css">
<style>
.review-section{background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;margin-bottom:12px;overflow:hidden}
.review-section h4{background:#1e3a5f;color:#fff;padding:10px 16px;margin:0;font-size:14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.review-section h4:hover{background:#2c5282}
.review-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1px;padding:8px 12px}
.review-item{padding:6px 8px}
.review-label{font-size:11px;color:#666;text-transform:uppercase;letter-spacing:0.3px}
.review-value{font-size:13px;font-weight:600;color:#1e3a5f;margin-top:1px}
.review-value.empty{color:#ccc;font-weight:400;font-style:italic}
.plan-info-section{background:#fff7ed;border:2px solid #e67e22;border-radius:8px;padding:20px;margin:20px 0}
.plan-info-section h4{color:#e67e22;font-size:16px;margin-bottom:12px}
.plan-info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
.plan-info-grid label{font-size:12px;color:#555;display:block;margin-bottom:3px;font-weight:600}
.plan-info-grid input,.plan-info-grid textarea{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font-size:13px}
.plan-info-grid textarea{min-height:60px;resize:vertical}
.action-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin:24px 0;padding:16px;background:#f0f4f8;border-radius:8px}
.action-btn{padding:12px 28px;border-radius:8px;border:none;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s}
.btn-pdf{background:#c0392b;color:#fff}.btn-pdf:hover{background:#e74c3c}
.btn-submit{background:#27ae60;color:#fff}.btn-submit:hover{background:#2ecc71}
.btn-json{background:#2980b9;color:#fff}.btn-json:hover{background:#3498db}
.btn-import{background:#8e44ad;color:#fff}.btn-import:hover{background:#9b59b6}
.btn-print{background:#e67e22;color:#fff}.btn-print:hover{background:#f39c12}
.stats-bar{display:flex;gap:16px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
.stat-pill{background:#1e3a5f;color:#fff;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:600}
.stat-pill .num{color:#e67e22;font-size:16px;margin-right:4px}
</style>
</head>
<body>
<div class="page-wrapper">
    <div class="container">
        <header class="report-header">
            <div class="header-top">
                <img src="images/cfd-logo.png" alt="Centerville Fire Department" class="patch-logo">
                <div class="header-text"><h1>Centerville Fire Department</h1><h2>Pre-Fire Plan Data Sheet</h2></div>
            </div>
        </header>
        <div class="progress-indicator">Page 12 of 12: Review & Submit</div>
        <div class="progress-bar-container"><div class="progress-bar" style="width:100%"></div></div>

        <h3 class="section-title">12. Review & Submit</h3>
        <div class="info-tip">Review all information below. Click any section header to go back and edit. When ready, generate a PDF or submit your pre-plan.</div>

        <!-- PLAN CONDUCTED BY - lives here on the final page -->
        <div class="plan-info-section">
            <h4>üìã Plan Information</h4>
            <form id="planInfoForm">
                <div class="plan-info-grid">
                    <div>
                        <label for="pre_plan_conducted_by">Pre-Plan Conducted By:</label>
                        <input type="text" id="pre_plan_conducted_by" name="pre_plan_conducted_by" placeholder="Lt. Smith, Engine 1">
                    </div>
                    <div>
                        <label for="plan_date">Date:</label>
                        <input type="date" id="plan_date" name="plan_date">
                    </div>
                    <div>
                        <label for="plan_reviewed_by">Reviewed By:</label>
                        <input type="text" id="plan_reviewed_by" name="plan_reviewed_by" placeholder="Chief Jones">
                    </div>
                    <div style="grid-column:1/-1">
                        <label for="additional_notes">Additional Notes:</label>
                        <textarea id="additional_notes" name="additional_notes" placeholder="Special tactical considerations, mutual aid, staging areas..."></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- STATS -->
        <div class="stats-bar" id="statsBar"></div>

        <!-- REVIEW CONTENT -->
        <div id="reviewContent"></div>

        <!-- ACTION BUTTONS -->
        <div class="action-buttons">
            <button class="action-btn btn-pdf" onclick="generatePDF()" id="pdfBtn">üìÑ Generate PDF Report</button>
            <button class="action-btn btn-submit" onclick="submitPlan()">üì§ Submit Pre-Plan</button>
            <button class="action-btn btn-json" onclick="exportJSON()">üíæ Export JSON</button>
            <a href="/preplan/import" class="action-btn btn-import" style="text-decoration:none">üì• Import from PDF</a>
        </div>

        <div class="nav-buttons">
            <button type="button" class="btn-secondary" onclick="window.location.href='page11-floor-plan.html'">‚Üê Previous</button>
            <a href="preplan-index.html" class="btn-primary" style="text-decoration:none;text-align:center">Back to Overview</a>
        </div>
    </div>
</div>
<footer>
    <img src="images/city-logo.png" alt="City of Centerville" class="city-logo">
    <p>¬© 2026 City of Centerville Fire Department</p>
</footer>
<div class="toast-container" id="toast-container"></div>
<script src="preplan-common.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
// Load plan info form
var planForm=document.getElementById('planInfoForm');
if(planForm){loadFormData(planForm);autoSave(planForm);}

var sections=[
    {title:'1. Location Information',page:'page1-location.html',fields:[
        {k:'pfp_number',l:'Plan #'},{k:'business_name',l:'Business Name'},{k:'address',l:'Address'},{k:'telephone_no',l:'Phone'},
        {k:'tax_id',l:'Tax ID'},{k:'fire_district',l:'Fire District'},{k:'latitude',l:'Latitude'},{k:'longitude',l:'Longitude'},{k:'general_directions',l:'Directions'}]},
    {title:'2. Operating Information',page:'page2-operating.html',fields:[
        {k:'primary_contact',l:'Primary Contact'},{k:'primary_tel',l:'Primary Phone'},{k:'secondary_contact',l:'Secondary Contact'},{k:'secondary_tel',l:'Secondary Phone'},
        {k:'operating_hours',l:'Operating Hours'},{k:'primary_access',l:'Primary Access'},{k:'exterior_access',l:'Exterior Concerns'},{k:'aerial_obstructions',l:'Aerial Obstructions'}]},
    {title:'3. Occupancy & Life Safety',page:'page3-occupancy.html',fields:[
        {k:'occupancy_types',l:'Occupancy Types'},{k:'hazard_contents',l:'Hazardous Contents'},{k:'high_fire_load',l:'High Fire Load'},{k:'life_safety_concerns',l:'Life Safety'},
        {k:'evac_plan',l:'Evac Plan'},{k:'occupant_load_day',l:'Occ Load (Day)'},{k:'occupant_load_night',l:'Occ Load (Night)'}]},
    {title:'4. Construction',page:'page4-construction.html',fields:[
        {k:'construction_type',l:'Construction Type'},{k:'length',l:'Length'},{k:'width',l:'Width'},{k:'height',l:'Height'},
        {k:'total_sq_ft',l:'Total Sq Ft'},{k:'num_stories',l:'Stories'},{k:'roof_construction',l:'Roof'},{k:'floor_construction',l:'Floor'},{k:'wall_construction',l:'Walls'},{k:'roof_trusses',l:'Trusses'}]},
    {title:'5. Fire Protection',page:'page5-fire-protection.html',fields:[
        {k:'sprinklered',l:'Sprinklered'},{k:'sprinkler_type',l:'Sprinkler Type'},{k:'fdc_loc',l:'FDC Location'},{k:'standpipe',l:'Standpipe'},
        {k:'fire_pumps',l:'Fire Pump'},{k:'fire_alarm',l:'Fire Alarm'},{k:'panel_loc',l:'FACP Location'},{k:'knox_box',l:'Knox Box'}]},
    {title:'6. Utilities',page:'page6-utilities.html',fields:[
        {k:'natural_gas',l:'Natural Gas'},{k:'natural_gas_loc',l:'Gas Location'},{k:'lp_gas',l:'LP Gas'},{k:'electric',l:'Electric'},
        {k:'electric_loc',l:'Electric Location'},{k:'emergency_power',l:'Emergency Power'},{k:'solar_power',l:'Solar'}]},
    {title:'7. Special Rescue',page:'page7-special-rescue.html',fields:[
        {k:'confined_space',l:'Confined Space'},{k:'high_angle',l:'High Angle'},{k:'water_rescue',l:'Water Rescue'},
        {k:'nfpa_health',l:'NFPA Health'},{k:'nfpa_fire',l:'NFPA Fire'},{k:'nfpa_reactivity',l:'NFPA Reactivity'},{k:'nfpa_special',l:'NFPA Special'}]},
    {title:'8. Fire Flow',page:'page8-fire-flow.html',fields:[
        {k:'nff_area',l:'Effective Area'},{k:'nff_result',l:'NFF (GPM)'},{k:'nff_duration',l:'Duration'},{k:'available_supply',l:'Available Supply'}]},
    {title:'9. Hazardous Materials',page:'page9-hazardous-materials.html',fields:[
        {k:'msds_onsite',l:'MSDS On-Site'},{k:'hazmat_notes',l:'Hazmat Notes'}]}
];

function render(){
    var data=getSavedData();

    // Compute duration from NFF result if not already saved
    if(!data.nff_duration && data.nff_result){
        var nff=parseFloat(data.nff_result)||0;
        if(nff>0){
            var dur=nff<=2500?2:(nff<=3500?3:4);
            data.nff_duration=dur+' hours';
        }
    }
    // Format NFF with GPM if just a number
    if(data.nff_result && !isNaN(data.nff_result)){
        data.nff_result=parseFloat(data.nff_result).toLocaleString()+' GPM';
    }
    // Compute available supply (max AFF from hydrant rows) if not already saved
    if(!data.available_supply){
        var maxAff=0;
        for(var i=1;i<=20;i++){
            var a=parseFloat(data['hyd_aff_'+i])||0;
            if(a>maxAff) maxAff=a;
        }
        if(maxAff>0) data.available_supply=Math.round(maxAff)+' GPM';
    }

    var filled=0,total=0;
    var html='';
    sections.forEach(function(s){
        html+='<div class="review-section"><h4 onclick="window.location.href=\''+s.page+'\'">'+s.title+' <span style="font-size:11px;opacity:0.7">‚úèÔ∏è Edit</span></h4><div class="review-grid">';
        s.fields.forEach(function(f){
            var v=data[f.k]||'';
            total++;
            if(v)filled++;
            html+='<div class="review-item"><div class="review-label">'+f.l+'</div><div class="review-value'+(v?'':' empty')+'">'+(esc(v)||'‚Äî')+'</div></div>';
        });
        html+='</div></div>';
    });

    // Add hydrant rows to review
    var hydHtml='';
    for(var i=1;i<=10;i++){
        var loc=data['hyd_loc_'+i];
        if(loc){
            hydHtml+='<div class="review-item"><div class="review-label">Hydrant '+i+'</div><div class="review-value">'+esc(loc)+' ('+
                (data['hyd_flow_'+i]||'‚Äî')+' GPM, '+(data['hyd_dist_'+i]||'‚Äî')+')</div></div>';
        }
    }
    if(hydHtml){
        html+='<div class="review-section"><h4 onclick="window.location.href=\'page8-fire-flow.html\'">Hydrant Data <span style="font-size:11px;opacity:0.7">‚úèÔ∏è Edit</span></h4><div class="review-grid">'+hydHtml+'</div></div>';
    }

    document.getElementById('reviewContent').innerHTML=html;
    document.getElementById('statsBar').innerHTML=
        '<div class="stat-pill"><span class="num">'+filled+'</span>/ '+total+' fields completed</div>'+
        '<div class="stat-pill"><span class="num">'+(data.business_name||'‚Äî')+'</span></div>';
}

function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=s;return d.innerHTML}

// ===== PDF GENERATION (jsPDF) =====
function enrichData(data){
    if(!data.nff_duration && data.nff_result){
        var nff=parseFloat(data.nff_result)||0;
        if(nff>0) data.nff_duration=(nff<=2500?2:(nff<=3500?3:4))+' hours';
    }
    if(data.nff_result && !isNaN(data.nff_result)){
        data.nff_result=parseFloat(data.nff_result).toLocaleString()+' GPM';
    }
    if(!data.available_supply){
        var maxAff=0;
        for(var i=1;i<=20;i++){var a=parseFloat(data['hyd_aff_'+i])||0;if(a>maxAff)maxAff=a;}
        if(maxAff>0) data.available_supply=Math.round(maxAff)+' GPM';
    }
    return data;
}

function buildPDFDoc(data){
    var jsPDF=window.jspdf.jsPDF;
    var doc=new jsPDF({orientation:'portrait',unit:'mm',format:'letter'});
    var W=215.9,H=279.4,M=15,pw=W-2*M,y=M;

    function checkPage(need){if(y+need>H-M){doc.addPage();y=M;return true}return false}
    function sectionHeader(text){
        checkPage(14);doc.setFillColor(30,58,95);doc.rect(M,y,pw,8,'F');
        doc.setTextColor(255);doc.setFontSize(11);doc.setFont('helvetica','bold');
        doc.text(text,M+3,y+5.5);doc.setTextColor(0);y+=10;
    }
    function fieldRow(label,value,opts){
        if(!value)return;opts=opts||{};checkPage(7);
        doc.setFontSize(9);doc.setFont('helvetica','normal');doc.setTextColor(100);
        doc.text(label,M+2,y+4);doc.setTextColor(0);
        if(opts.bold)doc.setFont('helvetica','bold');
        if(opts.color)doc.setTextColor(opts.color[0],opts.color[1],opts.color[2]);
        var lines=doc.splitTextToSize(String(value),pw-60);
        doc.text(lines,M+55,y+4);doc.setFont('helvetica','normal');doc.setTextColor(0);
        y+=Math.max(1,lines.length)*4.5+2;
        doc.setDrawColor(220);doc.line(M+2,y,M+pw-2,y);y+=1;
    }
    function bigField(label,value,color){
        if(!value)return;checkPage(10);
        doc.setFontSize(9);doc.setTextColor(100);doc.text(label,M+2,y+4);
        doc.setFontSize(16);doc.setFont('helvetica','bold');
        doc.setTextColor(color?color[0]:192,color?color[1]:57,color?color[2]:43);
        doc.text(String(value),M+55,y+5);doc.setFont('helvetica','normal');doc.setTextColor(0);y+=9;
    }

    // ===== TITLE =====
    doc.setFillColor(30,58,95);doc.rect(0,0,W,40,'F');
    doc.setTextColor(255);doc.setFontSize(10);doc.text('CENTERVILLE FIRE DEPARTMENT',M,12);
    doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('PRE-FIRE PLAN',M,22);
    doc.setFontSize(14);doc.setFont('helvetica','normal');doc.text(data.business_name||'',M,31);
    doc.setFontSize(10);if(data.address)doc.text(data.address,M,37);
    if(data.pfp_number){doc.setFontSize(12);doc.setFont('helvetica','bold');doc.text(data.pfp_number,W-M,22,{align:'right'});}
    doc.setTextColor(0);y=46;

    // ===== SECTIONS =====
    sections.forEach(function(s){
        sectionHeader(s.title);
        s.fields.forEach(function(f){fieldRow(f.l,data[f.k]);});
        y+=3;
    });

    // Chemicals
    var hasChem=false;
    for(var ci=1;ci<=10;ci++){if(data['chem_name_'+ci]){hasChem=true;break;}}
    if(hasChem){
        sectionHeader('Chemicals');
        for(var ci=1;ci<=10;ci++){
            if(!data['chem_name_'+ci])continue;
            fieldRow('Chemical '+ci,data['chem_name_'+ci]);
            fieldRow('  Quantity',data['chem_quantity_'+ci]);
            fieldRow('  Location',data['chem_location_'+ci],{color:[230,126,34],bold:true});
        }
        y+=3;
    }

    // Hydrants
    var hasHyd=false;
    for(var i=1;i<=10;i++){if(data['hyd_loc_'+i]){hasHyd=true;break;}}
    if(hasHyd){
        sectionHeader('Hydrant Data');
        for(var i=1;i<=10;i++){
            if(!data['hyd_loc_'+i])continue;
            fieldRow('Hydrant '+i,data['hyd_loc_'+i]);
            fieldRow('  Static PSI',data['hyd_static_'+i]);
            fieldRow('  Residual PSI',data['hyd_res_'+i]);
            fieldRow('  Flow GPM',data['hyd_flow_'+i],{bold:true,color:[52,152,219]});
            fieldRow('  AFF GPM',data['hyd_aff_'+i],{bold:true,color:[39,174,96]});
            fieldRow('  Distance',data['hyd_dist_'+i]);
        }
        y+=3;
    }

    // NFPA Diamond
    if(data.nfpa_health||data.nfpa_fire||data.nfpa_reactivity||data.nfpa_special){
        checkPage(20);doc.setFontSize(8);doc.setTextColor(100);doc.text('NFPA 704 Diamond',M+2,y+3);y+=6;
        var bx=M+20;
        doc.setFillColor(52,152,219);doc.rect(bx,y,18,10,'F');
        doc.setTextColor(255);doc.setFontSize(9);doc.setFont('helvetica','bold');
        doc.text('H:'+(data.nfpa_health||'0'),bx+2,y+7);
        doc.setFillColor(231,76,60);doc.rect(bx+22,y,18,10,'F');doc.text('F:'+(data.nfpa_fire||'0'),bx+24,y+7);
        doc.setFillColor(241,196,15);doc.rect(bx+44,y,18,10,'F');doc.setTextColor(0);doc.text('I:'+(data.nfpa_reactivity||'0'),bx+46,y+7);
        doc.setFillColor(240);doc.rect(bx+66,y,18,10,'F');doc.text('S:'+(data.nfpa_special||'-'),bx+68,y+7);
        doc.setFont('helvetica','normal');doc.setTextColor(0);y+=14;
    }

    // Plan Info
    if(data.pre_plan_conducted_by||data.plan_date||data.plan_reviewed_by){
        checkPage(20);
        doc.setFillColor(255,247,237);doc.setDrawColor(230,126,34);
        doc.roundedRect(M,y,pw,18,2,2,'FD');
        doc.setFontSize(8);doc.setTextColor(230,126,34);doc.setFont('helvetica','bold');
        doc.text('PLAN INFORMATION',M+4,y+5);doc.setFont('helvetica','normal');doc.setTextColor(0);
        doc.setFontSize(9);
        if(data.pre_plan_conducted_by)doc.text('Conducted by: '+data.pre_plan_conducted_by,M+4,y+11);
        if(data.plan_date)doc.text('Date: '+data.plan_date,M+80,y+11);
        if(data.plan_reviewed_by)doc.text('Reviewed by: '+data.plan_reviewed_by,M+4,y+16);
        y+=22;
    }
    if(data.additional_notes){
        checkPage(12);doc.setFontSize(9);doc.setTextColor(60);
        var nl=doc.splitTextToSize(data.additional_notes,pw-4);
        doc.text(nl,M+2,y+4);y+=nl.length*4+4;doc.setTextColor(0);
    }

    // Footer on all pages
    function addFooters(){
        var pages=doc.internal.getNumberOfPages();
        for(var i=1;i<=pages;i++){
            doc.setPage(i);doc.setFontSize(7);doc.setTextColor(150);
            doc.text('Centerville Fire Department Pre-Plan ‚Äî '+(data.business_name||'')+' ‚Äî Generated '+new Date().toLocaleDateString(),M,H-8);
            doc.text('Page '+i+' of '+pages,W-M,H-8,{align:'right'});
        }
    }

    return {doc:doc,addFooters:addFooters,M:M,pw:pw,W:W,H:H};
}

// Render fabric.js canvas JSON to PNG data URL
function renderCanvasToImage(jsonStr,w,h){
    return new Promise(function(resolve){
        try{
            var jsonData;
            if(typeof jsonStr==='string'){try{jsonData=JSON.parse(jsonStr)}catch(e){resolve(null);return}}
            else{jsonData=jsonStr}
            var origW=jsonData.width||w;var origH=jsonData.height||h;
            var el=document.createElement('canvas');el.width=origW;el.height=origH;
            document.body.appendChild(el);
            var fc=new fabric.StaticCanvas(el,{width:origW,height:origH,backgroundColor:'#ffffff'});
            fc.loadFromJSON(jsonData,function(){
                fc.renderAll();
                setTimeout(function(){
                    try{resolve(fc.toDataURL({format:'png',quality:1}))}
                    catch(e){resolve(null)}
                    finally{fc.dispose();if(el.parentNode)el.parentNode.removeChild(el)}
                },300);
            });
        }catch(e){resolve(null)}
    });
}

function addPlanPages(pdfObj,data){
    var planRenders=[];
    if(data.site_plan_data){
        planRenders.push({label:'Site Plan',promise:renderCanvasToImage(data.site_plan_data,900,550)});
    }
    if(data.floor_plan_data){
        var floorAll;
        try{floorAll=typeof data.floor_plan_data==='string'?JSON.parse(data.floor_plan_data):data.floor_plan_data}catch(e){floorAll=null}
        if(floorAll){
            var fkeys=Object.keys(floorAll).sort(function(a,b){return Number(a)-Number(b)});
            fkeys.forEach(function(fk){
                planRenders.push({label:'Floor Plan'+(fkeys.length>1?' - Floor '+fk:''),promise:renderCanvasToImage(floorAll[fk],900,600)});
            });
        }
    }
    if(planRenders.length===0)return Promise.resolve();
    return Promise.all(planRenders.map(function(p){return p.promise})).then(function(images){
        var doc=pdfObj.doc,M=pdfObj.M,pw=pdfObj.pw;
        for(var i=0;i<planRenders.length;i++){
            doc.addPage();var y=M;
            doc.setFillColor(30,58,95);doc.rect(M,y,pw,8,'F');
            doc.setTextColor(255);doc.setFontSize(11);doc.setFont('helvetica','bold');
            doc.text(planRenders[i].label,M+3,y+5.5);doc.setTextColor(0);y+=10;
            if(images[i]){
                var imgW=pw;var imgH=imgW*0.65;
                doc.addImage(images[i],'PNG',M,y,imgW,imgH);
            }else{
                doc.setFontSize(10);doc.setTextColor(150);
                doc.text(planRenders[i].label+' could not be rendered',M+2,y+5);
            }
        }
    });
}

function generatePDF(){
    var btn=document.getElementById('pdfBtn');
    if(btn){btn.disabled=true;btn.textContent='‚è≥ Generating...';}
    var data=enrichData(getSavedData());
    if(!data.business_name){showToast('Fill in the business name first','error');if(btn){btn.disabled=false;btn.textContent='üìÑ Generate PDF Report';}return}

    var pdfObj=buildPDFDoc(data);
    addPlanPages(pdfObj,data).then(function(){
        pdfObj.addFooters();
        pdfObj.doc.save((data.business_name||'preplan').replace(/[^a-zA-Z0-9]/g,'-')+'-preplan.pdf');
        showToast('PDF downloaded!','success');
    }).catch(function(e){
        console.error(e);pdfObj.addFooters();
        pdfObj.doc.save((data.business_name||'preplan').replace(/[^a-zA-Z0-9]/g,'-')+'-preplan.pdf');
    }).finally(function(){
        if(btn){btn.disabled=false;btn.textContent='üìÑ Generate PDF Report';}
    });
}

function submitPlan(){
    saveFormData(planForm);
    var data=getSavedData();
    if(!data.business_name){showToast('Please fill in the business name first','error');return}
    var btn=document.querySelector('.btn-submit');
    if(btn){btn.disabled=true;btn.textContent='‚è≥ Publishing & Emailing...';}

    // Step 1: Publish to book
    fetch('/api/preplans/publish',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:data,published_by:''})})
    .then(function(r){return r.json()})
    .then(function(result){
        if(!result.success){
            showToast('Error publishing: '+(result.error||'Unknown'),'error');
            if(btn){btn.disabled=false;btn.textContent='üì§ Submit Pre-Plan';}
            return;
        }

        showToast('Published to Pre-Plan Book! Generating email...','success');

        // Step 2: Generate PDF and email it
        var enriched=enrichData(JSON.parse(JSON.stringify(data)));
        var pdfObj=buildPDFDoc(enriched);
        addPlanPages(pdfObj,data).then(function(){
            pdfObj.addFooters();
            // Convert to base64
            var pdfBase64=pdfObj.doc.output('datauristring').split(',')[1];
            var filename=(data.business_name||'preplan').replace(/[^a-zA-Z0-9]/g,'-')+'-preplan.pdf';

            // Step 3: Send email via worker
            return fetch('/api/preplans/notify',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    business_name:data.business_name,
                    address:data.address||'',
                    conducted_by:data.pre_plan_conducted_by||'',
                    plan_date:data.plan_date||'',
                    pdf_base64:pdfBase64,
                    pdf_filename:filename
                })
            });
        }).then(function(r){return r.json()})
        .then(function(emailResult){
            if(btn){btn.disabled=false;btn.textContent='üì§ Submit Pre-Plan';}
            var overlay=document.createElement('div');overlay.id='submitOverlay';
            overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999';
            var msg=document.createElement('div');
            msg.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:12px;padding:28px;box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:10000;text-align:center;max-width:420px';
            var emailStatus=emailResult&&emailResult.success?
                '<div style="color:#27ae60;font-size:13px;margin-bottom:12px">üìß PDF emailed to command staff</div>':
                '<div style="color:#e67e22;font-size:12px;margin-bottom:12px">‚ö†Ô∏è Published but email failed ‚Äî PDF can be downloaded from the book</div>';
            msg.innerHTML='<h3 style="margin:0 0 12px;color:#27ae60">‚úÖ Pre-Plan Published!</h3>'+
                '<p style="margin:0 0 8px;color:#555"><strong>'+esc(data.business_name)+'</strong> has been saved to the Pre-Plan Book.</p>'+
                emailStatus+
                '<a href="/book" style="display:inline-block;padding:10px 24px;background:#2980b9;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:8px">üìñ View Pre-Plan Book</a>'+
                '<br><button onclick="this.parentElement.remove();document.getElementById(\'submitOverlay\').remove()" style="margin-top:8px;padding:8px 20px;border:none;border-radius:6px;cursor:pointer;background:#eee">Close</button>';
            overlay.onclick=function(){overlay.remove();msg.remove()};
            document.body.appendChild(overlay);document.body.appendChild(msg);
        }).catch(function(e){
            console.error('Email error:',e);
            if(btn){btn.disabled=false;btn.textContent='üì§ Submit Pre-Plan';}
            showToast('Published but email failed. PDF available in book.','info');
        });
    }).catch(function(){
        if(btn){btn.disabled=false;btn.textContent='üì§ Submit Pre-Plan';}
        showToast('Could not reach server. Data saved locally.','info');
    });
}

function exportJSON(){
    var data=getSavedData();
    var name=(data.business_name||'preplan').replace(/[^a-zA-Z0-9]/g,'-').toLowerCase();
    var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    var a=document.createElement('a');a.download=name+'-preplan-'+new Date().toISOString().slice(0,10)+'.json';
    a.href=URL.createObjectURL(blob);a.click();
    showToast('JSON exported','success');
}

render();
</script>
</body>
</html>
