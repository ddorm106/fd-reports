<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Fire Plan: Review & Submit</title>
    <link rel="stylesheet" href="styles-preplan.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .review-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            background: var(--slate-50);
            margin-bottom: var(--spacing-lg);
        }
        .review-section {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
        }
        .review-section-header {
            background: var(--navy-blue);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            font-family: var(--font-display);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .review-section-header:hover { background: var(--navy-dark); }
        .review-section-body {
            padding: var(--spacing-md);
        }
        .review-section-body.collapsed { display: none; }
        .review-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-xs) 0;
            border-bottom: 1px dashed var(--slate-200);
        }
        .review-item:last-child { border-bottom: none; }
        .review-label {
            font-weight: 600;
            color: var(--slate-600);
            font-size: 0.85rem;
            flex: 1;
        }
        .review-value {
            color: var(--slate-800);
            flex: 1;
            text-align: right;
            word-break: break-word;
        }
        .review-value.empty { color: var(--slate-400); font-style: italic; }
        .edit-link {
            color: var(--fire-red);
            text-decoration: none;
            font-size: 0.8rem;
            margin-left: var(--spacing-sm);
        }
        .edit-link:hover { text-decoration: underline; }
        .completion-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .completion-badge.complete { background: #D1FAE5; color: #065F46; }
        .completion-badge.incomplete { background: #FEE2E2; color: #991B1B; }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .stat-card {
            background: white;
            border: 1px solid var(--slate-200);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--navy-blue);
        }
        .stat-label { color: var(--slate-500); font-size: 0.85rem; }
        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-lg);
        }
        .submit-section {
            background: linear-gradient(135deg, var(--green-500) 0%, var(--green-600) 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            text-align: center;
        }
        .submit-section h3 { margin-bottom: var(--spacing-md); }
        .submit-btn {
            background: white;
            color: var(--green-600);
            border: none;
            padding: var(--spacing-md) var(--spacing-2xl);
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .submit-btn:hover { transform: scale(1.05); box-shadow: var(--shadow-lg); }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="container">
            <header class="report-header">
                <div class="header-top">
                    <img src="images/cfd-logo.png" alt="Centerville Fire Department Logo" class="patch-logo">
                    <div class="header-text">
                        <h1>Centerville Fire Department</h1>
                        <h2>Pre-Fire Plan Data Sheet</h2>
                    </div>
                </div>
            </header>

            <div class="progress-indicator">Page 12 of 12: Review & Submit</div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 100%"></div>
            </div>

            <h3 class="section-title">12. Review & Submit</h3>

            <!-- Summary Stats -->
            <div class="summary-stats" id="summary-stats">
                <div class="stat-card">
                    <div class="stat-value" id="fields-filled">0</div>
                    <div class="stat-label">Fields Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sections-complete">0/11</div>
                    <div class="stat-label">Sections Complete</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="business-name-display">‚Äî</div>
                    <div class="stat-label">Business Name</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn-secondary" id="export-json-btn">üíæ Export JSON</button>
                <button type="button" class="btn-primary" id="export-pdf-btn">üìÑ Generate PDF Report</button>
                <button type="button" class="btn-secondary" id="print-btn">üñ®Ô∏è Print</button>
            </div>

            <!-- Review Container -->
            <div class="review-container" id="review-container">
                <!-- Sections will be populated by JS -->
            </div>

            <!-- Submit Section -->
            <div class="submit-section">
                <h3>Ready to Submit?</h3>
                <p style="margin-bottom: var(--spacing-md);">Once submitted, this pre-fire plan will be saved to the department records.</p>
                <button type="button" class="submit-btn" id="submit-btn">‚úì Submit Pre-Fire Plan</button>
            </div>

            <div class="form-actions">
                <button type="button" id="prev-btn" class="btn-secondary">‚Üê Previous</button>
                <a href="index.html" class="btn-secondary">Back to Overview</a>
            </div>
        </div>

        <footer>
            <img src="images/city-logo.png" alt="City of Centerville Logo" class="city-logo">
            <p>¬© 2026 City of Centerville Fire Department</p>
        </footer>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        const sections = [
            { id: 'location', title: '1. Location Information', page: 'page1-location.html', 
              fields: ['pfp_number', 'business_name', 'address', 'telephone_no', 'map_book_page', 'fire_district', 'latitude', 'longitude', 'general_directions'] },
            { id: 'operating', title: '2. Operating Information', page: 'page2-operating.html',
              fields: ['primary_contact', 'primary_tel', 'secondary_contact', 'secondary_tel', 'operating_hours', 'primary_access', 'exterior_access', 'exterior_door', 'interior_roof', 'aerial_obstructions'] },
            { id: 'occupancy', title: '3. Occupancy', page: 'page3-occupancy.html',
              fields: ['occupancy_types', 'hazard_contents', 'high_fire_load', 'life_safety_concerns', 'evac_plan', 'occupant_load_day', 'occupant_load_night'] },
            { id: 'construction', title: '4. Construction', page: 'page4-construction.html',
              fields: ['construction_type', 'length', 'width', 'height', 'total_sq_ft', 'num_stories', 'roof_construction', 'roof_trusses', 'floor_construction', 'wall_construction'] },
            { id: 'fire-protection', title: '5. Fire Protection', page: 'page5-fire-protection.html',
              fields: ['primary_hydrant', 'fire_pumps', 'sprinklered', 'sprinkler_type', 'fdc_loc', 'standpipe', 'fire_alarm', 'panel_loc'] },
            { id: 'utilities', title: '6. Utilities', page: 'page6-utilities.html',
              fields: ['natural_gas', 'lp_gas', 'electric', 'emergency_power', 'solar_power'] },
            { id: 'special-rescue', title: '7. Special Rescue', page: 'page7-special-rescue.html',
              fields: ['confined_space', 'high_angle', 'water_rescue', 'nfpa_health'] },
            { id: 'fire-flow', title: '8. Fire Flow Data', page: 'page8-fire-flow.html',
              fields: ['effective_area', 'calculated_nff', 'static_pressure', 'residual_pressure', 'flow_gpm'] },
            { id: 'hazmat', title: '9. Hazardous Materials', page: 'page9-hazardous-materials.html',
              fields: ['chem_name_1', 'tier_ii', 'msds_onsite'] },
            { id: 'site-plan', title: '10. Site Plan', page: 'page10-site-plan.html',
              fields: ['site_plan_data'] },
            { id: 'floor-plan', title: '11. Floor Plan', page: 'page11-floor-plan.html',
              fields: ['floor_plan_data'] }
        ];

        const fieldLabels = {
            'pfp_number': 'Pre-Plan #',
            'business_name': 'Business Name',
            'address': 'Address',
            'telephone_no': 'Telephone',
            'map_book_page': 'Map Book Page',
            'fire_district': 'Fire District',
            'latitude': 'Latitude',
            'longitude': 'Longitude',
            'general_directions': 'Directions',
            'primary_contact': 'Primary Contact',
            'primary_tel': 'Primary Tel',
            'secondary_contact': 'Secondary Contact',
            'operating_hours': 'Operating Hours',
            'occupancy_types': 'Occupancy Types',
            'hazard_contents': 'Hazard of Contents',
            'construction_type': 'Construction Type',
            'total_sq_ft': 'Total Sq Ft',
            'num_stories': 'Stories',
            'sprinklered': 'Sprinklered',
            'fire_alarm': 'Fire Alarm',
            'calculated_nff': 'Calculated Fire Flow (GPM)',
            'confined_space': 'Confined Space',
            'date': 'Date'
        };

        function getSavedData() {
            return JSON.parse(localStorage.getItem('preFirePlan') || '{}');
        }

        function formatFieldName(name) {
            return fieldLabels[name] || name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatValue(value) {
            if (Array.isArray(value)) return value.join(', ');
            if (typeof value === 'object') return '[Data]';
            return value;
        }

        function renderReview() {
            const data = getSavedData();
            const container = document.getElementById('review-container');
            let totalFields = 0;
            let filledFields = 0;
            let completeSections = 0;

            container.innerHTML = sections.map(section => {
                const sectionFields = Object.keys(data).filter(key => 
                    section.fields.some(f => key.startsWith(f) || key === f)
                );
                const hasSomeData = sectionFields.length > 0;
                if (hasSomeData) completeSections++;

                // Count fields
                section.fields.forEach(f => {
                    totalFields++;
                    if (data[f] && data[f].toString().trim()) filledFields++;
                });

                return `
                    <div class="review-section">
                        <div class="review-section-header" onclick="toggleSection(this)">
                            <span>${section.title}</span>
                            <span>
                                <span class="completion-badge ${hasSomeData ? 'complete' : 'incomplete'}">
                                    ${hasSomeData ? '‚úì Has Data' : '‚óã Empty'}
                                </span>
                                <a href="${section.page}" class="edit-link" onclick="event.stopPropagation()">Edit</a>
                            </span>
                        </div>
                        <div class="review-section-body">
                            ${section.fields.map(field => {
                                const value = data[field];
                                const displayValue = value ? formatValue(value) : '';
                                return `
                                    <div class="review-item">
                                        <span class="review-label">${formatFieldName(field)}</span>
                                        <span class="review-value ${!displayValue ? 'empty' : ''}">${displayValue || 'Not provided'}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Update stats
            document.getElementById('fields-filled').textContent = filledFields;
            document.getElementById('sections-complete').textContent = `${completeSections}/11`;
            document.getElementById('business-name-display').textContent = data.business_name || '‚Äî';
        }

        function toggleSection(header) {
            const body = header.nextElementSibling;
            body.classList.toggle('collapsed');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // Export JSON
        document.getElementById('export-json-btn').addEventListener('click', () => {
            const data = getSavedData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.download = `prefire-plan-${data.business_name || 'export'}-${new Date().toISOString().split('T')[0]}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
            showToast('JSON exported', 'success');
        });

        // Export PDF
        document.getElementById('export-pdf-btn').addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = getSavedData();
            
            let y = 20;
            const lineHeight = 7;
            const pageHeight = 280;
            const margin = 20;

            // Title
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('CENTERVILLE FIRE DEPARTMENT', 105, y, { align: 'center' });
            y += 8;
            doc.setFontSize(14);
            doc.text('Pre-Fire Plan Report', 105, y, { align: 'center' });
            y += 10;

            // Business info
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`Business: ${data.business_name || 'N/A'}`, margin, y);
            y += lineHeight;
            doc.setFont('helvetica', 'normal');
            doc.text(`Address: ${data.address || 'N/A'}`, margin, y);
            y += lineHeight;
            doc.text(`Pre-Plan #: ${data.pfp_number || 'N/A'}    Date: ${data.date || 'N/A'}`, margin, y);
            y += lineHeight * 2;

            // Sections
            sections.forEach(section => {
                if (y > pageHeight - 30) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFont('helvetica', 'bold');
                doc.setFillColor(30, 58, 95);
                doc.rect(margin, y - 4, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(section.title, margin + 2, y + 2);
                doc.setTextColor(0, 0, 0);
                y += lineHeight + 4;

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);

                section.fields.forEach(field => {
                    if (y > pageHeight - 10) {
                        doc.addPage();
                        y = 20;
                    }
                    const value = data[field];
                    if (value && !field.includes('_data')) {
                        const label = formatFieldName(field);
                        const displayValue = formatValue(value);
                        doc.text(`${label}: ${displayValue}`, margin, y);
                        y += lineHeight;
                    }
                });

                y += 5;
            });

            // Footer
            doc.setFontSize(8);
            doc.text(`Generated: ${new Date().toLocaleString()}`, margin, 290);

            doc.save(`prefire-plan-${data.business_name || 'report'}.pdf`);
            showToast('PDF generated', 'success');
        });

        // Print
        document.getElementById('print-btn').addEventListener('click', () => {
            window.print();
        });

        // Submit
        document.getElementById('submit-btn').addEventListener('click', () => {
            const data = getSavedData();
            
            // In a real application, this would POST to a server
            console.log('Submitting Pre-Fire Plan:', data);
            
            // Show success message
            showToast('Pre-Fire Plan submitted successfully!', 'success');
            
            // Optionally clear data after submit
            if (confirm('Pre-Fire Plan submitted! Would you like to start a new plan?')) {
                localStorage.removeItem('preFirePlan');
                window.location.href = 'index.html';
            }
        });

        // Navigation
        document.getElementById('prev-btn').addEventListener('click', () => {
            window.location.href = 'page11-floor-plan.html';
        });

        // Initialize
        window.addEventListener('load', renderReview);
    </script>
</body>
</html>
