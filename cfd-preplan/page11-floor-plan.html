<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Fire Plan: Floor Plan</title>
    <link rel="stylesheet" href="styles-preplan.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        .floor-tabs{display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap}
        .floor-tab{padding:8px 16px;background:#e2e8f0;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-weight:600}
        .floor-tab:hover{background:#cbd5e1}.floor-tab.active{background:#1e3a5f;color:white}
        .add-floor-btn{background:#22c55e;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer}
        .upload-area{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;margin-bottom:20px}
        .upload-area:hover{border-color:#1e3a5f;background:#f8fafc}
        .canvas-wrapper{border:2px solid #cbd5e1;border-radius:12px;overflow:hidden;background:white;margin-bottom:12px}
        .hidden{display:none!important}
        .symbol-dropdown{position:relative;display:inline-block;margin:2px}
        .symbol-dropdown-btn{padding:4px 8px;background:#f59e0b;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:.7rem}
        .symbol-dropdown-content{display:none;position:absolute;background:white;min-width:160px;box-shadow:0 4px 12px rgba(0,0,0,.15);border-radius:8px;z-index:100;max-height:300px;overflow-y:auto}
        .symbol-dropdown:hover .symbol-dropdown-content{display:block}
        .symbol-item{padding:5px 10px;cursor:pointer;font-size:.72rem;border:none;background:none;width:100%;text-align:left;display:block}
        .symbol-item:hover{background:#f1f5f9}
        .symbol-header{padding:4px 8px;background:#e2e8f0;font-weight:600;font-size:.68rem;color:#475569}
        .tool-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:6px}
        .tool-group{display:flex;gap:3px;align-items:center}
        .tool-btn{padding:5px 8px;background:#e2e8f0;border:none;border-radius:6px;cursor:pointer;font-size:.75rem}
        .tool-btn:hover{background:#cbd5e1}.tool-btn.active{background:#c8102e;color:white}
        .control-group{display:flex;align-items:center;gap:3px;padding:3px 6px;background:#e2e8f0;border-radius:6px;font-size:.7rem}
        .control-group input,.control-group select{padding:2px 4px;border:1px solid #cbd5e1;border-radius:4px;font-size:.7rem}
        .control-group input[type="number"]{width:40px}
        .control-group input[type="color"]{width:28px;height:24px;padding:0;border:2px solid #cbd5e1;cursor:pointer}
        .nfpa-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
        .nfpa-modal-content{background:white;padding:24px;border-radius:12px;text-align:center}
        .nfpa-diamond{width:120px;height:120px;position:relative;margin:20px auto}
        .nfpa-quad{position:absolute;width:60px;height:60px;display:flex;align-items:center;justify-content:center}
        .nfpa-quad input{width:30px;height:30px;text-align:center;font-size:18px;font-weight:bold;border:1px solid #ccc;border-radius:4px}
        .nfpa-top{top:0;left:30px;background:#ff0000}.nfpa-left{top:30px;left:0;background:#0000ff}
        .nfpa-right{top:30px;right:0;background:#ffff00}.nfpa-bottom{bottom:0;left:30px;background:white;border:2px solid #333}
        .nfpa-quad input{background:transparent;border:none;color:white}
        .nfpa-bottom input{color:black}
    </style>
</head>
<body>
<div class="page-wrapper">
<div class="container">
    <header class="report-header"><div class="header-top">
        <img src="images/cfd-logo.png" alt="CFD" class="patch-logo">
        <div class="header-text"><h1>Centerville Fire Department</h1><h2>Pre-Fire Plan Data Sheet</h2></div>
    </div></header>
    <div class="progress-indicator">Page 11 of 12: Floor Plan</div>
    <div class="progress-bar-container"><div class="progress-bar" style="width:91.66%"></div></div>
    <h3 class="section-title">11. Floor Plan</h3>
    
    <div class="floor-tabs" id="floor-tabs">
        <button type="button" class="floor-tab active" data-floor="1">Floor 1</button>
        <button type="button" class="add-floor-btn" id="add-floor-btn">+ Add Floor</button>
    </div>
    
    <div id="upload-section">
        <div class="upload-area" id="upload-area">
            <div style="font-size:2.5rem;margin-bottom:12px">üìê</div>
            <h4>Upload Floor Plan Image</h4>
            <p style="color:#64748b">Drag & drop or click to browse</p>
            <input type="file" id="image-upload" accept="image/*" style="display:none">
        </div>
        <div style="text-align:center;margin-top:12px">
            <button type="button" class="btn-secondary" id="blank-canvas-btn">Start with Blank Canvas</button>
        </div>
    </div>
    
    <div id="annotation-section" class="hidden">
        <!-- Tool Row 1 -->
        <div class="tool-row">
            <div class="tool-group">
                <button type="button" class="tool-btn" id="undo-btn" title="Undo">‚Ü©Ô∏è</button>
                <button type="button" class="tool-btn" id="redo-btn" title="Redo">‚Ü™Ô∏è</button>
            </div>
            <div class="tool-group">
                <button type="button" class="tool-btn active" data-tool="select">‚ÜñÔ∏è</button>
                <button type="button" class="tool-btn" data-tool="draw">‚úèÔ∏è</button>
                <button type="button" class="tool-btn" data-tool="text">T</button>
                <button type="button" class="tool-btn" data-tool="line">‚Äî</button>
                <button type="button" class="tool-btn" data-tool="rect">‚ñ¢</button>
                <button type="button" class="tool-btn" data-tool="wall">‚ñ¨ Wall</button>
                <button type="button" class="tool-btn" data-tool="dimension">üìè</button>
            </div>
            <div class="control-group"><label>Color:</label><input type="color" id="stroke-color" value="#1E3A5F"></div>
            <div class="control-group"><label>Wall:</label><input type="number" id="wall-thickness" value="6" min="2" max="24">px</div>
            <div class="control-group">
                <label>Scale:</label>
                <select id="scale-select">
                    <option value="1">1"=1"</option>
                    <option value="12">1"=1'</option>
                    <option value="24" selected>¬Ω"=1'</option>
                    <option value="48">¬º"=1'</option>
                </select>
            </div>
            <div class="control-group">
                <label>Unit:</label>
                <select id="unit-select">
                    <option value="ft">Feet</option>
                    <option value="in">Inches</option>
                </select>
            </div>
            <div class="tool-group">
                <button type="button" class="tool-btn" id="delete-btn">üóëÔ∏è</button>
                <button type="button" class="tool-btn" id="clear-btn">Clear</button>
            </div>
        </div>

        <!-- Tool Row 2 - Symbols -->
        <div class="tool-row">
            <span style="font-weight:600;font-size:.75rem;margin-right:4px">Symbols:</span>
            
            <!-- Fire Protection -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üî• Fire</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="facp">Alarm Panel (FACP)</button>
                <button class="symbol-item" data-symbol="annunciator">Annunciator</button>
                <button class="symbol-item" data-symbol="fdc">FDC</button>
                <button class="symbol-item" data-symbol="sprinkler">Sprinkler Riser</button>
                <button class="symbol-item" data-symbol="standpipe">Standpipe</button>
                <button class="symbol-item" data-symbol="extinguisher">Fire Extinguisher</button>
                <button class="symbol-item" data-symbol="hydrant">Hydrant</button>
                <button class="symbol-item" data-symbol="pull">Pull Station</button>
                <button class="symbol-item" data-symbol="smoke">Smoke Detector</button>
            </div></div>

            <!-- Doors & Windows -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üö™ Doors</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="door-l">Door (Left Swing)</button>
                <button class="symbol-item" data-symbol="door-r">Door (Right Swing)</button>
                <button class="symbol-item" data-symbol="door-d">Double Door</button>
                <button class="symbol-item" data-symbol="door-roll">Rollup/Overhead</button>
                <button class="symbol-item" data-symbol="door-slide">Sliding Door</button>
                <button class="symbol-item" data-symbol="door-rev">Revolving Door</button>
                <button class="symbol-item" data-symbol="win-3">Window 3'</button>
                <button class="symbol-item" data-symbol="win-4">Window 4'</button>
                <button class="symbol-item" data-symbol="win-6">Window 6'</button>
                <button class="symbol-item" data-symbol="exit">EXIT Sign</button>
            </div></div>

            <!-- Access -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">ü™ú Access</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="stairs">Stairs (Up)</button>
                <button class="symbol-item" data-symbol="stairs-dn">Stairs (Down)</button>
                <button class="symbol-item" data-symbol="elevator">Elevator</button>
                <button class="symbol-item" data-symbol="escalator">Escalator</button>
                <button class="symbol-item" data-symbol="knox">Knox Box</button>
                <button class="symbol-item" data-symbol="roof">Roof Access</button>
            </div></div>

            <!-- Utilities -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö° Util</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="elec">Electrical Panel</button>
                <button class="symbol-item" data-symbol="elec-off">Elec Shutoff</button>
                <button class="symbol-item" data-symbol="gas-meter">Gas Meter</button>
                <button class="symbol-item" data-symbol="gas-off">Gas Shutoff</button>
                <button class="symbol-item" data-symbol="water-off">Water Shutoff</button>
                <button class="symbol-item" data-symbol="hvac">HVAC Unit</button>
                <button class="symbol-item" data-symbol="gen">Generator</button>
                <button class="symbol-item" data-symbol="solar">Solar Disconnect</button>
            </div></div>

            <!-- Hazmat -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ò¢Ô∏è Hazmat</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="nfpa704">NFPA 704 Placard</button>
                <button class="symbol-item" data-symbol="hazmat">Hazmat Storage</button>
                <button class="symbol-item" data-symbol="flammable">Flammable Storage</button>
                <button class="symbol-item" data-symbol="propane">Propane Tank</button>
                <button class="symbol-item" data-symbol="fuel">Fuel Tank</button>
                <button class="symbol-item" data-symbol="chemical">Chemical Storage</button>
            </div></div>

            <!-- Compass -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üß≠ Compass</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="compass">Compass Rose</button>
                <button class="symbol-item" data-symbol="north">North Arrow</button>
                <button class="symbol-item" data-symbol="north-simple">Simple N</button>
            </div></div>

            <!-- Vehicles -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üöó Vehicles</button><div class="symbol-dropdown-content">
                <div class="symbol-header">EMERGENCY</div>
                <button class="symbol-item" data-symbol="v-engine">Fire Engine</button>
                <button class="symbol-item" data-symbol="v-ladder">Ladder Truck</button>
                <button class="symbol-item" data-symbol="v-rescue">Rescue Squad</button>
                <button class="symbol-item" data-symbol="v-amb">Ambulance</button>
                <button class="symbol-item" data-symbol="v-bc">Battalion Chief</button>
                <button class="symbol-item" data-symbol="v-police">Police</button>
                <div class="symbol-header">CIVILIAN</div>
                <button class="symbol-item" data-symbol="v-car">Car</button>
                <button class="symbol-item" data-symbol="v-suv">SUV</button>
                <button class="symbol-item" data-symbol="v-pickup">Pickup Truck</button>
                <button class="symbol-item" data-symbol="v-van">Van</button>
                <button class="symbol-item" data-symbol="v-semi">Semi Truck</button>
                <button class="symbol-item" data-symbol="v-bus">Bus</button>
                <button class="symbol-item" data-symbol="v-moto">Motorcycle</button>
            </div></div>
        </div>

        <!-- Tool Row 3 - More Symbols -->
        <div class="tool-row">
            <!-- Furniture -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üõãÔ∏è Furniture</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="bed">Bed</button>
                <button class="symbol-item" data-symbol="sofa">Sofa</button>
                <button class="symbol-item" data-symbol="desk">Desk</button>
                <button class="symbol-item" data-symbol="table">Table</button>
                <button class="symbol-item" data-symbol="chair">Chair</button>
                <button class="symbol-item" data-symbol="bookshelf">Bookshelf</button>
                <button class="symbol-item" data-symbol="cabinet">Cabinet</button>
            </div></div>

            <!-- Kitchen/Bath -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üç≥ Kitch/Bath</button><div class="symbol-dropdown-content">
                <div class="symbol-header">KITCHEN</div>
                <button class="symbol-item" data-symbol="fridge">Refrigerator</button>
                <button class="symbol-item" data-symbol="stove">Stove/Range</button>
                <button class="symbol-item" data-symbol="sink">Kitchen Sink</button>
                <button class="symbol-item" data-symbol="dw">Dishwasher</button>
                <div class="symbol-header">BATHROOM</div>
                <button class="symbol-item" data-symbol="toilet">Toilet</button>
                <button class="symbol-item" data-symbol="tub">Bathtub</button>
                <button class="symbol-item" data-symbol="shower">Shower</button>
                <button class="symbol-item" data-symbol="bath-sink">Bath Sink</button>
            </div></div>

            <!-- Mercantile/Retail -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üè™ Mercantile</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="clothes-rack">Clothes Rack</button>
                <button class="symbol-item" data-symbol="display-case">Display Case</button>
                <button class="symbol-item" data-symbol="shelf-aisle">Shelving Aisle</button>
                <button class="symbol-item" data-symbol="checkout">Checkout Counter</button>
                <button class="symbol-item" data-symbol="register">Cash Register</button>
                <button class="symbol-item" data-symbol="shopping-cart">Cart Corral</button>
                <button class="symbol-item" data-symbol="freezer">Freezer Case</button>
                <button class="symbol-item" data-symbol="cooler">Walk-in Cooler</button>
                <button class="symbol-item" data-symbol="storage-room">Storage Room</button>
            </div></div>

            <!-- Accessibility -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ôø ADA</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="handicap">Handicap Symbol</button>
                <button class="symbol-item" data-symbol="ada-parking">ADA Parking</button>
                <button class="symbol-item" data-symbol="ada-ramp">Wheelchair Ramp</button>
                <button class="symbol-item" data-symbol="ada-restroom">ADA Restroom</button>
                <button class="symbol-item" data-symbol="elevator-ada">ADA Elevator</button>
                <button class="symbol-item" data-symbol="auto-door">Auto Door Opener</button>
            </div></div>

            <!-- Obstructions -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö†Ô∏è Obstructions</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="tree">Tree</button>
                <button class="symbol-item" data-symbol="shrub">Shrub/Bush</button>
                <button class="symbol-item" data-symbol="powerline">Power Lines</button>
                <button class="symbol-item" data-symbol="gas-line">Gas Line</button>
                <button class="symbol-item" data-symbol="water-line">Water Line</button>
                <button class="symbol-item" data-symbol="fence">Fence</button>
                <button class="symbol-item" data-symbol="bollard">Bollard</button>
                <button class="symbol-item" data-symbol="limited">Limited Access</button>
                <button class="symbol-item" data-symbol="no-access">No Access</button>
                <button class="symbol-item" data-symbol="overhead">Overhead Obstruction</button>
            </div></div>

            <!-- Mechanical/Industrial -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üîß Mechanical</button><div class="symbol-dropdown-content">
                <div class="symbol-header">SHOP</div>
                <button class="symbol-item" data-symbol="vehicle-lift">Vehicle Lift</button>
                <button class="symbol-item" data-symbol="tool-bench">Tool Bench</button>
                <button class="symbol-item" data-symbol="compressor">Air Compressor</button>
                <button class="symbol-item" data-symbol="welder">Welding Station</button>
                <button class="symbol-item" data-symbol="paint-booth">Paint Booth</button>
                <button class="symbol-item" data-symbol="oil-pit">Oil Change Pit</button>
                <div class="symbol-header">INDUSTRIAL</div>
                <button class="symbol-item" data-symbol="conveyor">Conveyor Belt</button>
                <button class="symbol-item" data-symbol="forklift">Forklift Area</button>
                <button class="symbol-item" data-symbol="crane">Overhead Crane</button>
                <button class="symbol-item" data-symbol="machine">Machinery</button>
                <button class="symbol-item" data-symbol="pallet">Pallet Rack</button>
                <button class="symbol-item" data-symbol="loading">Loading Dock</button>
            </div></div>

            <!-- Church/Assembly -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚õ™ Assembly</button><div class="symbol-dropdown-content">
                <div class="symbol-header">CHURCH</div>
                <button class="symbol-item" data-symbol="pew">Pew/Seating Row</button>
                <button class="symbol-item" data-symbol="altar">Altar/Stage</button>
                <button class="symbol-item" data-symbol="pulpit">Pulpit/Podium</button>
                <button class="symbol-item" data-symbol="baptistry">Baptistry</button>
                <button class="symbol-item" data-symbol="choir">Choir Loft</button>
                <button class="symbol-item" data-symbol="organ">Organ/Piano</button>
                <div class="symbol-header">ASSEMBLY</div>
                <button class="symbol-item" data-symbol="seat-row">Seating Row</button>
                <button class="symbol-item" data-symbol="stage">Stage</button>
                <button class="symbol-item" data-symbol="bleachers">Bleachers</button>
                <button class="symbol-item" data-symbol="concession">Concession</button>
                <button class="symbol-item" data-symbol="ticket">Ticket Booth</button>
            </div></div>

            <!-- Other -->
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üìç Other</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="dumpster">Dumpster</button>
                <button class="symbol-item" data-symbol="wc">Restroom</button>
                <button class="symbol-item" data-symbol="office">Office</button>
                <button class="symbol-item" data-symbol="breakroom">Break Room</button>
                <button class="symbol-item" data-symbol="server">Server Room</button>
                <button class="symbol-item" data-symbol="mech-room">Mechanical Room</button>
            </div></div>
        </div>

        <div class="canvas-wrapper"><canvas id="floor-canvas" width="900" height="550"></canvas></div>
        
        <div style="display:flex;gap:12px;flex-wrap:wrap">
            <button type="button" class="btn-secondary" id="new-image-btn">üì∑ New Image</button>
            <button type="button" class="btn-secondary" id="export-png-btn">üíæ Export PNG</button>
        </div>
    </div>
    
    <form id="floor-plan-form">
        <input type="hidden" name="floor_plan_data" id="floor-plan-data">
        <div class="form-actions">
            <button type="button" id="prev-btn" class="btn-secondary">‚Üê Previous</button>
            <button type="button" id="next-btn" class="btn-primary">Next ‚Üí Review & Submit</button>
        </div>
    </form>
</div>
<footer><img src="images/city-logo.png" alt="City" class="city-logo"><p>¬© 2026 City of Centerville Fire Department</p></footer>
</div>

<!-- NFPA 704 Modal -->
<div id="nfpa-modal" class="nfpa-modal hidden">
    <div class="nfpa-modal-content">
        <h3>NFPA 704 Placard</h3>
        <div class="nfpa-diamond">
            <div class="nfpa-quad nfpa-top"><input type="text" id="nfpa-fire" value="0" maxlength="1"></div>
            <div class="nfpa-quad nfpa-left"><input type="text" id="nfpa-health" value="0" maxlength="1"></div>
            <div class="nfpa-quad nfpa-right"><input type="text" id="nfpa-react" value="0" maxlength="1"></div>
            <div class="nfpa-quad nfpa-bottom"><input type="text" id="nfpa-special" value="" maxlength="3" placeholder="W,OX"></div>
        </div>
        <p style="font-size:0.8rem;color:#666;margin:10px 0">üî¥ Fire (top) | üîµ Health (left) | üü° Reactivity (right) | ‚¨ú Special (bottom)</p>
        <div style="display:flex;gap:10px;justify-content:center">
            <button type="button" class="btn-primary" id="nfpa-add">Add to Canvas</button>
            <button type="button" class="btn-secondary" id="nfpa-cancel">Cancel</button>
        </div>
    </div>
</div>

<div id="toast-container" class="toast-container"></div>

<script>
let canvas,currentTool='select',currentFloor=1,floorData={},isDrawing=false,startX,startY,currentShape;
let history=[],historyIdx=-1,maxHistory=50;

const colorEl=document.getElementById('stroke-color'),wallEl=document.getElementById('wall-thickness');
const scaleEl=document.getElementById('scale-select'),unitEl=document.getElementById('unit-select');
const getColor=()=>colorEl.value,getWall=()=>parseInt(wallEl.value)||6,getScale=()=>parseInt(scaleEl.value)||24;
const getUnit=()=>unitEl.value;

function toast(m,t='info'){const c=document.getElementById('toast-container'),e=document.createElement('div');e.className='toast '+t;e.innerHTML='<span>'+m+'</span>';c.appendChild(e);setTimeout(()=>{e.style.opacity='0';setTimeout(()=>e.remove(),300)},2500)}

// Undo/Redo
function saveHistory(){
    if(historyIdx<history.length-1)history=history.slice(0,historyIdx+1);
    history.push(JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData'])));
    if(history.length>maxHistory)history.shift();
    historyIdx=history.length-1;
}
function undo(){if(historyIdx>0){historyIdx--;canvas.loadFromJSON(JSON.parse(history[historyIdx]),()=>canvas.renderAll())}}
function redo(){if(historyIdx<history.length-1){historyIdx++;canvas.loadFromJSON(JSON.parse(history[historyIdx]),()=>canvas.renderAll())}}

document.getElementById('undo-btn').onclick=undo;
document.getElementById('redo-btn').onclick=redo;
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo()}if(e.ctrlKey&&e.key==='y'){e.preventDefault();redo()}});

// Upload
const uploadArea=document.getElementById('upload-area'),uploadInput=document.getElementById('image-upload');
const uploadSec=document.getElementById('upload-section'),annotSec=document.getElementById('annotation-section');
uploadArea.onclick=()=>uploadInput.click();
uploadArea.ondragover=e=>{e.preventDefault();uploadArea.style.borderColor='#1e3a5f'};
uploadArea.ondragleave=()=>uploadArea.style.borderColor='#cbd5e1';
uploadArea.ondrop=e=>{e.preventDefault();uploadArea.style.borderColor='#cbd5e1';if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0])};
uploadInput.onchange=e=>{if(e.target.files[0])loadFile(e.target.files[0])};
document.getElementById('blank-canvas-btn').onclick=()=>initCanvas(null);

function loadFile(f){if(!f.type.startsWith('image/')){toast('Upload an image','error');return}const r=new FileReader();r.onload=e=>initCanvas(e.target.result);r.readAsDataURL(f)}

function initCanvas(url){
    uploadSec.classList.add('hidden');annotSec.classList.remove('hidden');
    if(!canvas){canvas=new fabric.Canvas('floor-canvas',{backgroundColor:'white',preserveObjectStacking:true});setupEvents()}
    canvas.clear();canvas.backgroundColor='white';history=[];historyIdx=-1;
    if(url){fabric.Image.fromURL(url,img=>{const s=Math.min(canvas.width/img.width,canvas.height/img.height);img.scale(s).set({left:0,top:0,selectable:false,evented:false,isBg:true});canvas.add(img).sendToBack(img).renderAll();saveHistory();toast('Loaded','success')})}
    else{canvas.renderAll();saveHistory();toast('Ready','success')}
}

function setupEvents(){
    canvas.on('mouse:down',o=>{if(currentTool==='select')return;const p=canvas.getPointer(o.e);startX=p.x;startY=p.y;isDrawing=true;
        if(currentTool==='text'){const t=new fabric.IText('Label',{left:startX,top:startY,fontSize:14,fill:getColor(),fontFamily:'Arial'});canvas.add(t).setActiveObject(t);t.enterEditing();isDrawing=false;saveHistory()}
        else if(currentTool==='wall'){currentShape=new fabric.Line([startX,startY,startX,startY],{stroke:getColor(),strokeWidth:getWall(),strokeLineCap:'square'});canvas.add(currentShape)}
        else if(currentTool==='line'){currentShape=new fabric.Line([startX,startY,startX,startY],{stroke:getColor(),strokeWidth:2});canvas.add(currentShape)}
        else if(currentTool==='dimension'){currentShape=new fabric.Line([startX,startY,startX,startY],{stroke:'#333',strokeWidth:1,strokeDashArray:[4,2]});canvas.add(currentShape)}
        else if(currentTool==='rect'){currentShape=new fabric.Rect({left:startX,top:startY,width:0,height:0,fill:'transparent',stroke:getColor(),strokeWidth:2});canvas.add(currentShape)}
    });
    canvas.on('mouse:move',o=>{if(!isDrawing||!currentShape)return;const p=canvas.getPointer(o.e);
        if(['wall','line','dimension'].includes(currentTool))currentShape.set({x2:p.x,y2:p.y});
        else if(currentTool==='rect'){const w=p.x-startX,h=p.y-startY;currentShape.set({width:Math.abs(w),height:Math.abs(h),left:w<0?p.x:startX,top:h<0?p.y:startY})}
        canvas.renderAll()});
    canvas.on('mouse:up',()=>{if(currentTool==='dimension'&&currentShape)addDim(currentShape);if(currentTool==='rect'&&currentShape)addRectDim(currentShape);isDrawing=false;currentShape=null;saveHistory();saveData()});
    canvas.on('object:modified',()=>{saveHistory();saveData()});
}

function formatDim(px){
    const scale=getScale(),unit=getUnit();
    if(unit==='in'){return (px/scale*12).toFixed(0)+'"'}
    return (px/scale).toFixed(1)+"'";
}

function addDim(line){
    const x1=line.x1,y1=line.y1,x2=line.x2,y2=line.y2,len=Math.sqrt((x2-x1)**2+(y2-y1)**2);
    const mx=(x1+x2)/2,my=(y1+y2)/2,ang=Math.atan2(y2-y1,x2-x1)+Math.PI/2,tk=5;
    const t1=new fabric.Line([x1-Math.cos(ang)*tk,y1-Math.sin(ang)*tk,x1+Math.cos(ang)*tk,y1+Math.sin(ang)*tk],{stroke:'#333',strokeWidth:1});
    const t2=new fabric.Line([x2-Math.cos(ang)*tk,y2-Math.sin(ang)*tk,x2+Math.cos(ang)*tk,y2+Math.sin(ang)*tk],{stroke:'#333',strokeWidth:1});
    const txt=new fabric.Text(formatDim(len),{left:mx,top:my-10,fontSize:10,fill:'#333',originX:'center',backgroundColor:'rgba(255,255,255,.85)'});
    const g=new fabric.Group([line,t1,t2,txt]);canvas.remove(line);canvas.add(g).renderAll();
}

function addRectDim(r){
    const wTxt=new fabric.Text(formatDim(r.width),{left:r.left+r.width/2,top:r.top-12,fontSize:9,fill:'#555',originX:'center',backgroundColor:'rgba(255,255,255,.8)'});
    const hTxt=new fabric.Text(formatDim(r.height),{left:r.left+r.width+3,top:r.top+r.height/2,fontSize:9,fill:'#555',originY:'center',backgroundColor:'rgba(255,255,255,.8)'});
    canvas.add(wTxt,hTxt);
}

// Tools
document.querySelectorAll('.tool-btn[data-tool]').forEach(b=>{b.onclick=()=>{document.querySelectorAll('.tool-btn[data-tool]').forEach(x=>x.classList.remove('active'));b.classList.add('active');currentTool=b.dataset.tool;canvas.isDrawingMode=currentTool==='draw';if(canvas.isDrawingMode){canvas.freeDrawingBrush.color=getColor();canvas.freeDrawingBrush.width=2}canvas.selection=currentTool==='select'}});
colorEl.onchange=()=>{if(canvas?.isDrawingMode)canvas.freeDrawingBrush.color=getColor()};

// Symbol creation
function addSym(type,x,y){const c=getColor(),s=getScale();let obj;
const M={
// Fire
'facp':()=>box(42,32,'FACP','red'),'annunciator':()=>box(38,28,'ANN','red'),'fdc':()=>circ(14,'FDC','red'),'sprinkler':()=>circ(12,'SR','blue'),'standpipe':()=>box(22,30,'SP','blue'),'extinguisher':()=>circ(10,'FE','red'),'hydrant':()=>circ(12,'H','red'),'pull':()=>box(16,20,'PS','red'),'smoke':()=>circ(8,'SD','#666'),
// Doors/Windows - all with wall injection capability
'door-l':()=>door(3*s/2,'L'),'door-r':()=>door(3*s/2,'R'),'door-d':()=>dblDoor(5*s/2),'door-roll':()=>rollup(8*s/2),'door-slide':()=>slider(6*s/2),'door-rev':()=>revolving(4*s/2),'win-3':()=>win(3*s/2),'win-4':()=>win(4*s/2),'win-6':()=>win(6*s/2),'exit':()=>box(34,16,'EXIT','green','white'),
// Access
'stairs':()=>stairs(4*s/2,6*s/2,'UP'),'stairs-dn':()=>stairs(4*s/2,6*s/2,'DN'),'elevator':()=>box(5*s/2,5*s/2,'ELEV','#666'),'escalator':()=>box(4*s/2,8*s/2,'ESC','#666'),'knox':()=>box(20,16,'KNOX','orange'),'roof':()=>box(30,30,'ROOF','orange'),
// Utilities
'elec':()=>box(26,38,'ELEC','orange'),'elec-off':()=>circ(12,'E‚ö°','orange'),'gas-meter':()=>box(20,24,'GAS','#eab308'),'gas-off':()=>circ(12,'G','#eab308','#000'),'water-off':()=>circ(12,'W','blue'),'hvac':()=>box(50,50,'HVAC','#666'),'gen':()=>box(58,40,'GEN','orange'),'solar':()=>circ(14,'‚òÄÔ∏è','#eab308','#000'),
// Hazmat
'nfpa704':()=>nfpa704(),'hazmat':()=>box(40,40,'HAZ','purple'),'flammable':()=>box(36,36,'üî•','red'),'propane':()=>circ(18,'LP','red'),'fuel':()=>box(50,30,'FUEL','red'),'chemical':()=>box(36,36,'CHEM','purple'),
// Compass
'compass':()=>compass(),'north':()=>northArrow(),'north-simple':()=>simpleNorth(),
// Vehicles
'v-engine':()=>veh(85,24,'ENGINE','red'),'v-ladder':()=>veh(105,24,'LADDER','red'),'v-rescue':()=>veh(70,24,'RESCUE','red'),'v-amb':()=>veh(58,22,'EMS','#fff'),'v-bc':()=>veh(48,20,'BC','red'),'v-police':()=>veh(45,18,'PD','#fff'),
'v-car':()=>veh(40,18,'CAR','#999'),'v-suv':()=>veh(45,20,'SUV','#999'),'v-pickup':()=>veh(52,20,'PICKUP','#999'),'v-van':()=>veh(48,22,'VAN','#999'),'v-semi':()=>veh(130,24,'SEMI','#777'),'v-bus':()=>veh(100,24,'BUS','#eab308','#000'),'v-moto':()=>veh(22,10,'MC','#999'),
// Furniture
'bed':()=>bed(5*s/2,6*s/2),'sofa':()=>box(7*s/2,2.5*s/2,'SOFA',c),'desk':()=>box(5*s/2,2.5*s/2,'DESK',c),'table':()=>box(4*s/2,3*s/2,'TABLE',c),'chair':()=>circ(s/2,'',c),'bookshelf':()=>box(5*s/2,s/2,'SHELF',c),'cabinet':()=>box(3*s/2,2*s/2,'CAB',c),
// Kitchen/Bath
'fridge':()=>box(3*s/2,3*s/2,'REF',c),'stove':()=>stove(2.5*s/2),'sink':()=>sink(2.5*s/2,1.8*s/2),'dw':()=>box(2*s/2,2*s/2,'DW',c),'toilet':()=>toilet(s/2),'tub':()=>box(5*s/2,2.5*s/2,'TUB',c),'shower':()=>box(3*s/2,3*s/2,'SHWR',c),'bath-sink':()=>sink(2*s/2,1.5*s/2),
// Mercantile
'clothes-rack':()=>clothesRack(),'display-case':()=>box(60,30,'DISPLAY',c),'shelf-aisle':()=>shelfAisle(),'checkout':()=>box(80,30,'CHECKOUT',c),'register':()=>box(30,24,'REG',c),'shopping-cart':()=>box(40,20,'CARTS',c),'freezer':()=>box(80,36,'FREEZER','#60a5fa'),'cooler':()=>box(100,80,'COOLER','#60a5fa'),'storage-room':()=>box(80,60,'STORAGE','#666'),
// Accessibility
'handicap':()=>handicap(),'ada-parking':()=>adaParking(),'ada-ramp':()=>box(50,30,'RAMP‚ôø','blue'),'ada-restroom':()=>box(40,40,'WC‚ôø','blue'),'elevator-ada':()=>box(60,60,'ELEV‚ôø','blue'),'auto-door':()=>box(36,20,'AUTO','blue'),
// Obstructions
'tree':()=>tree(),'shrub':()=>shrub(),'powerline':()=>powerline(),'gas-line':()=>utilLine('GAS','#eab308'),'water-line':()=>utilLine('W','blue'),'fence':()=>fence(),'bollard':()=>circ(6,'','#666'),'limited':()=>box(60,24,'LIMITED','orange'),'no-access':()=>box(60,24,'NO ACCESS','red'),'overhead':()=>box(60,24,'OVERHEAD','orange'),
// Mechanical/Industrial
'vehicle-lift':()=>box(70,40,'LIFT','#666'),'tool-bench':()=>box(60,24,'BENCH',c),'compressor':()=>circ(20,'AIR','#666'),'welder':()=>box(30,30,'WELD','orange'),'paint-booth':()=>box(100,80,'PAINT','#666'),'oil-pit':()=>box(40,80,'PIT','#666'),
'conveyor':()=>conveyor(),'forklift':()=>box(40,30,'üöú','#eab308'),'crane':()=>box(120,20,'CRANE','#666'),'machine':()=>box(60,50,'MACH','#666'),'pallet':()=>box(100,40,'PALLET RACK',c),'loading':()=>box(80,40,'LOADING','#666'),
// Church/Assembly
'pew':()=>pew(),'altar':()=>box(80,30,'ALTAR','#8b5cf6'),'pulpit':()=>box(30,30,'PULPIT','#8b5cf6'),'baptistry':()=>circ(30,'BAPT','#60a5fa'),'choir':()=>box(80,30,'CHOIR','#8b5cf6'),'organ':()=>box(50,30,'ORGAN','#8b5cf6'),
'seat-row':()=>seatRow(),'stage':()=>box(120,40,'STAGE','#8b5cf6'),'bleachers':()=>bleachers(),'concession':()=>box(60,30,'CONCESSION',c),'ticket':()=>box(30,30,'TICKET',c),
// Other
'dumpster':()=>box(50,40,'DUMP','#666'),'wc':()=>box(30,30,'WC',c),'office':()=>box(60,50,'OFFICE',c),'breakroom':()=>box(60,50,'BREAK',c),'server':()=>box(50,40,'SERVER','#666'),'mech-room':()=>box(60,50,'MECH','#666')
};
if(type==='nfpa704'){showNFPAModal();return}
obj=M[type]?M[type]():box(30,30,type.slice(0,3).toUpperCase(),c);
obj.set({left:x,top:y});canvas.add(obj).setActiveObject(obj).renderAll();saveHistory();saveData()}

// Basic shapes
function box(w,h,lbl,fill,tf='white'){const il=fill===getColor();return new fabric.Group([new fabric.Rect({width:w,height:h,fill:il?'transparent':fill,stroke:il?fill:'#333',strokeWidth:il?2:1,rx:2,ry:2,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:Math.min(11,w/Math.max(lbl.length,1)*1.2),fill:il?fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}
function circ(r,lbl,fill,tf='white'){return new fabric.Group([new fabric.Circle({radius:r,fill:fill,stroke:'#333',strokeWidth:1,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:r*.7,fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}

// Doors with wall cutout
function door(w,dir){const p=[],th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white',stroke:'white',strokeWidth:0}));
const swing=dir==='L'?-1:1;
p.push(new fabric.Line([swing*-w/2,0,swing*-w/2,-w],{stroke:getColor(),strokeWidth:3}));
p.push(new fabric.Circle({left:swing===-1?-w/2-w:-w/2,top:-w,radius:w,startAngle:dir==='L'?0:Math.PI/2,endAngle:dir==='L'?Math.PI/2:Math.PI,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

function dblDoor(w){const p=[],hw=w/2,th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));
p.push(new fabric.Line([-hw,0,-hw,-hw],{stroke:getColor(),strokeWidth:3}));
p.push(new fabric.Circle({left:-hw-hw,top:-hw,radius:hw,startAngle:0,endAngle:Math.PI/2,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));
p.push(new fabric.Line([hw,0,hw,-hw],{stroke:getColor(),strokeWidth:3}));
p.push(new fabric.Circle({left:0,top:-hw,radius:hw,startAngle:Math.PI/2,endAngle:Math.PI,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

function rollup(w){const p=[],th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));
p.push(new fabric.Rect({left:-w/2,top:-4,width:w,height:8,fill:'transparent',stroke:'#333',strokeWidth:2}));
for(let i=0;i<4;i++)p.push(new fabric.Line([-w/2+8+i*(w-16)/3,-2,-w/2+8+(i+.5)*(w-16)/3,2],{stroke:'#333',strokeWidth:1}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

function slider(w){const p=[],th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));
p.push(new fabric.Rect({left:-w/2,top:-4,width:w,height:8,fill:'white',stroke:'#333',strokeWidth:2}));
p.push(new fabric.Rect({left:-w/2+2,top:-2,width:w/2-4,height:4,fill:'#ccc',stroke:'#333',strokeWidth:1}));
p.push(new fabric.Rect({left:2,top:-2,width:w/2-4,height:4,fill:'#aaa',stroke:'#333',strokeWidth:1}));
p.push(new fabric.Triangle({left:w/4,top:-10,width:8,height:6,fill:'#333',angle:90}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

function revolving(w){const p=[],th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-w/2-2,width:w+4,height:w+4,fill:'white'}));
p.push(new fabric.Circle({left:-w/2,top:-w/2,radius:w/2,fill:'transparent',stroke:'#333',strokeWidth:2}));
p.push(new fabric.Line([0,-w/2,0,w/2],{stroke:getColor(),strokeWidth:2}));
p.push(new fabric.Line([-w/2,0,w/2,0],{stroke:getColor(),strokeWidth:2}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

function win(w){const ft=formatDim(w),p=[],th=getWall();
p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));
p.push(new fabric.Rect({left:-w/2,top:-3,width:w,height:6,fill:'lightblue',stroke:'#333',strokeWidth:2}));
p.push(new fabric.Line([0,-3,0,3],{stroke:'#333',strokeWidth:1}));
p.push(new fabric.Text(ft,{left:0,top:-12,fontSize:9,fill:'#333',originX:'center',backgroundColor:'rgba(255,255,255,.8)'}));
return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}

// Stairs
function stairs(w,h,dir){const p=[new fabric.Rect({left:-w/2,top:-h/2,width:w,height:h,fill:'transparent',stroke:'#333',strokeWidth:2})];
for(let i=1;i<7;i++)p.push(new fabric.Line([-w/2+3,-h/2+(h/7)*i,w/2-3,-h/2+(h/7)*i],{stroke:'#333',strokeWidth:1}));
const arrY=dir==='UP'?-h/2+12:h/2-12,arrAng=dir==='UP'?180:0;
p.push(new fabric.Triangle({left:0,top:arrY,width:10,height:12,fill:'#333',angle:arrAng,originX:'center',originY:'center'}));
p.push(new fabric.Text(dir,{left:0,top:0,fontSize:10,fill:'#333',originX:'center',originY:'center'}));
return new fabric.Group(p,{originX:'center',originY:'center'})}

// Kitchen/Bath
function bed(w,h){const c=getColor();return new fabric.Group([new fabric.Rect({left:-w/2,top:-h/2,width:w,height:h,fill:'transparent',stroke:c,strokeWidth:2,rx:3}),new fabric.Rect({left:-w/2+4,top:-h/2+4,width:w-8,height:h*.18,fill:'transparent',stroke:c,strokeWidth:1,rx:2})],{originX:'center',originY:'center'})}
function stove(sz){const c=getColor(),p=[new fabric.Rect({left:-sz/2,top:-sz/2,width:sz,height:sz,fill:'transparent',stroke:c,strokeWidth:2})];const o=sz*.25;[[-o,-o],[o,-o],[-o,o],[o,o]].forEach(([x,y])=>p.push(new fabric.Circle({left:x-sz*.1,top:y-sz*.1,radius:sz*.1,fill:'transparent',stroke:c,strokeWidth:1})));return new fabric.Group(p,{originX:'center',originY:'center'})}
function sink(w,h){const c=getColor();return new fabric.Group([new fabric.Rect({left:-w/2,top:-h/2,width:w,height:h,fill:'transparent',stroke:c,strokeWidth:2,rx:3}),new fabric.Rect({left:-w/2+3,top:-h/2+3,width:w-6,height:h-6,fill:'transparent',stroke:c,strokeWidth:1,rx:2}),new fabric.Circle({left:-2,top:-h/2-4,radius:3,fill:c})],{originX:'center',originY:'center'})}
function toilet(s){const c=getColor();return new fabric.Group([new fabric.Ellipse({left:-s*.6,top:-s*.3,rx:s*.6,ry:s*.75,fill:'transparent',stroke:c,strokeWidth:2}),new fabric.Rect({left:-s*.5,top:-s*1.2,width:s,height:s*.5,fill:'transparent',stroke:c,strokeWidth:2,rx:3})],{originX:'center',originY:'center'})}

// NFPA 704
function showNFPAModal(){document.getElementById('nfpa-modal').classList.remove('hidden')}
document.getElementById('nfpa-cancel').onclick=()=>document.getElementById('nfpa-modal').classList.add('hidden');
document.getElementById('nfpa-add').onclick=()=>{
    const f=document.getElementById('nfpa-fire').value||'0',h=document.getElementById('nfpa-health').value||'0';
    const r=document.getElementById('nfpa-react').value||'0',sp=document.getElementById('nfpa-special').value||'';
    const obj=createNFPA704(f,h,r,sp);
    obj.set({left:canvas.width/2,top:canvas.height/2});
    canvas.add(obj).setActiveObject(obj).renderAll();
    document.getElementById('nfpa-modal').classList.add('hidden');
    saveHistory();saveData();
};
function nfpa704(){showNFPAModal();return null}
function createNFPA704(fire,health,react,special){
    const sz=30,p=[];
    // Diamond background
    p.push(new fabric.Rect({left:0,top:0,width:sz*1.4,height:sz*1.4,fill:'white',stroke:'black',strokeWidth:2,angle:45,originX:'center',originY:'center'}));
    // Quadrant colors
    p.push(new fabric.Polygon([{x:0,y:-sz*.7},{x:sz*.5,y:0},{x:0,y:0}],{fill:'red',originX:'center',originY:'center'}));//fire top
    p.push(new fabric.Polygon([{x:-sz*.7,y:0},{x:0,y:-sz*.5},{x:0,y:sz*.5}],{fill:'blue',originX:'center',originY:'center'}));//health left
    p.push(new fabric.Polygon([{x:sz*.7,y:0},{x:0,y:-sz*.5},{x:0,y:sz*.5}],{fill:'yellow',originX:'center',originY:'center'}));//react right
    p.push(new fabric.Polygon([{x:0,y:sz*.7},{x:sz*.5,y:0},{x:-sz*.5,y:0}],{fill:'white',stroke:'black',strokeWidth:1,originX:'center',originY:'center'}));//special bottom
    // Numbers
    p.push(new fabric.Text(fire,{left:0,top:-sz*.35,fontSize:14,fill:'white',fontWeight:'bold',originX:'center',originY:'center'}));
    p.push(new fabric.Text(health,{left:-sz*.35,top:0,fontSize:14,fill:'white',fontWeight:'bold',originX:'center',originY:'center'}));
    p.push(new fabric.Text(react,{left:sz*.35,top:0,fontSize:14,fill:'black',fontWeight:'bold',originX:'center',originY:'center'}));
    p.push(new fabric.Text(special,{left:0,top:sz*.35,fontSize:10,fill:'black',fontWeight:'bold',originX:'center',originY:'center'}));
    const g=new fabric.Group(p,{originX:'center',originY:'center',nfpaData:{fire,health,react,special}});
    return g;
}

// Compass
function compass(){const p=[],sz=40;
p.push(new fabric.Circle({left:-sz,top:-sz,radius:sz,fill:'white',stroke:'#333',strokeWidth:2}));
['N','E','S','W'].forEach((d,i)=>{const ang=i*Math.PI/2-Math.PI/2,x=Math.cos(ang)*(sz-12),y=Math.sin(ang)*(sz-12);
p.push(new fabric.Text(d,{left:x,top:y,fontSize:12,fill:d==='N'?'red':'#333',fontWeight:'bold',originX:'center',originY:'center'}))});
p.push(new fabric.Triangle({left:0,top:-sz+18,width:10,height:16,fill:'red',originX:'center',originY:'center'}));
p.push(new fabric.Triangle({left:0,top:sz-18,width:10,height:16,fill:'#333',angle:180,originX:'center',originY:'center'}));
return new fabric.Group(p,{originX:'center',originY:'center'})}

function northArrow(){const p=[];
p.push(new fabric.Triangle({left:0,top:-15,width:20,height:30,fill:'red',originX:'center',originY:'center'}));
p.push(new fabric.Triangle({left:0,top:15,width:20,height:15,fill:'#333',angle:180,originX:'center',originY:'center'}));
p.push(new fabric.Text('N',{left:0,top:-35,fontSize:16,fill:'red',fontWeight:'bold',originX:'center',originY:'center'}));
return new fabric.Group(p,{originX:'center',originY:'center'})}

function simpleNorth(){return new fabric.Group([new fabric.Triangle({left:0,top:-12,width:16,height:24,fill:'#333',originX:'center',originY:'center'}),new fabric.Text('N',{left:0,top:16,fontSize:14,fill:'#333',fontWeight:'bold',originX:'center',originY:'center'})],{originX:'center',originY:'center'})}

// Vehicles
function veh(l,w,lbl,fill,tf='white'){return new fabric.Group([new fabric.Rect({left:-l/2,top:-w/2,width:l,height:w,fill:fill,stroke:'#333',strokeWidth:1,rx:l*.06}),new fabric.Line([-l/2+l*.28,-w/2+2,-l/2+l*.28,w/2-2],{stroke:'#333',strokeWidth:1}),new fabric.Text(lbl,{left:l*.08,top:0,fontSize:Math.min(10,l*.14),fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}

// Mercantile
function clothesRack(){const c=getColor();return new fabric.Group([new fabric.Rect({left:-40,top:-10,width:80,height:20,fill:'transparent',stroke:c,strokeWidth:2}),new fabric.Line([-35,-5,35,-5],{stroke:c,strokeWidth:1}),new fabric.Line([-35,0,35,0],{stroke:c,strokeWidth:1}),new fabric.Text('RACK',{left:0,top:0,fontSize:8,fill:c,originX:'center',originY:'center'})],{originX:'center',originY:'center'})}
function shelfAisle(){const c=getColor();return new fabric.Group([new fabric.Rect({left:-20,top:-60,width:40,height:120,fill:'transparent',stroke:c,strokeWidth:2}),new fabric.Line([-15,-55,15,-55],{stroke:c,strokeWidth:1}),new fabric.Line([-15,-30,15,-30],{stroke:c,strokeWidth:1}),new fabric.Line([-15,-5,15,-5],{stroke:c,strokeWidth:1}),new fabric.Line([-15,20,15,20],{stroke:c,strokeWidth:1}),new fabric.Line([-15,45,15,45],{stroke:c,strokeWidth:1}),new fabric.Text('AISLE',{left:0,top:0,fontSize:8,fill:c,originX:'center',originY:'center',angle:-90})],{originX:'center',originY:'center'})}

// Accessibility
function handicap(){return new fabric.Group([new fabric.Circle({left:-20,top:-20,radius:20,fill:'blue',stroke:'white',strokeWidth:2}),new fabric.Text('‚ôø',{left:0,top:0,fontSize:24,fill:'white',originX:'center',originY:'center'})],{originX:'center',originY:'center'})}
function adaParking(){return new fabric.Group([new fabric.Rect({left:-30,top:-40,width:60,height:80,fill:'blue',stroke:'white',strokeWidth:2}),new fabric.Text('‚ôø',{left:0,top:-10,fontSize:28,fill:'white',originX:'center',originY:'center'}),new fabric.Text('PARKING',{left:0,top:20,fontSize:8,fill:'white',originX:'center',originY:'center'})],{originX:'center',originY:'center'})}

// Obstructions
function tree(){return new fabric.Group([new fabric.Circle({left:-15,top:-20,radius:18,fill:'#22c55e',stroke:'#166534',strokeWidth:2}),new fabric.Rect({left:-3,top:0,width:6,height:15,fill:'#854d0e'})],{originX:'center',originY:'center'})}
function shrub(){return new fabric.Group([new fabric.Ellipse({left:-12,top:-8,rx:15,ry:10,fill:'#22c55e',stroke:'#166534',strokeWidth:1})],{originX:'center',originY:'center'})}
function powerline(){return new fabric.Group([new fabric.Line([0,-30,0,30],{stroke:'#333',strokeWidth:3}),new fabric.Line([-15,-20,15,-20],{stroke:'#333',strokeWidth:2}),new fabric.Line([-10,-10,10,-10],{stroke:'#333',strokeWidth:2}),new fabric.Text('‚ö°',{left:0,top:0,fontSize:12,originX:'center',originY:'center'})],{originX:'center',originY:'center'})}
function utilLine(lbl,col){return new fabric.Group([new fabric.Line([-40,0,40,0],{stroke:col,strokeWidth:4,strokeDashArray:[10,5]}),new fabric.Text(lbl,{left:0,top:-10,fontSize:10,fill:col,fontWeight:'bold',originX:'center',backgroundColor:'rgba(255,255,255,.8)'})],{originX:'center',originY:'center'})}
function fence(){return new fabric.Group([new fabric.Line([-50,0,50,0],{stroke:'#666',strokeWidth:2}),new fabric.Line([-40,-10,-40,10],{stroke:'#666',strokeWidth:2}),new fabric.Line([-20,-10,-20,10],{stroke:'#666',strokeWidth:2}),new fabric.Line([0,-10,0,10],{stroke:'#666',strokeWidth:2}),new fabric.Line([20,-10,20,10],{stroke:'#666',strokeWidth:2}),new fabric.Line([40,-10,40,10],{stroke:'#666',strokeWidth:2})],{originX:'center',originY:'center'})}

// Industrial
function conveyor(){const c=getColor();return new fabric.Group([new fabric.Rect({left:-60,top:-10,width:120,height:20,fill:'transparent',stroke:c,strokeWidth:2}),new fabric.Circle({left:-55,top:-5,radius:8,fill:'transparent',stroke:c,strokeWidth:1}),new fabric.Circle({left:45,top:-5,radius:8,fill:'transparent',stroke:c,strokeWidth:1}),new fabric.Line([-45,0,45,0],{stroke:c,strokeWidth:1,strokeDashArray:[5,3]}),new fabric.Triangle({left:30,top:0,width:10,height:8,fill:c,angle:90,originX:'center',originY:'center'})],{originX:'center',originY:'center'})}

// Assembly
function pew(){const c=getColor();return new fabric.Group([new fabric.Rect({left:-50,top:-8,width:100,height:16,fill:'transparent',stroke:c,strokeWidth:2,rx:2}),new fabric.Rect({left:-48,top:-12,width:96,height:4,fill:'transparent',stroke:c,strokeWidth:1})],{originX:'center',originY:'center'})}
function seatRow(){const c=getColor(),p=[new fabric.Rect({left:-60,top:-8,width:120,height:16,fill:'transparent',stroke:c,strokeWidth:1})];for(let i=0;i<6;i++)p.push(new fabric.Rect({left:-55+i*20,top:-5,width:15,height:10,fill:'transparent',stroke:c,strokeWidth:1}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function bleachers(){const c=getColor(),p=[];for(let i=0;i<4;i++)p.push(new fabric.Rect({left:-50,top:-30+i*15,width:100,height:12,fill:'transparent',stroke:c,strokeWidth:1}));return new fabric.Group(p,{originX:'center',originY:'center'})}

// Symbol clicks
document.querySelectorAll('.symbol-item').forEach(b=>{b.onclick=()=>{if(!canvas){toast('Load canvas first','error');return}addSym(b.dataset.symbol,canvas.width/2,canvas.height/2)}});

// Controls
document.getElementById('delete-btn').onclick=()=>{const a=canvas.getActiveObjects();if(a.length){a.forEach(o=>{if(o.selectable)canvas.remove(o)});canvas.discardActiveObject().renderAll();saveHistory();saveData()}};
document.getElementById('clear-btn').onclick=()=>{if(!confirm('Clear all?'))return;const bg=canvas.getObjects().find(o=>o.isBg);canvas.clear();canvas.backgroundColor='white';if(bg)canvas.add(bg);canvas.renderAll();saveHistory();saveData()};
document.getElementById('new-image-btn').onclick=()=>{if(confirm('New image?')){uploadSec.classList.remove('hidden');annotSec.classList.add('hidden')}};
document.getElementById('export-png-btn').onclick=()=>{const a=document.createElement('a');a.download='floor-plan-'+currentFloor+'.png';a.href=canvas.toDataURL({format:'png',multiplier:2});a.click();toast('Exported','success')};

// Floor tabs
document.getElementById('floor-tabs').onclick=e=>{if(e.target.classList.contains('floor-tab')){if(canvas)floorData[currentFloor]=canvas.toJSON(['isBg','isOpening','nfpaData']);document.querySelectorAll('.floor-tab').forEach(t=>t.classList.remove('active'));e.target.classList.add('active');currentFloor=parseInt(e.target.dataset.floor);if(floorData[currentFloor]){uploadSec.classList.add('hidden');annotSec.classList.remove('hidden');if(!canvas){canvas=new fabric.Canvas('floor-canvas',{backgroundColor:'white',preserveObjectStacking:true});setupEvents()}canvas.loadFromJSON(floorData[currentFloor],()=>{canvas.renderAll();history=[JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData']))];historyIdx=0})}else{uploadSec.classList.remove('hidden');annotSec.classList.add('hidden');if(canvas)canvas.clear()}}};
document.getElementById('add-floor-btn').onclick=()=>{const n=document.querySelectorAll('.floor-tab').length+1,t=document.createElement('button');t.type='button';t.className='floor-tab';t.dataset.floor=n;t.textContent='Floor '+n;document.getElementById('floor-tabs').insertBefore(t,document.getElementById('add-floor-btn'));t.click()};

function saveData(){if(canvas)floorData[currentFloor]=canvas.toJSON(['isBg','isOpening','nfpaData']);document.getElementById('floor-plan-data').value=JSON.stringify(floorData);const d={...JSON.parse(localStorage.getItem('preFirePlan')||'{}')};d.floor_plan_data=document.getElementById('floor-plan-data').value;localStorage.setItem('preFirePlan',JSON.stringify(d))}

window.onload=()=>{const s=JSON.parse(localStorage.getItem('preFirePlan')||'{}');if(s.floor_plan_data){try{floorData=JSON.parse(s.floor_plan_data);Object.keys(floorData).map(Number).sort((a,b)=>a-b).forEach((n,i)=>{if(i>0){const t=document.createElement('button');t.type='button';t.className='floor-tab';t.dataset.floor=n;t.textContent='Floor '+n;document.getElementById('floor-tabs').insertBefore(t,document.getElementById('add-floor-btn'))}});if(floorData[1]){uploadSec.classList.add('hidden');annotSec.classList.remove('hidden');canvas=new fabric.Canvas('floor-canvas',{backgroundColor:'white',preserveObjectStacking:true});setupEvents();canvas.loadFromJSON(floorData[1],()=>{canvas.renderAll();history=[JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData']))];historyIdx=0})}}catch(e){console.error(e)}}};

document.getElementById('prev-btn').onclick=()=>{saveData();window.location.href='page10-site-plan.html'};
document.getElementById('next-btn').onclick=()=>{saveData();toast('Saved','success');setTimeout(()=>window.location.href='page12-submit.html',500)};
</script>
</body>
</html>
