<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pre-Fire Plan: Floor Plan</title>
<link rel="stylesheet" href="styles-preplan.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
.floor-tabs{display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap}
.floor-tab{padding:8px 16px;background:#e2e8f0;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;font-size:13px}
.floor-tab:hover{background:#cbd5e1}.floor-tab.active{background:#1e3a5f;color:white}
.add-floor-btn{background:#22c55e;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
.upload-area{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;margin-bottom:20px;transition:all .2s}
.upload-area:hover{border-color:#1e3a5f;background:#f8fafc}
.hidden{display:none!important}
.canvas-wrapper{border:2px solid #cbd5e1;border-radius:12px;overflow:hidden;margin-bottom:12px;position:relative}
.canvas-wrapper .lower-canvas{
    background-image:
        linear-gradient(to right,#e0e7ef 1px,transparent 1px),
        linear-gradient(to bottom,#e0e7ef 1px,transparent 1px),
        linear-gradient(to right,#c7d2e0 1px,transparent 1px),
        linear-gradient(to bottom,#c7d2e0 1px,transparent 1px);
    background-size:10px 10px,10px 10px,50px 50px,50px 50px;
    background-color:#fff;
}
.toolbar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.tool-btn{padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s}
.tool-btn:hover{background:#e2e8f0}.tool-btn.active{background:#1e3a5f;color:white;border-color:#1e3a5f}
.toolbar-sep{width:1px;height:24px;background:#cbd5e1;margin:0 2px}
.toolbar select,.toolbar input[type=color]{padding:4px;border:1px solid #cbd5e1;border-radius:4px;font-size:11px}
.toolbar input[type=color]{width:28px;height:26px;padding:1px;cursor:pointer}
.symbol-bar{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.symbol-dropdown{position:relative;display:inline-block}
.symbol-dropdown-btn{padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap}
.symbol-dropdown-btn:hover{background:#e2e8f0}
.symbol-dropdown-content{display:none;position:absolute;left:0;top:100%;background:#fff;border:1px solid #cbd5e1;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:100;min-width:160px;max-height:300px;overflow-y:auto;padding:4px}
.symbol-dropdown:hover .symbol-dropdown-content{display:block}
.symbol-item{display:block;width:100%;text-align:left;padding:6px 10px;border:none;background:none;cursor:pointer;font-size:11px;border-radius:4px;white-space:nowrap}
.symbol-item:hover{background:#e2e8f0}
.symbol-header{padding:6px 10px;font-weight:700;font-size:10px;color:#666;text-transform:uppercase;border-bottom:1px solid #e2e8f0;margin-top:4px}
.legend{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-top:12px}
.legend h4{margin:0 0 8px;font-size:13px;color:#1e3a5f}
.legend-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:4px;font-size:11px;color:#555}
.nfpa-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:none;justify-content:center;align-items:center}
.nfpa-modal.show{display:flex}
.nfpa-form{background:#fff;border-radius:12px;padding:24px;max-width:320px;width:90%}
.nfpa-form h3{margin:0 0 12px}
.nfpa-form label{display:block;margin:8px 0 4px;font-size:13px;font-weight:600}
.nfpa-form input,.nfpa-form select{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px}
.nfpa-form .nfpa-actions{display:flex;gap:8px;margin-top:16px}
.import-panel{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px;margin-bottom:12px}
.import-panel h4{margin:0 0 8px;color:#0369a1;font-size:13px}
.import-panel button{padding:6px 12px;border:1px solid #0ea5e9;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-right:6px}
.import-panel button:hover{background:#e0f2fe}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:1000;display:none;background:#22c55e;color:#fff}
</style>
</head>
<body>
<div class="page-wrapper">
    <div class="container">
        <header class="report-header">
            <div class="header-top">
                <img src="images/cfd-logo.png" alt="Centerville Fire Department" class="patch-logo">
                <div class="header-text"><h1>Centerville Fire Department</h1><h2>Pre-Fire Plan Data Sheet</h2></div>
            </div>
        </header>
        <div class="progress-indicator">Page 11 of 12: Floor Plan</div>
        <div class="progress-bar-container"><div class="progress-bar" style="width:91.66%"></div></div>
    <div class="preplan-header"><h3>Page 11: Floor Plan Drawing</h3></div>
    <div class="floor-tabs" id="floorTabs">
        <button class="floor-tab active" data-floor="1">Floor 1</button>
        <button class="add-floor-btn" id="addFloorBtn">+ Add Floor</button>
    </div>
    <div id="uploadSection">
        <div class="upload-area" id="uploadArea">
            <p style="font-size:32px;margin-bottom:8px">üì∑</p>
            <p><strong>Upload a background image (optional)</strong></p>
            <p style="font-size:12px;color:#888">Photo, blueprint, or sketch ‚Äî or start with a blank canvas</p>
            <input type="file" id="bgFile" accept="image/*" style="display:none">
        </div>
        <div style="text-align:center;margin-bottom:16px">
            <button type="button" class="btn-secondary" onclick="startBlank()">Start Blank Canvas</button>
        </div>
        <div class="import-panel">
            <h4>üì± Import from DivisionScan</h4>
            <button onclick="importFromServer()">Load from Server</button>
            <button onclick="document.getElementById('dsFile').click()">Load JSON File</button>
            <input type="file" id="dsFile" accept=".json" style="display:none">
        </div>
    </div>
    <div id="annotSection" class="hidden">
        <div class="toolbar">
            <button class="tool-btn active" data-tool="select" title="Select">üîç Select</button>
            <button class="tool-btn" data-tool="draw" title="Free Draw">‚úèÔ∏è Draw</button>
            <button class="tool-btn" data-tool="line" title="Line/Wall">üìè Wall</button>
            <button class="tool-btn" data-tool="text" title="Add Text">Aa Text</button>
            <div class="toolbar-sep"></div>
            <button class="tool-btn" id="undoBtn" title="Undo">‚Ü©Ô∏è</button>
            <button class="tool-btn" id="redoBtn" title="Redo">‚Ü™Ô∏è</button>
            <div class="toolbar-sep"></div>
            <button class="tool-btn" id="deleteBtn" title="Delete selected">üóëÔ∏è</button>
            <button class="tool-btn" id="clearBtn" title="Clear all">üßπ Clear</button>
            <div class="toolbar-sep"></div>
            <input type="color" id="colorPicker" value="#000000" title="Color">
            <select id="wallThickness" title="Wall Thickness"><option value="3">Thin</option><option value="6" selected>Normal</option><option value="10">Thick</option></select>
            <select id="unitSelect" title="Units"><option value="ft">Feet</option><option value="in">Inches</option></select>
            <select id="scaleSelect" title="Scale"><option value="8">1/4"=1'</option><option value="12" selected>1"=1'</option><option value="16">3/4"=1'</option></select>
        </div>
        <div class="symbol-bar">
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üî• Fire ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="facp">Alarm Panel (FACP)</button>
                <button class="symbol-item" data-symbol="annunciator">Annunciator</button>
                <button class="symbol-item" data-symbol="fdc">FDC</button>
                <button class="symbol-item" data-symbol="sprinkler">Sprinkler Riser</button>
                <button class="symbol-item" data-symbol="standpipe">Standpipe</button>
                <button class="symbol-item" data-symbol="extinguisher">Extinguisher</button>
                <button class="symbol-item" data-symbol="hydrant">Hydrant</button>
                <button class="symbol-item" data-symbol="pull">Pull Station</button>
                <button class="symbol-item" data-symbol="smoke">Smoke Detector</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üö™ Doors ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="door-l">Door (Left Swing)</button>
                <button class="symbol-item" data-symbol="door-r">Door (Right Swing)</button>
                <button class="symbol-item" data-symbol="door-d">Double Door</button>
                <button class="symbol-item" data-symbol="door-roll">Rollup/Overhead</button>
                <button class="symbol-item" data-symbol="door-slide">Sliding Door</button>
                <button class="symbol-item" data-symbol="door-revolve">Revolving Door</button>
                <div class="symbol-header">WINDOWS</div>
                <button class="symbol-item" data-symbol="win-3">Window 3'</button>
                <button class="symbol-item" data-symbol="win-4">Window 4'</button>
                <button class="symbol-item" data-symbol="win-6">Window 6'</button>
                <button class="symbol-item" data-symbol="exit">EXIT Sign</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">ü™ú Access ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="stairs">Stairs</button>
                <button class="symbol-item" data-symbol="elevator">Elevator</button>
                <button class="symbol-item" data-symbol="roof">Roof Access</button>
                <button class="symbol-item" data-symbol="knox">Knox Box</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö° Utilities ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="elec">Electrical Panel</button>
                <button class="symbol-item" data-symbol="elec-off">Elec Shutoff</button>
                <button class="symbol-item" data-symbol="gas-off">Gas Shutoff</button>
                <button class="symbol-item" data-symbol="water-off">Water Shutoff</button>
                <button class="symbol-item" data-symbol="hvac">HVAC</button>
                <button class="symbol-item" data-symbol="gen">Generator</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üõãÔ∏è Furniture ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="bed">Bed</button>
                <button class="symbol-item" data-symbol="sofa">Sofa</button>
                <button class="symbol-item" data-symbol="desk">Desk</button>
                <button class="symbol-item" data-symbol="table">Table</button>
                <button class="symbol-item" data-symbol="chair">Chair</button>
                <button class="symbol-item" data-symbol="bookshelf">Bookshelf</button>
                <button class="symbol-item" data-symbol="cubicle">Cubicle</button>
                <div class="symbol-header">KITCHEN</div>
                <button class="symbol-item" data-symbol="fridge">Refrigerator</button>
                <button class="symbol-item" data-symbol="stove">Stove/Range</button>
                <button class="symbol-item" data-symbol="sink">Kitchen Sink</button>
                <button class="symbol-item" data-symbol="dw">Dishwasher</button>
                <div class="symbol-header">BATHROOM</div>
                <button class="symbol-item" data-symbol="toilet">Toilet</button>
                <button class="symbol-item" data-symbol="tub">Bathtub</button>
                <button class="symbol-item" data-symbol="shower">Shower</button>
                <button class="symbol-item" data-symbol="bath-sink">Bath Sink</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üè™ Mercantile ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="clothes-rack">Clothes Rack</button>
                <button class="symbol-item" data-symbol="display-case">Display Case</button>
                <button class="symbol-item" data-symbol="shelf-aisle">Shelving Aisle</button>
                <button class="symbol-item" data-symbol="checkout">Checkout Counter</button>
                <button class="symbol-item" data-symbol="register">Cash Register</button>
                <button class="symbol-item" data-symbol="cart-corral">Cart Corral</button>
                <button class="symbol-item" data-symbol="freezer">Freezer Case</button>
                <button class="symbol-item" data-symbol="cooler">Walk-in Cooler</button>
                <button class="symbol-item" data-symbol="storage">Storage Room</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ôø ADA ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="handicap">Handicap Symbol</button>
                <button class="symbol-item" data-symbol="ada-park">ADA Parking</button>
                <button class="symbol-item" data-symbol="ada-ramp">Wheelchair Ramp</button>
                <button class="symbol-item" data-symbol="ada-restroom">ADA Restroom</button>
                <button class="symbol-item" data-symbol="ada-elev">ADA Elevator</button>
                <button class="symbol-item" data-symbol="auto-door">Auto Door Opener</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö†Ô∏è Obstructions ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="tree">Tree</button>
                <button class="symbol-item" data-symbol="shrub">Shrub/Bush</button>
                <button class="symbol-item" data-symbol="powerline">Power Lines</button>
                <button class="symbol-item" data-symbol="gas-line">Gas Line</button>
                <button class="symbol-item" data-symbol="water-line">Water Line</button>
                <button class="symbol-item" data-symbol="fence">Fence</button>
                <button class="symbol-item" data-symbol="bollard">Bollard</button>
                <button class="symbol-item" data-symbol="limited">Limited Access</button>
                <button class="symbol-item" data-symbol="no-access">No Access</button>
                <button class="symbol-item" data-symbol="overhead">Overhead Obstruction</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üîß Mechanical ‚ñº</button><div class="symbol-dropdown-content">
                <div class="symbol-header">SHOP</div>
                <button class="symbol-item" data-symbol="vehicle-lift">Vehicle Lift</button>
                <button class="symbol-item" data-symbol="tool-bench">Tool Bench</button>
                <button class="symbol-item" data-symbol="compressor">Air Compressor</button>
                <button class="symbol-item" data-symbol="welder">Welding Station</button>
                <button class="symbol-item" data-symbol="paint-booth">Paint Booth</button>
                <button class="symbol-item" data-symbol="oil-pit">Oil Change Pit</button>
                <div class="symbol-header">INDUSTRIAL</div>
                <button class="symbol-item" data-symbol="conveyor">Conveyor Belt</button>
                <button class="symbol-item" data-symbol="forklift">Forklift Area</button>
                <button class="symbol-item" data-symbol="crane">Overhead Crane</button>
                <button class="symbol-item" data-symbol="machine">Machinery</button>
                <button class="symbol-item" data-symbol="pallet">Pallet Rack</button>
                <button class="symbol-item" data-symbol="loading">Loading Dock</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚õ™ Assembly ‚ñº</button><div class="symbol-dropdown-content">
                <div class="symbol-header">CHURCH</div>
                <button class="symbol-item" data-symbol="pew">Pew/Seating Row</button>
                <button class="symbol-item" data-symbol="altar">Altar/Stage</button>
                <button class="symbol-item" data-symbol="pulpit">Pulpit/Podium</button>
                <button class="symbol-item" data-symbol="baptistry">Baptistry</button>
                <button class="symbol-item" data-symbol="choir">Choir Loft</button>
                <button class="symbol-item" data-symbol="organ">Organ/Piano</button>
                <div class="symbol-header">ASSEMBLY</div>
                <button class="symbol-item" data-symbol="seat-row">Seating Row</button>
                <button class="symbol-item" data-symbol="stage">Stage</button>
                <button class="symbol-item" data-symbol="bleachers">Bleachers</button>
                <button class="symbol-item" data-symbol="concession">Concession</button>
                <button class="symbol-item" data-symbol="ticket">Ticket Booth</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ò¢Ô∏è Hazmat ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="nfpa704">NFPA 704 Diamond</button>
                <button class="symbol-item" data-symbol="hazmat-store">Hazmat Storage</button>
                <button class="symbol-item" data-symbol="fuel-tank">Fuel Tank</button>
                <button class="symbol-item" data-symbol="propane">Propane Tank</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üß≠ Compass ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="compass-rose">Compass Rose</button>
                <button class="symbol-item" data-symbol="north-arrow">North Arrow</button>
                <button class="symbol-item" data-symbol="north-simple">Simple N</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üìç Other ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="dumpster">Dumpster</button>
                <button class="symbol-item" data-symbol="restroom">Restroom</button>
                <button class="symbol-item" data-symbol="office">Office</button>
                <button class="symbol-item" data-symbol="breakroom">Break Room</button>
                <button class="symbol-item" data-symbol="server-room">Server Room</button>
                <button class="symbol-item" data-symbol="mech-room">Mechanical Room</button>
                <button class="symbol-item" data-symbol="pool">Pool</button>
            </div></div>
        </div>
        <div class="canvas-wrapper"><canvas id="floor-canvas" width="900" height="600"></canvas></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
            <button type="button" class="btn-secondary" id="newImageBtn">üì∑ New Image</button>
            <button type="button" class="btn-secondary" id="exportPng">üíæ Export PNG</button>
        </div>
        <div class="legend"><h4>Common Symbols</h4><div class="legend-items">
            <span>üî¥ FACP ‚Äî Alarm Panel</span><span>üî¥ FDC ‚Äî Fire Dept Conn</span>
            <span>üîµ SR ‚Äî Sprinkler Riser</span><span>üîµ SP ‚Äî Standpipe</span>
            <span>üî¥ FE ‚Äî Extinguisher</span><span>üî¥ PS ‚Äî Pull Station</span>
            <span>üü† ELEC ‚Äî Electrical</span><span>üü† KNOX ‚Äî Knox Box</span>
            <span>üü° G ‚Äî Gas Shutoff</span><span>üîµ W ‚Äî Water Shutoff</span>
        </div></div>
    </div>
    <form id="floor-plan-form"><input type="hidden" name="floor_plan_data" id="floor-plan-data">
        <div class="form-actions">
            <button type="button" id="prev-btn" class="btn-secondary">‚Üê Previous</button>
            <button type="button" id="next-btn" class="btn-primary">Next ‚Üí Review & Submit</button>
        </div>
    </form>
</div>
</div>
<footer><img src="images/city-logo.png" alt="City" class="city-logo"><p>¬© 2026 City of Centerville Fire Department</p></footer>
<div class="nfpa-modal" id="nfpaModal"><div class="nfpa-form">
    <h3>NFPA 704 Diamond</h3>
    <label>Health (Blue, 0-4)</label><input type="number" id="nfpaH" min="0" max="4" value="0">
    <label>Fire (Red, 0-4)</label><input type="number" id="nfpaF" min="0" max="4" value="0">
    <label>Reactivity (Yellow, 0-4)</label><input type="number" id="nfpaR" min="0" max="4" value="0">
    <label>Special</label><input type="text" id="nfpaS" placeholder="W, OX, etc." maxlength="3">
    <div class="nfpa-actions"><button type="button" class="btn-primary" onclick="placeNFPA()">Place</button><button type="button" class="btn-secondary" onclick="document.getElementById('nfpaModal').classList.remove('show')">Cancel</button></div>
</div></div>
<div id="toast"></div>
<script>
let canvas,currentTool='select',currentFloor=1,floorCount=1,floorData={},history=[],historyIdx=-1,lineStartPoint=null;
const colorPicker=document.getElementById('colorPicker'),wallThickness=document.getElementById('wallThickness'),unitSelect=document.getElementById('unitSelect'),scaleSelect=document.getElementById('scaleSelect');
function getColor(){return colorPicker.value}function getWall(){return parseInt(wallThickness.value)}function getScale(){return parseInt(scaleSelect.value)}function getUnit(){return unitSelect.value}

function box(w,h,lbl,fill,tf){tf=tf||'white';var c=getColor(),il=fill===c;return new fabric.Group([new fabric.Rect({width:w,height:h,fill:il?'transparent':fill,stroke:il?fill:'#333',strokeWidth:il?2:1,rx:2,ry:2,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:Math.min(11,w/Math.max(lbl.length,1)*1.3),fill:il?fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}
function circ(r,lbl,fill,tf){tf=tf||'white';return new fabric.Group([new fabric.Circle({radius:r,fill:fill,stroke:'#333',strokeWidth:1,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:r*0.75,fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}

function makeDoor(w,dir){var th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white',stroke:'white',strokeWidth:0}));var sw=dir==='L'?-1:1;p.push(new fabric.Line([sw*-w/2,0,sw*-w/2,-w],{stroke:getColor(),strokeWidth:3}));p.push(new fabric.Circle({left:dir==='L'?-w/2-w:-w/2,top:-w,radius:w,startAngle:dir==='L'?0:Math.PI/2,endAngle:dir==='L'?Math.PI/2:Math.PI,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeDblDoor(w){var hw=w/2,th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));p.push(new fabric.Line([-hw,0,-hw,-hw],{stroke:getColor(),strokeWidth:3}));p.push(new fabric.Circle({left:-hw-hw,top:-hw,radius:hw,startAngle:0,endAngle:Math.PI/2,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));p.push(new fabric.Line([hw,0,hw,-hw],{stroke:getColor(),strokeWidth:3}));p.push(new fabric.Circle({left:0,top:-hw,radius:hw,startAngle:Math.PI/2,endAngle:Math.PI,fill:'transparent',stroke:'#333',strokeWidth:1,strokeDashArray:[4,3]}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeRollup(w){var th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));p.push(new fabric.Rect({left:-w/2,top:-4,width:w,height:8,fill:'transparent',stroke:'#333',strokeWidth:2}));for(var i=0;i<4;i++)p.push(new fabric.Line([-w/2+w*i/4,-4,-w/2+w*i/4,4],{stroke:'#333',strokeWidth:1}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeSlider(w){var th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-2,top:-th/2-2,width:w+4,height:th+4,fill:'white'}));p.push(new fabric.Line([-w/2,-2,w/4,-2],{stroke:getColor(),strokeWidth:3}));p.push(new fabric.Line([-w/4,2,w/2,2],{stroke:getColor(),strokeWidth:3}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeRevolving(w){var p=[];p.push(new fabric.Circle({radius:w/2,fill:'transparent',stroke:'#333',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Line([0,-w/2,0,w/2],{stroke:getColor(),strokeWidth:2,originX:'center',originY:'center'}));p.push(new fabric.Line([-w/2,0,w/2,0],{stroke:getColor(),strokeWidth:2,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeWindow(w){var th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-1,top:-th/2-1,width:w+2,height:th+2,fill:'white'}));p.push(new fabric.Line([-w/2,-th/4,w/2,-th/4],{stroke:'#0ea5e9',strokeWidth:2}));p.push(new fabric.Line([-w/2,th/4,w/2,th/4],{stroke:'#0ea5e9',strokeWidth:2}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeStairs(w,h){var p=[new fabric.Rect({width:w,height:h,fill:'transparent',stroke:'#333',strokeWidth:1,originX:'center',originY:'center'})];for(var i=1;i<6;i++)p.push(new fabric.Line([-w/2,-h/2+h*i/6,w/2,-h/2+h*i/6],{stroke:'#333',strokeWidth:1}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeStove(s){var p=[new fabric.Rect({width:s,height:s,fill:'#ddd',stroke:'#333',strokeWidth:1,rx:2,ry:2,originX:'center',originY:'center'})];var off=s*0.22;[[-off,-off],[off,-off],[-off,off],[off,off]].forEach(function(xy){p.push(new fabric.Circle({left:xy[0],top:xy[1],radius:s*0.12,fill:'transparent',stroke:'#555',strokeWidth:1,originX:'center',originY:'center'}))});return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeSink(w,h){return new fabric.Group([new fabric.Rect({width:w,height:h,fill:'#e0f2fe',stroke:'#333',strokeWidth:1,rx:4,ry:4,originX:'center',originY:'center'}),new fabric.Ellipse({rx:w*0.3,ry:h*0.28,fill:'transparent',stroke:'#0ea5e9',strokeWidth:1,originX:'center',originY:'center'})],{originX:'center',originY:'center'})}

function placeNFPA(){var h=parseInt(document.getElementById('nfpaH').value)||0,f=parseInt(document.getElementById('nfpaF').value)||0,r=parseInt(document.getElementById('nfpaR').value)||0,s=document.getElementById('nfpaS').value||'';var sz=40,hs=sz/2,p=[];
p.push(new fabric.Polygon([{x:-hs,y:0},{x:0,y:-hs},{x:0,y:hs}],{fill:'#2563eb',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:0,y:-hs},{x:hs,y:0},{x:0,y:0}],{fill:'#dc2626',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:0,y:-hs},{x:0,y:0},{x:-hs+hs,y:0}],{fill:'#dc2626',stroke:'#000',strokeWidth:0}));
p.push(new fabric.Polygon([{x:hs,y:0},{x:0,y:-hs},{x:0,y:hs}],{fill:'#eab308',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:-hs,y:0},{x:0,y:hs},{x:hs,y:0}],{fill:'#fff',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Text(String(h),{left:-hs/2,top:-2,fontSize:14,fontWeight:'bold',fill:'#fff',originX:'center',originY:'center'}));
p.push(new fabric.Text(String(f),{left:0,top:-hs/2+2,fontSize:14,fontWeight:'bold',fill:'#fff',originX:'center',originY:'center'}));
p.push(new fabric.Text(String(r),{left:hs/2,top:-2,fontSize:14,fontWeight:'bold',fill:'#000',originX:'center',originY:'center'}));
if(s)p.push(new fabric.Text(s,{left:0,top:hs/2-2,fontSize:10,fontWeight:'bold',fill:'#000',originX:'center',originY:'center'}));
var g=new fabric.Group(p,{left:canvas.width/2,top:canvas.height/2,originX:'center',originY:'center',nfpaData:{h:h,f:f,r:r,s:s}});
canvas.add(g).setActiveObject(g).renderAll();document.getElementById('nfpaModal').classList.remove('show');saveHistory();saveData()}

function makeCompassRose(){var sz=50,p=[];p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#dc2626',left:0,top:-sz/2,angle:0,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:0,top:sz/2,angle:180,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:sz/2,top:0,angle:90,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:-sz/2,top:0,angle:270,originX:'center',originY:'bottom'}));['N','S','E','W'].forEach(function(d,i){var pos=[{x:0,y:-sz/2-8},{x:0,y:sz/2+8},{x:sz/2+8,y:0},{x:-sz/2-8,y:0}][i];p.push(new fabric.Text(d,{left:pos.x,top:pos.y,fontSize:10,fontWeight:'bold',fill:d==='N'?'#dc2626':'#333',originX:'center',originY:'center'}))});p.push(new fabric.Circle({radius:4,fill:'#333',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeNorthArrow(){return new fabric.Group([new fabric.Triangle({width:20,height:40,fill:'#dc2626',originX:'center',originY:'center'}),new fabric.Text('N',{top:-28,fontSize:12,fontWeight:'bold',fill:'#dc2626',originX:'center',originY:'center'})],{originX:'center',originY:'center'})}

function getSymbol(type){var c=getColor(),s=getScale();var m={
'facp':function(){return box(40,30,'FACP','#dc2626')},'annunciator':function(){return box(32,24,'ANN','#dc2626')},'fdc':function(){return circ(14,'FDC','#dc2626')},'sprinkler':function(){return circ(11,'SR','#2563eb')},'standpipe':function(){return box(20,28,'SP','#2563eb')},'extinguisher':function(){return circ(9,'FE','#dc2626')},'hydrant':function(){return circ(11,'H','#dc2626')},'pull':function(){return box(14,18,'PS','#dc2626')},'smoke':function(){return circ(8,'SD','#666')},
'door-l':function(){return makeDoor(3*s,'L')},'door-r':function(){return makeDoor(3*s,'R')},'door-d':function(){return makeDblDoor(5*s)},'door-roll':function(){return makeRollup(8*s)},'door-slide':function(){return makeSlider(6*s)},'door-revolve':function(){return makeRevolving(3*s)},'win-3':function(){return makeWindow(3*s)},'win-4':function(){return makeWindow(4*s)},'win-6':function(){return makeWindow(6*s)},'exit':function(){return box(32,14,'EXIT','#22c55e')},
'stairs':function(){return makeStairs(4*s,7*s)},'elevator':function(){return box(4*s,4*s,'ELEV','#666')},'roof':function(){return box(28,28,'ROOF','#f97316')},'knox':function(){return box(18,14,'KNOX','#f97316')},
'elec':function(){return box(24,36,'ELEC','#f97316')},'elec-off':function(){return circ(11,'E','#f97316')},'gas-off':function(){return circ(11,'G','#eab308','#000')},'water-off':function(){return circ(11,'W','#2563eb')},'hvac':function(){return box(45,45,'HVAC','#666')},'gen':function(){return box(55,38,'GEN','#f97316')},
'bed':function(){return box(5*s,6*s,'BED',c)},'sofa':function(){return box(7*s,2.5*s,'SOFA',c)},'desk':function(){return box(5*s,2.5*s,'DESK',c)},'table':function(){return box(4*s,3*s,'TABLE',c)},'chair':function(){return box(2*s,2*s,'',c)},'bookshelf':function(){return box(6*s,1.5*s,'SHELF',c)},'cubicle':function(){return box(4*s,4*s,'CUB',c)},
'fridge':function(){return box(2.5*s,2.5*s,'REF',c)},'stove':function(){return makeStove(2.5*s)},'sink':function(){return makeSink(2.5*s,1.8*s)},'dw':function(){return box(2*s,2*s,'DW',c)},
'toilet':function(){return box(1.5*s,2*s,'WC',c)},'tub':function(){return box(5*s,2.5*s,'TUB','#bfdbfe','#000')},'shower':function(){return box(3*s,3*s,'SHW','#bfdbfe','#000')},'bath-sink':function(){return makeSink(2*s,1.5*s)},
'clothes-rack':function(){return box(6*s,1.5*s,'RACK',c)},'display-case':function(){return box(5*s,2*s,'DISPLAY',c)},'shelf-aisle':function(){return box(8*s,2*s,'AISLE',c)},'checkout':function(){return box(6*s,2*s,'CHECKOUT',c)},'register':function(){return box(2*s,2*s,'REG',c)},'cart-corral':function(){return box(4*s,3*s,'CARTS',c)},'freezer':function(){return box(6*s,3*s,'FREEZER','#bfdbfe','#000')},'cooler':function(){return box(5*s,5*s,'COOLER','#bfdbfe','#000')},'storage':function(){return box(5*s,4*s,'STORAGE',c)},
'handicap':function(){return circ(14,'‚ôø','#2563eb')},'ada-park':function(){return box(3*s,5*s,'‚ôø P','#2563eb')},'ada-ramp':function(){return box(5*s,2*s,'RAMP','#2563eb')},'ada-restroom':function(){return box(3*s,3*s,'‚ôøWC','#2563eb')},'ada-elev':function(){return box(4*s,4*s,'‚ôøEL','#2563eb')},'auto-door':function(){return box(3*s,2*s,'AUTO','#2563eb')},
'tree':function(){return circ(14,'üå≤','#22c55e')},'shrub':function(){return circ(10,'üåø','#22c55e')},'powerline':function(){return box(6*s,1*s,'‚ö°POWER','#f97316')},'gas-line':function(){return box(6*s,1*s,'GAS LINE','#eab308','#000')},'water-line':function(){return box(6*s,1*s,'WATER','#2563eb')},'fence':function(){return box(6*s,0.8*s,'FENCE','#666')},'bollard':function(){return circ(6,'B','#f97316')},'limited':function(){return box(3*s,2*s,'LTD','#f97316')},'no-access':function(){return box(3*s,2*s,'NO','#dc2626')},'overhead':function(){return box(4*s,2*s,'OVHD','#f97316')},
'vehicle-lift':function(){return box(8*s,4*s,'LIFT',c)},'tool-bench':function(){return box(6*s,2*s,'BENCH',c)},'compressor':function(){return box(3*s,3*s,'COMP',c)},'welder':function(){return box(3*s,3*s,'WELD',c)},'paint-booth':function(){return box(6*s,6*s,'PAINT',c)},'oil-pit':function(){return box(8*s,3*s,'PIT',c)},'conveyor':function(){return box(10*s,2*s,'CONVEYOR',c)},'forklift':function(){return box(4*s,2*s,'FORK',c)},'crane':function(){return box(10*s,3*s,'CRANE',c)},'machine':function(){return box(4*s,4*s,'MACH',c)},'pallet':function(){return box(8*s,3*s,'PALLET',c)},'loading':function(){return box(8*s,4*s,'DOCK',c)},
'pew':function(){return box(8*s,1.5*s,'PEW',c)},'altar':function(){return box(6*s,3*s,'ALTAR',c)},'pulpit':function(){return box(3*s,3*s,'PULPIT',c)},'baptistry':function(){return circ(2*s,'BAPT','#bfdbfe','#000')},'choir':function(){return box(6*s,3*s,'CHOIR',c)},'organ':function(){return box(5*s,3*s,'ORGAN',c)},'seat-row':function(){return box(10*s,1.5*s,'SEATS',c)},'stage':function(){return box(10*s,5*s,'STAGE',c)},'bleachers':function(){return box(8*s,4*s,'BLEACH',c)},'concession':function(){return box(5*s,3*s,'FOOD',c)},'ticket':function(){return box(3*s,3*s,'TICKET',c)},
'hazmat-store':function(){return box(4*s,4*s,'HAZ','#eab308','#000')},'fuel-tank':function(){return circ(2*s,'FUEL','#f97316')},'propane':function(){return circ(1.5*s,'LP','#f97316')},
'compass-rose':function(){return makeCompassRose()},'north-arrow':function(){return makeNorthArrow()},'north-simple':function(){return new fabric.Text('N‚Üë',{fontSize:24,fontWeight:'bold',fill:'#dc2626',originX:'center',originY:'center'})},
'dumpster':function(){return box(4*s,3*s,'DUMP','#666')},'restroom':function(){return box(3*s,3*s,'WC',c)},'office':function(){return box(5*s,4*s,'OFFICE',c)},'breakroom':function(){return box(5*s,4*s,'BREAK',c)},'server-room':function(){return box(4*s,4*s,'SERVER',c)},'mech-room':function(){return box(5*s,4*s,'MECH',c)},'pool':function(){return box(8*s,5*s,'POOL','#bfdbfe','#000')}
};if(type==='nfpa704'){document.getElementById('nfpaModal').classList.add('show');return null}return m[type]?m[type]():box(30,30,type.toUpperCase().slice(0,4),c)}

function initCanvas(bgUrl){canvas=new fabric.Canvas('floor-canvas',{preserveObjectStacking:true,backgroundColor:'transparent'});if(bgUrl){fabric.Image.fromURL(bgUrl,function(img){img.scaleToWidth(canvas.width);img.set({selectable:false,evented:false,isBg:true});canvas.add(img);canvas.sendToBack(img);canvas.renderAll()})}setupEvents();saveHistory()}
function setupEvents(){canvas.on('object:modified',function(){saveHistory();saveData()});canvas.on('mouse:down',function(o){if(currentTool==='line'&&o.pointer){if(!lineStartPoint){lineStartPoint={x:o.pointer.x,y:o.pointer.y}}else{var line=new fabric.Line([lineStartPoint.x,lineStartPoint.y,o.pointer.x,o.pointer.y],{stroke:getColor(),strokeWidth:getWall(),selectable:true});canvas.add(line);var dx=o.pointer.x-lineStartPoint.x,dy=o.pointer.y-lineStartPoint.y,len=Math.sqrt(dx*dx+dy*dy)/getScale(),unit=getUnit(),dim=unit==='ft'?len.toFixed(1)+"'":(len*12).toFixed(0)+'"',mid={x:(lineStartPoint.x+o.pointer.x)/2,y:(lineStartPoint.y+o.pointer.y)/2};canvas.add(new fabric.Text(dim,{left:mid.x,top:mid.y-12,fontSize:10,fill:'#555',backgroundColor:'rgba(255,255,255,0.8)',originX:'center'}));lineStartPoint=null;saveHistory();saveData()}}if(currentTool==='text'&&o.pointer){var txt=prompt('Enter text:');if(txt){canvas.add(new fabric.IText(txt,{left:o.pointer.x,top:o.pointer.y,fontSize:14,fill:getColor(),fontFamily:'Arial'}));saveHistory();saveData()}}});canvas.on('path:created',function(){saveHistory();saveData()})}

function saveHistory(){historyIdx++;history=history.slice(0,historyIdx);history.push(JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData'])));if(history.length>50){history.shift();historyIdx--}}
function undo(){if(historyIdx<=0)return;historyIdx--;canvas.loadFromJSON(history[historyIdx],function(){canvas.renderAll()})}
function redo(){if(historyIdx>=history.length-1)return;historyIdx++;canvas.loadFromJSON(history[historyIdx],function(){canvas.renderAll()})}

function saveData(){if(!canvas)return;floorData[currentFloor]=JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData']));var all={};for(var f in floorData)all[f]=floorData[f];try{var saved=JSON.parse(localStorage.getItem('preFirePlan')||'{}');saved.floor_plan_data=JSON.stringify(all);localStorage.setItem('preFirePlan',JSON.stringify(saved))}catch(e){}}
function loadSavedData(){try{var saved=JSON.parse(localStorage.getItem('preFirePlan')||'{}');if(saved.floor_plan_data){var all=JSON.parse(saved.floor_plan_data);for(var f in all)floorData[f]=all[f];floorCount=Math.max(1,Math.max.apply(null,Object.keys(floorData).map(Number)));renderFloorTabs();if(floorData[1]){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');canvas=new fabric.Canvas('floor-canvas',{preserveObjectStacking:true,backgroundColor:'transparent'});setupEvents();canvas.loadFromJSON(floorData[1],function(){canvas.renderAll();saveHistory()})}}}catch(e){console.error(e)}}

function renderFloorTabs(){var tabs=document.getElementById('floorTabs'),html='';for(var i=1;i<=floorCount;i++)html+='<button class="floor-tab'+(i===currentFloor?' active':'')+'" data-floor="'+i+'">Floor '+i+'</button>';html+='<button class="add-floor-btn" id="addFloorBtn">+ Add Floor</button>';tabs.innerHTML=html;tabs.querySelectorAll('.floor-tab').forEach(function(b){b.onclick=function(){switchFloor(parseInt(b.dataset.floor))}});document.getElementById('addFloorBtn').onclick=addFloor}
function switchFloor(f){if(canvas)floorData[currentFloor]=JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData']));currentFloor=f;renderFloorTabs();if(floorData[f]){canvas.loadFromJSON(floorData[f],function(){canvas.renderAll()})}else{canvas.clear();canvas.backgroundColor='transparent';canvas.renderAll()}saveHistory()}
function addFloor(){floorCount++;switchFloor(floorCount);toast('Floor '+floorCount+' added')}

document.querySelectorAll('.tool-btn[data-tool]').forEach(function(b){b.onclick=function(){document.querySelectorAll('.tool-btn[data-tool]').forEach(function(x){x.classList.remove('active')});b.classList.add('active');currentTool=b.dataset.tool;lineStartPoint=null;canvas.isDrawingMode=currentTool==='draw';if(canvas.isDrawingMode){canvas.freeDrawingBrush.color=getColor();canvas.freeDrawingBrush.width=2}canvas.selection=currentTool==='select'}});
colorPicker.onchange=function(){if(canvas&&canvas.isDrawingMode)canvas.freeDrawingBrush.color=getColor()};
document.querySelectorAll('.symbol-item').forEach(function(b){b.onclick=function(e){e.stopPropagation();var type=b.dataset.symbol,obj=getSymbol(type);if(!obj)return;obj.set({left:canvas.width/2+Math.random()*40-20,top:canvas.height/2+Math.random()*40-20});canvas.add(obj).setActiveObject(obj).renderAll();saveHistory();saveData()}});
document.getElementById('undoBtn').onclick=undo;document.getElementById('redoBtn').onclick=redo;
document.getElementById('deleteBtn').onclick=function(){var sel=canvas.getActiveObjects();if(sel.length){sel.forEach(function(o){if(!o.isBg)canvas.remove(o)});canvas.discardActiveObject();canvas.renderAll();saveHistory();saveData()}};
document.getElementById('clearBtn').onclick=function(){if(!confirm('Clear all objects?'))return;var bg=canvas.getObjects().find(function(o){return o.isBg});canvas.clear();canvas.backgroundColor='transparent';if(bg)canvas.add(bg);canvas.renderAll();saveHistory();saveData()};
document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undo()}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();redo()}if(e.key==='Delete'||e.key==='Backspace'){if(document.activeElement.tagName==='INPUT'||document.activeElement.tagName==='TEXTAREA')return;document.getElementById('deleteBtn').click()}});
document.getElementById('uploadArea').onclick=function(){document.getElementById('bgFile').click()};
document.getElementById('bgFile').onchange=function(){if(this.files[0]){var reader=new FileReader();reader.onload=function(e){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(e.target.result)};reader.readAsDataURL(this.files[0])}};
function startBlank(){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(null)}
document.getElementById('newImageBtn').onclick=function(){var fi=document.getElementById('bgFile');fi.value='';fi.onchange=function(){if(this.files[0]){var reader=new FileReader();reader.onload=function(e){var bg=canvas.getObjects().find(function(o){return o.isBg});if(bg)canvas.remove(bg);fabric.Image.fromURL(e.target.result,function(img){img.scaleToWidth(canvas.width);img.set({selectable:false,evented:false,isBg:true});canvas.add(img);canvas.sendToBack(img);canvas.renderAll();saveHistory();saveData()})};reader.readAsDataURL(this.files[0])}};fi.click()};
document.getElementById('exportPng').onclick=function(){var a=document.createElement('a');a.download='floor-plan-'+currentFloor+'.png';a.href=canvas.toDataURL({format:'png',quality:1});a.click();toast('PNG exported')};
document.getElementById('dsFile').onchange=function(){if(this.files[0]){var reader=new FileReader();reader.onload=function(e){try{var d=JSON.parse(e.target.result);if(d.scan)renderDivisionScan(d.scan,[],[]);else renderDivisionScan(d,[],[])}catch(err){toast('Invalid JSON file')}};reader.readAsText(this.files[0])}};
function importFromServer(){
fetch('/api/divisionscan/plans').then(function(r){return r.json()}).then(function(d){
if(!d.plans||!d.plans.length){toast('No scans found on server');return}
if(d.plans.length===1){loadScanById(d.plans[0].id);return}
// Show picker modal for multiple plans
var modal=document.createElement('div');modal.id='scanPickerModal';
modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:2000;display:flex;justify-content:center;align-items:center';
var box='<div style="background:#fff;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">';
box+='<h3 style="margin:0 0 4px;color:#1e3a5f">Import from DivisionScan</h3>';
box+='<p style="color:#888;font-size:12px;margin:0 0 16px">Select a scan to import into the floor plan</p>';
d.plans.forEach(function(p){
var dt=p.scan_date?new Date(p.scan_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
var area=p.total_area?Math.round(p.total_area)+' ft¬≤':'';
box+='<div onclick="loadScanById(\''+p.id+'\');document.getElementById(\'scanPickerModal\').remove()" style="padding:12px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .15s" onmouseover="this.style.borderColor=\'#1e3a5f\';this.style.background=\'#f0f9ff\'" onmouseout="this.style.borderColor=\'#e2e8f0\';this.style.background=\'#fff\'">';
box+='<div style="font-weight:600;color:#1e3a5f">'+escH(p.building_name||'Unnamed')+'</div>';
if(p.building_address)box+='<div style="font-size:12px;color:#666">'+escH(p.building_address)+'</div>';
box+='<div style="font-size:11px;color:#999;margin-top:4px">Floor '+escH(p.floor||'1')+' ¬∑ '+area+' ¬∑ '+dt+' ¬∑ '+escH(p.department||'CFD')+'</div>';
box+='</div>';
});
box+='<div style="text-align:center;margin-top:12px"><button onclick="document.getElementById(\'scanPickerModal\').remove()" style="padding:8px 20px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;font-size:13px">Cancel</button></div>';
box+='</div>';
modal.innerHTML=box;modal.onclick=function(e){if(e.target===modal)modal.remove()};
document.body.appendChild(modal);
}).catch(function(e){toast('Could not connect to server')})
}
function escH(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function loadScanById(id){
toast('Loading scan...');
fetch('/api/divisionscan/plan/'+id).then(function(r){return r.json()}).then(function(p){
if(p.success&&p.scan&&p.scan.scan_json){renderDivisionScan(JSON.parse(p.scan.scan_json),p.markers||[],p.annotations||[])}
else{toast('No scan data found')}
}).catch(function(){toast('Failed to load scan')})
}
function renderDivisionScan(data,markers,annotations){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(null);var walls=data.walls||[],doors=data.doors||[],wins=data.windows||[],objs=data.objects||[],rooms=data.rooms||[];var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;walls.forEach(function(w){minX=Math.min(minX,w.startX,w.endX);minY=Math.min(minY,w.startY,w.endY);maxX=Math.max(maxX,w.startX,w.endX);maxY=Math.max(maxY,w.startY,w.endY)});if(!walls.length){minX=0;minY=0;maxX=100;maxY=100}var bw=maxX-minX||1,bh=maxY-minY||1,sc=Math.min((canvas.width-80)/bw,(canvas.height-80)/bh),ox=40-minX*sc,oy=40-minY*sc;
// Room labels
rooms.forEach(function(r){if(!r.name||!r.centerX)return;var tx=r.centerX*sc+ox,ty=r.centerY*sc+oy;var t=new fabric.Text(r.name+(r.area>10?'\n'+Math.round(r.area)+' ft¬≤':''),{left:tx,top:ty,fontSize:11,fill:'rgba(52,152,219,0.5)',fontFamily:'-apple-system,sans-serif',textAlign:'center',originX:'center',originY:'center',selectable:true});canvas.add(t)});
// Walls
walls.forEach(function(w){canvas.add(new fabric.Line([w.startX*sc+ox,w.startY*sc+oy,w.endX*sc+ox,w.endY*sc+oy],{stroke:'#333',strokeWidth:getWall(),selectable:true}))});
// Doors
doors.forEach(function(d){var x=(d.x||0)*sc+ox,y=(d.y||0)*sc+oy,obj=makeDoor((d.width||3)*sc,'L');obj.set({left:x,top:y});canvas.add(obj)});
// Windows
wins.forEach(function(w){var x=(w.x||0)*sc+ox,y=(w.y||0)*sc+oy,obj=makeWindow((w.width||3)*sc);obj.set({left:x,top:y});canvas.add(obj)});
// Furniture/Objects
objs.forEach(function(o){var x=(o.x||0)*sc+ox,y=(o.y||0)*sc+oy,w=(o.width||3)*sc,h=(o.depth||3)*sc;var catColors={'toilet':'#4ECDC4','bathtub':'#4ECDC4','sink':'#4ECDC4','stove':'#FF6B6B','oven':'#FF6B6B','refrigerator':'#45B7D1','bed':'#DDA0DD','sofa':'#F4A460','table':'#D2B48C','chair':'#D2B48C','television':'#708090','washerDryer':'#87CEEB','dishwasher':'#45B7D1','storage':'#BDB76B','fireplace':'#CD853F','stairs':'#A9A9A9'};
var col=catColors[o.category]||'#999';var lbl=o.label||o.category||'?';
var rect=new fabric.Rect({width:w,height:h,fill:col+'33',stroke:col,strokeWidth:1,rx:2,ry:2});
var txt=new fabric.Text(lbl,{fontSize:Math.min(10,w*0.3),fill:col,fontFamily:'-apple-system,sans-serif',textAlign:'center',originX:'center',originY:'center'});
var grp=new fabric.Group([rect,txt],{left:x-w/2,top:y-h/2,selectable:true,angle:o.rotation?o.rotation*180/Math.PI:0});
canvas.add(grp)});
// Markers from server
if(markers&&markers.length){markers.forEach(function(m){var x=m.x*sc+ox,y=m.y*sc+oy;var icon=m.marker_name||m.marker_type_id||'‚ö†Ô∏è';var t=new fabric.Text('üìç'+icon,{left:x,top:y,fontSize:10,fill:'#c0392b',fontFamily:'-apple-system,sans-serif',originX:'center',originY:'center',selectable:true});canvas.add(t)})}
// Annotations from server
if(annotations&&annotations.length){annotations.forEach(function(a){if(!a.points_json)return;try{var pts=JSON.parse(a.points_json);if(pts.length<2)return;var pathStr='M '+pts[0].x*sc+ox+' '+pts[0].y*sc+oy;for(var i=1;i<pts.length;i++)pathStr+=' L '+pts[i].x*sc+ox+' '+pts[i].y*sc+oy;var p=new fabric.Path(pathStr,{fill:'',stroke:a.color_hex||'#FF0000',strokeWidth:a.line_width||2,selectable:true});canvas.add(p)}catch(e){}})}
canvas.renderAll();saveHistory();saveData();toast('DivisionScan imported!')}
function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(window._tt);window._tt=setTimeout(function(){t.style.display='none'},2500)}
document.getElementById('prev-btn').onclick=function(){saveData();window.location.href='page10-site-plan.html'};
document.getElementById('next-btn').onclick=function(){saveData();toast('Saved');setTimeout(function(){window.location.href='page12-submit.html'},500)};
window.addEventListener('load',loadSavedData);
</script>

<!-- Pre-Plan Save/Resume Toolbar -->
<style>
.pp-toolbar{position:fixed;bottom:0;left:0;right:0;background:#1a1a1e;border-top:2px solid #c0392b;padding:8px 12px;display:flex;align-items:center;justify-content:center;gap:8px;z-index:9999;flex-wrap:wrap}
.pp-toolbar .pp-btn{padding:8px 14px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap}
.pp-btn-save{background:#27ae60;color:#fff}.pp-btn-save:hover{background:#2ecc71}
.pp-btn-file{background:#2980b9;color:#fff}.pp-btn-file:hover{background:#3498db}
.pp-btn-load{background:#8e44ad;color:#fff}.pp-btn-load:hover{background:#9b59b6}
.pp-btn-link{background:#e67e22;color:#fff}.pp-btn-link:hover{background:#f39c12}
.pp-modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:none;justify-content:center;align-items:center}
.pp-modal-bg.show{display:flex}
.pp-modal{background:#24242a;border-radius:12px;padding:24px;max-width:420px;width:90%;color:#fff;border:1px solid #444;position:relative}
.pp-modal h3{color:#e67e22;margin-bottom:12px;font-size:16px}
.pp-modal p{color:#aaa;font-size:13px;margin-bottom:12px;line-height:1.5}
.pp-modal .pp-code{background:#1a1a1e;border:2px solid #e67e22;border-radius:8px;padding:14px;text-align:center;font-size:28px;letter-spacing:6px;font-weight:700;color:#e67e22;font-family:monospace;margin:12px 0;user-select:all}
.pp-modal .pp-link{background:#1a1a1e;border:1px solid #555;border-radius:6px;padding:10px;font-size:12px;color:#3498db;word-break:break-all;margin:8px 0;cursor:pointer;user-select:all}
.pp-modal .pp-link:hover{background:#2a2a30}
.pp-modal-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.pp-modal .pp-close{position:absolute;top:10px;right:14px;background:none;border:none;color:#888;font-size:20px;cursor:pointer}
.pp-modal .pp-close:hover{color:#fff}
.pp-modal input[type=text]{background:#1a1a1e;border:1px solid #555;border-radius:6px;padding:10px;color:#fff;font-size:14px;width:100%;margin:8px 0}
.pp-modal input[type=file]{display:none}
.pp-toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:6px;font-size:12px;font-weight:600;z-index:10001;display:none;box-shadow:0 2px 12px rgba(0,0,0,0.4)}
.pp-toast.success{background:#27ae60;color:#fff}.pp-toast.error{background:#c0392b;color:#fff}
.pp-saved-indicator{color:#27ae60;font-size:11px;display:none;align-items:center;gap:4px}
@media(max-width:480px){.pp-toolbar{gap:4px;padding:6px 8px}.pp-toolbar .pp-btn{padding:6px 10px;font-size:11px}}
</style>

<div class="pp-toolbar" id="ppToolbar">
  <span class="pp-saved-indicator" id="ppSaved">‚úì Auto-saved</span>
  <button class="pp-btn pp-btn-save" onclick="ppSaveCloud()" title="Save to cloud & get a link">‚òÅÔ∏è Save to Cloud</button>
  <button class="pp-btn pp-btn-file" onclick="ppExportFile()" title="Download progress as a file">üì• Export File</button>
  <button class="pp-btn pp-btn-load" onclick="ppShowLoadModal()" title="Load from file or resume link">üìÇ Load / Resume</button>
</div>

<div class="pp-modal-bg" id="ppModalBg" onclick="if(event.target===this)ppCloseModal()">
  <div class="pp-modal" id="ppModal"></div>
</div>
<div class="pp-toast" id="ppToast"></div>

<script>
(function(){
  // Auto-resume from URL parameter
  const params = new URLSearchParams(window.location.search);
  const resumeCode = params.get('resume');
  if (resumeCode) {
    fetch('/api/load-draft?code=' + resumeCode.toUpperCase())
      .then(r => r.json())
      .then(d => {
        if (d.success && d.data) {
          localStorage.setItem('preFirePlan', JSON.stringify(d.data));
          ppToast('Progress loaded from cloud!', 'success');
          // Clean URL
          const clean = window.location.pathname;
          history.replaceState(null, '', clean);
          // Reload to pick up the data
          setTimeout(() => location.reload(), 800);
        }
      })
      .catch(() => {});
  }

  // Show auto-save indicator when localStorage changes
  const origSave = localStorage.setItem.bind(localStorage);
  const savedEl = document.getElementById('ppSaved');
  
  // Periodic check for data
  let lastData = localStorage.getItem('preFirePlan');
  setInterval(() => {
    const cur = localStorage.getItem('preFirePlan');
    if (cur !== lastData) {
      lastData = cur;
      savedEl.style.display = 'flex';
      clearTimeout(window._ppSavedTimeout);
      window._ppSavedTimeout = setTimeout(() => { savedEl.style.display = 'none'; }, 2000);
    }
  }, 1000);
})();

function ppGetData() {
  try { return JSON.parse(localStorage.getItem('preFirePlan') || '{}'); } catch(e) { return {}; }
}

function ppSaveCloud() {
  const data = ppGetData();
  if (!data || Object.keys(data).length === 0) { ppToast('No pre-plan data to save', 'error'); return; }
  
  // Check if we already have a code saved
  const existingCode = localStorage.getItem('ppCloudCode') || undefined;
  
  const modal = document.getElementById('ppModal');
  modal.innerHTML = '<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚òÅÔ∏è Saving to Cloud...</h3><p>Please wait...</p>';
  document.getElementById('ppModalBg').classList.add('show');

  fetch('/api/save-draft', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ data, code: existingCode })
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      localStorage.setItem('ppCloudCode', d.code);
      const link = window.location.origin + '/index.html?resume=' + d.code;
      modal.innerHTML = '<button class="pp-close" onclick="ppCloseModal()">&times;</button>' +
        '<h3>‚úÖ Saved to Cloud!</h3>' +
        '<p>Use the code or link below to resume on any device. This save expires in 7 days.</p>' +
        '<div class="pp-code">' + d.code + '</div>' +
        '<div class="pp-link" onclick="ppCopyLink(this)" title="Click to copy">' + link + '</div>' +
        '<div class="pp-modal-actions">' +
          '<button class="pp-btn pp-btn-link" onclick="ppCopyLink(document.querySelector('.pp-link'))">üìã Copy Link</button>' +
          '<button class="pp-btn pp-btn-save" onclick="ppCloseModal()">Done</button>' +
        '</div>';
    } else {
      modal.innerHTML = '<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚ùå Save Failed</h3><p>' + (d.error || 'Unknown error') + '</p>';
    }
  })
  .catch(err => {
    modal.innerHTML = '<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚ùå Save Failed</h3><p>' + err.message + '</p>';
  });
}

function ppCopyLink(el) {
  const text = el?.textContent || '';
  navigator.clipboard.writeText(text).then(() => ppToast('Copied to clipboard!', 'success')).catch(() => {
    // Fallback
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    ppToast('Copied!', 'success');
  });
}

function ppExportFile() {
  const data = ppGetData();
  if (!data || Object.keys(data).length === 0) { ppToast('No pre-plan data to export', 'error'); return; }
  
  const name = data.business_name || 'preplan';
  const safeName = name.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').substring(0, 30);
  const exportObj = {
    _type: 'centerville-preplan-draft',
    _exported: new Date().toISOString(),
    _business: data.business_name || '',
    data: data
  };
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = safeName + '-draft-' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  ppToast('Draft exported!', 'success');
}

function ppShowLoadModal() {
  const modal = document.getElementById('ppModal');
  modal.innerHTML = '<button class="pp-close" onclick="ppCloseModal()">&times;</button>' +
    '<h3>üìÇ Load / Resume Pre-Plan</h3>' +
    '<p><strong>Option 1:</strong> Enter a resume code</p>' +
    '<input type="text" id="ppResumeCode" placeholder="Enter 6-character code" maxlength="6" style="text-transform:uppercase;text-align:center;letter-spacing:4px;font-size:18px">' +
    '<button class="pp-btn pp-btn-link" onclick="ppLoadFromCode()" style="width:100%;justify-content:center;margin-bottom:16px">Load from Code</button>' +
    '<p><strong>Option 2:</strong> Load from exported file</p>' +
    '<button class="pp-btn pp-btn-file" onclick="document.getElementById('ppFileInput').click()" style="width:100%;justify-content:center">üìÅ Choose File</button>' +
    '<input type="file" id="ppFileInput" accept=".json" onchange="ppLoadFromFile(this)">';
  document.getElementById('ppModalBg').classList.add('show');
  setTimeout(() => document.getElementById('ppResumeCode')?.focus(), 100);
}

function ppLoadFromCode() {
  const code = document.getElementById('ppResumeCode')?.value?.trim().toUpperCase();
  if (!code || code.length < 4) { ppToast('Enter a valid code', 'error'); return; }

  fetch('/api/load-draft?code=' + code)
    .then(r => r.json())
    .then(d => {
      if (d.success && d.data) {
        localStorage.setItem('preFirePlan', JSON.stringify(d.data));
        localStorage.setItem('ppCloudCode', code);
        ppToast('Pre-plan loaded! Refreshing...', 'success');
        ppCloseModal();
        setTimeout(() => location.reload(), 800);
      } else {
        ppToast(d.error || 'Code not found or expired', 'error');
      }
    })
    .catch(err => ppToast('Load failed: ' + err.message, 'error'));
}

function ppLoadFromFile(input) {
  const file = input.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const obj = JSON.parse(e.target.result);
      const data = obj.data || obj;
      if (typeof data !== 'object') throw new Error('Invalid file');
      localStorage.setItem('preFirePlan', JSON.stringify(data));
      ppToast('Pre-plan loaded from file! Refreshing...', 'success');
      ppCloseModal();
      setTimeout(() => location.reload(), 800);
    } catch(err) {
      ppToast('Invalid file format', 'error');
    }
  };
  reader.readAsText(file);
}

function ppCloseModal() {
  document.getElementById('ppModalBg').classList.remove('show');
}

function ppToast(msg, type) {
  const t = document.getElementById('ppToast');
  t.textContent = msg;
  t.className = 'pp-toast ' + (type || 'success');
  t.style.display = 'block';
  clearTimeout(window._ppTT);
  window._ppTT = setTimeout(() => { t.style.display = 'none'; }, 3000);
}
</script>
</body>
</html>
