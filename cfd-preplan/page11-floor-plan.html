<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Pre-Fire Plan: Floor Plan</title>
<link rel="stylesheet" href="styles-preplan.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
.floor-tabs{display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap}
.floor-tab{padding:8px 16px;background:#e2e8f0;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;font-size:13px}
.floor-tab:hover{background:#cbd5e1}.floor-tab.active{background:#1e3a5f;color:white}
.add-floor-btn{background:#22c55e;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
.upload-area{border:2px dashed #cbd5e1;border-radius:12px;padding:40px;text-align:center;cursor:pointer;margin-bottom:20px;transition:all .2s}
.upload-area:hover{border-color:#1e3a5f;background:#f8fafc}
.hidden{display:none!important}
.canvas-wrapper{border:2px solid #cbd5e1;border-radius:12px;overflow:hidden;margin-bottom:12px;position:relative;touch-action:none}
.canvas-wrapper .lower-canvas{
    background-image:
        linear-gradient(to right,#e0e7ef 1px,transparent 1px),
        linear-gradient(to bottom,#e0e7ef 1px,transparent 1px),
        linear-gradient(to right,#c7d2e0 1px,transparent 1px),
        linear-gradient(to bottom,#c7d2e0 1px,transparent 1px);
    background-size:10px 10px,10px 10px,50px 50px,50px 50px;
    background-color:#fff;
    touch-action:none;
}
.canvas-wrapper canvas{touch-action:none}
.toolbar{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.tool-btn{padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all .15s;touch-action:manipulation}
.tool-btn:hover{background:#e2e8f0}.tool-btn.active{background:#1e3a5f;color:white;border-color:#1e3a5f}
.toolbar-sep{width:1px;height:24px;background:#cbd5e1;margin:0 2px}
.toolbar select,.toolbar input[type=color]{padding:4px;border:1px solid #cbd5e1;border-radius:4px;font-size:11px}
.toolbar input[type=color]{width:28px;height:26px;padding:1px;cursor:pointer}
.symbol-bar{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap}
.symbol-dropdown{position:relative;display:inline-block}
.symbol-dropdown-btn{padding:6px 10px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap}
.symbol-dropdown-btn:hover{background:#e2e8f0}
.symbol-dropdown-content{display:none;position:absolute;left:0;top:100%;background:#fff;border:1px solid #cbd5e1;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:100;min-width:160px;max-height:300px;overflow-y:auto;padding:4px}
.symbol-dropdown:hover .symbol-dropdown-content{display:block}
.symbol-item{display:block;width:100%;text-align:left;padding:6px 10px;border:none;background:none;cursor:pointer;font-size:11px;border-radius:4px;white-space:nowrap}
.symbol-item:hover{background:#e2e8f0}
.symbol-header{padding:6px 10px;font-weight:700;font-size:10px;color:#666;text-transform:uppercase;border-bottom:1px solid #e2e8f0;margin-top:4px}
.legend{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-top:12px}
.legend h4{margin:0 0 8px;font-size:13px;color:#1e3a5f}
.legend-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:4px;font-size:11px;color:#555}
.nfpa-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:none;justify-content:center;align-items:center}
.nfpa-modal.show{display:flex}
.nfpa-form{background:#fff;border-radius:12px;padding:24px;max-width:320px;width:90%}
.nfpa-form h3{margin:0 0 12px}
.nfpa-form label{display:block;margin:8px 0 4px;font-size:13px;font-weight:600}
.nfpa-form input,.nfpa-form select{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px}
.nfpa-form .nfpa-actions{display:flex;gap:8px;margin-top:16px}
.box-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:none;justify-content:center;align-items:center}
.box-modal.show{display:flex}
.box-form{background:#fff;border-radius:12px;padding:24px;max-width:320px;width:90%}
.box-form h3{margin:0 0 12px}
.box-form label{display:block;margin:8px 0 4px;font-size:13px;font-weight:600}
.box-form input{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:14px}
.box-form .box-actions{display:flex;gap:8px;margin-top:16px}
.import-panel{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:12px;margin-bottom:12px}
.import-panel h4{margin:0 0 8px;color:#0369a1;font-size:13px}
.import-panel button{padding:6px 12px;border:1px solid #0ea5e9;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-right:6px}
.import-panel button:hover{background:#e0f2fe}
.back-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;margin-bottom:10px;color:#555;transition:all .15s}
.back-btn:hover{background:#cbd5e1;color:#333}
.wall-preview{pointer-events:none;position:absolute;top:0;left:0;z-index:50}
#toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:8px;font-size:13px;font-weight:600;z-index:1000;display:none;background:#22c55e;color:#fff}
</style>
</head>
<body>
<div class="page-wrapper">
    <div class="container">
        <header class="report-header">
            <div class="header-top">
                <img src="images/cfd-logo.png" alt="Centerville Fire Department" class="patch-logo">
                <div class="header-text"><h1>Centerville Fire Department</h1><h2>Pre-Fire Plan Data Sheet</h2></div>
            </div>
        </header>
        <div class="progress-indicator">Page 11 of 12: Floor Plan <span style="float:right;color:#888;font-size:10px">v1.2</span></div>
        <div class="progress-bar-container"><div class="progress-bar" style="width:91.66%"></div></div>
    <div class="preplan-header"><h3>Page 11: Floor Plan Drawing</h3></div>
    <div class="floor-tabs" id="floorTabs">
        <button class="floor-tab active" data-floor="1">Floor 1</button>
        <button class="add-floor-btn" id="addFloorBtn">+ Add Floor</button>
    </div>

    <!-- UPLOAD / START SECTION -->
    <div id="uploadSection">
        <div class="upload-area" id="uploadArea">
            <p style="font-size:32px;margin-bottom:8px">üì∑</p>
            <p><strong>Upload a background image (optional)</strong></p>
            <p style="font-size:12px;color:#888">Photo, blueprint, or sketch ‚Äî or start with a blank canvas</p>
            <input type="file" id="bgFile" accept="image/*" style="display:none">
        </div>
        <div style="text-align:center;margin-bottom:16px">
            <button type="button" class="btn-secondary" onclick="startBlank()">Start Blank Canvas</button>
        </div>
        <div class="import-panel">
            <h4>üì± Import from DivisionScan</h4>
            <p style="font-size:11px;color:#666;margin:0 0 8px">Imports LiDAR scans from fdtraining.org</p>
            <button onclick="importFromServer()">Load from Server</button>
            <button onclick="document.getElementById('dsFile').click()">Load JSON File</button>
            <input type="file" id="dsFile" accept=".json" style="display:none">
        </div>
    </div>

    <!-- ANNOTATION / DRAWING SECTION -->
    <div id="annotSection" class="hidden">
        <!-- BACK BUTTON -->
        <button class="back-btn" onclick="goBackToUpload()">‚Üê Back to Upload / Import</button>

        <div class="toolbar">
            <button class="tool-btn active" data-tool="select" title="Select & Move">üîç Select</button>
            <button class="tool-btn" data-tool="draw" title="Free Draw">‚úèÔ∏è Draw</button>
            <button class="tool-btn" data-tool="wall" title="Draw Wall (pen)">üìè Wall</button>
            <button class="tool-btn" data-tool="measure" title="Measure Distance">üìê Measure</button>
            <button class="tool-btn" data-tool="box" title="Add Room/Box">‚¨ú Box</button>
            <button class="tool-btn" data-tool="text" title="Add Text">Aa Text</button>
            <div class="toolbar-sep"></div>
            <button class="tool-btn" id="undoBtn" title="Undo">‚Ü©Ô∏è</button>
            <button class="tool-btn" id="redoBtn" title="Redo">‚Ü™Ô∏è</button>
            <div class="toolbar-sep"></div>
            <button class="tool-btn" id="deleteBtn" title="Delete selected">üóëÔ∏è</button>
            <button class="tool-btn" id="clearBtn" title="Clear all">üßπ Clear</button>
            <div class="toolbar-sep"></div>
            <input type="color" id="colorPicker" value="#000000" title="Color">
            <select id="wallThickness" title="Wall Thickness"><option value="3">Thin</option><option value="6" selected>Normal</option><option value="10">Thick</option></select>
            <select id="unitSelect" title="Units"><option value="ft">Feet</option><option value="in">Inches</option></select>
            <select id="scaleSelect" title="Scale"><option value="8">1/4"=1'</option><option value="12" selected>1"=1'</option><option value="16">3/4"=1'</option></select>
            <div class="toolbar-sep"></div>
            <button class="tool-btn" id="zoomOutBtn" title="Zoom Out (Ctrl -)">‚ûñ</button>
            <span id="zoomLevel" style="font-size:11px;min-width:38px;text-align:center;font-weight:600;color:#1e3a5f">100%</span>
            <button class="tool-btn" id="zoomInBtn" title="Zoom In (Ctrl +)">‚ûï</button>
            <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom" style="font-size:10px">‚äô Fit</button>
        </div>
        <div class="symbol-bar">
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üî• Fire ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="facp">Alarm Panel (FACP)</button>
                <button class="symbol-item" data-symbol="annunciator">Annunciator</button>
                <button class="symbol-item" data-symbol="fdc">FDC</button>
                <button class="symbol-item" data-symbol="sprinkler">Sprinkler Riser</button>
                <button class="symbol-item" data-symbol="standpipe">Standpipe</button>
                <button class="symbol-item" data-symbol="extinguisher">Extinguisher</button>
                <button class="symbol-item" data-symbol="hydrant">Hydrant</button>
                <button class="symbol-item" data-symbol="pull">Pull Station</button>
                <button class="symbol-item" data-symbol="smoke">Smoke Detector</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üö™ Doors ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="door-l">Door (Left Swing)</button>
                <button class="symbol-item" data-symbol="door-r">Door (Right Swing)</button>
                <button class="symbol-item" data-symbol="door-d">Double Door</button>
                <button class="symbol-item" data-symbol="door-roll">Rollup/Overhead</button>
                <button class="symbol-item" data-symbol="door-slide">Sliding Door</button>
                <button class="symbol-item" data-symbol="door-pocket">Pocket Door</button>
                <button class="symbol-item" data-symbol="door-bifold">Bifold/Accordion</button>
                <button class="symbol-item" data-symbol="door-revolve">Revolving Door</button>
                <div class="symbol-header">WINDOWS</div>
                <button class="symbol-item" data-symbol="win-3">Window 3'</button>
                <button class="symbol-item" data-symbol="win-4">Window 4'</button>
                <button class="symbol-item" data-symbol="win-6">Window 6'</button>
                <button class="symbol-item" data-symbol="exit">EXIT Sign</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">ü™ú Access ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="stairs">Stairs</button>
                <button class="symbol-item" data-symbol="elevator">Elevator</button>
                <button class="symbol-item" data-symbol="roof">Roof Access</button>
                <button class="symbol-item" data-symbol="knox">Knox Box</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö° Utilities ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="elec">Electrical Panel</button>
                <button class="symbol-item" data-symbol="elec-off">Elec Shutoff</button>
                <button class="symbol-item" data-symbol="gas-off">Gas Shutoff</button>
                <button class="symbol-item" data-symbol="water-off">Water Shutoff</button>
                <button class="symbol-item" data-symbol="hvac">HVAC</button>
                <button class="symbol-item" data-symbol="gen">Generator</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üõãÔ∏è Furniture ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="bed">Bed</button>
                <button class="symbol-item" data-symbol="sofa">Sofa</button>
                <button class="symbol-item" data-symbol="desk">Desk</button>
                <button class="symbol-item" data-symbol="l-desk">L-Shaped Desk</button>
                <button class="symbol-item" data-symbol="table">Table</button>
                <button class="symbol-item" data-symbol="round-table">Round Table</button>
                <button class="symbol-item" data-symbol="conf-table">Conference Table</button>
                <button class="symbol-item" data-symbol="chair">Chair</button>
                <button class="symbol-item" data-symbol="rolling-chair">Rolling/Office Chair</button>
                <button class="symbol-item" data-symbol="bookshelf">Bookshelf</button>
                <button class="symbol-item" data-symbol="cubicle">Cubicle</button>
                <button class="symbol-item" data-symbol="file-cab">File Cabinet (Tall)</button>
                <button class="symbol-item" data-symbol="file-lateral">Lateral File Cabinet</button>
                <button class="symbol-item" data-symbol="tv">TV / Monitor</button>
                <div class="symbol-header">KITCHEN</div>
                <button class="symbol-item" data-symbol="fridge">Refrigerator</button>
                <button class="symbol-item" data-symbol="stove">Stove/Range</button>
                <button class="symbol-item" data-symbol="sink">Kitchen Sink</button>
                <button class="symbol-item" data-symbol="dw">Dishwasher</button>
                <div class="symbol-header">BATHROOM</div>
                <button class="symbol-item" data-symbol="toilet">Toilet</button>
                <button class="symbol-item" data-symbol="tub">Bathtub</button>
                <button class="symbol-item" data-symbol="shower">Shower</button>
                <button class="symbol-item" data-symbol="bath-sink">Bath Sink</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üè™ Mercantile ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="clothes-rack">Clothes Rack</button>
                <button class="symbol-item" data-symbol="display-case">Display Case</button>
                <button class="symbol-item" data-symbol="shelf-aisle">Shelving Aisle</button>
                <button class="symbol-item" data-symbol="checkout">Checkout Counter</button>
                <button class="symbol-item" data-symbol="register">Cash Register</button>
                <button class="symbol-item" data-symbol="cart-corral">Cart Corral</button>
                <button class="symbol-item" data-symbol="freezer">Freezer Case</button>
                <button class="symbol-item" data-symbol="cooler">Walk-in Cooler</button>
                <button class="symbol-item" data-symbol="storage">Storage Room</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ôø ADA ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="handicap">Handicap Symbol</button>
                <button class="symbol-item" data-symbol="ada-park">ADA Parking</button>
                <button class="symbol-item" data-symbol="ada-ramp">Wheelchair Ramp</button>
                <button class="symbol-item" data-symbol="ada-restroom">ADA Restroom</button>
                <button class="symbol-item" data-symbol="ada-elev">ADA Elevator</button>
                <button class="symbol-item" data-symbol="auto-door">Auto Door Opener</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ö†Ô∏è Obstructions ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="tree">Tree</button>
                <button class="symbol-item" data-symbol="shrub">Shrub/Bush</button>
                <button class="symbol-item" data-symbol="powerline">Power Lines</button>
                <button class="symbol-item" data-symbol="gas-line">Gas Line</button>
                <button class="symbol-item" data-symbol="water-line">Water Line</button>
                <button class="symbol-item" data-symbol="fence">Fence</button>
                <button class="symbol-item" data-symbol="bollard">Bollard</button>
                <button class="symbol-item" data-symbol="limited">Limited Access</button>
                <button class="symbol-item" data-symbol="no-access">No Access</button>
                <button class="symbol-item" data-symbol="overhead">Overhead Obstruction</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üîß Mechanical ‚ñº</button><div class="symbol-dropdown-content">
                <div class="symbol-header">SHOP</div>
                <button class="symbol-item" data-symbol="vehicle-lift">Vehicle Lift</button>
                <button class="symbol-item" data-symbol="tool-bench">Tool Bench</button>
                <button class="symbol-item" data-symbol="compressor">Air Compressor</button>
                <button class="symbol-item" data-symbol="welder">Welding Station</button>
                <button class="symbol-item" data-symbol="paint-booth">Paint Booth</button>
                <button class="symbol-item" data-symbol="oil-pit">Oil Change Pit</button>
                <div class="symbol-header">INDUSTRIAL</div>
                <button class="symbol-item" data-symbol="conveyor">Conveyor Belt</button>
                <button class="symbol-item" data-symbol="forklift">Forklift Area</button>
                <button class="symbol-item" data-symbol="crane">Overhead Crane</button>
                <button class="symbol-item" data-symbol="machine">Machinery</button>
                <button class="symbol-item" data-symbol="pallet">Pallet Rack</button>
                <button class="symbol-item" data-symbol="loading">Loading Dock</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚õ™ Assembly ‚ñº</button><div class="symbol-dropdown-content">
                <div class="symbol-header">CHURCH</div>
                <button class="symbol-item" data-symbol="pew">Pew/Seating Row</button>
                <button class="symbol-item" data-symbol="altar">Altar/Stage</button>
                <button class="symbol-item" data-symbol="pulpit">Pulpit/Podium</button>
                <button class="symbol-item" data-symbol="baptistry">Baptistry</button>
                <button class="symbol-item" data-symbol="choir">Choir Loft</button>
                <button class="symbol-item" data-symbol="organ">Organ/Piano</button>
                <div class="symbol-header">ASSEMBLY</div>
                <button class="symbol-item" data-symbol="seat-row">Seating Row</button>
                <button class="symbol-item" data-symbol="stage">Stage</button>
                <button class="symbol-item" data-symbol="bleachers">Bleachers</button>
                <button class="symbol-item" data-symbol="concession">Concession</button>
                <button class="symbol-item" data-symbol="ticket">Ticket Booth</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">‚ò¢Ô∏è Hazmat ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="nfpa704">NFPA 704 Diamond</button>
                <button class="symbol-item" data-symbol="hazmat-store">Hazmat Storage</button>
                <button class="symbol-item" data-symbol="fuel-tank">Fuel Tank</button>
                <button class="symbol-item" data-symbol="propane">Propane Tank</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üß≠ Compass ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="compass-rose">Compass Rose</button>
                <button class="symbol-item" data-symbol="north-arrow">North Arrow</button>
                <button class="symbol-item" data-symbol="north-simple">Simple N</button>
            </div></div>
            <div class="symbol-dropdown"><button class="symbol-dropdown-btn">üìç Other ‚ñº</button><div class="symbol-dropdown-content">
                <button class="symbol-item" data-symbol="dumpster">Dumpster</button>
                <button class="symbol-item" data-symbol="restroom">Restroom</button>
                <button class="symbol-item" data-symbol="office">Office</button>
                <button class="symbol-item" data-symbol="breakroom">Break Room</button>
                <button class="symbol-item" data-symbol="server-room">Server Room</button>
                <button class="symbol-item" data-symbol="mech-room">Mechanical Room</button>
                <button class="symbol-item" data-symbol="pool">Pool</button>
            </div></div>
        </div>
        <div class="canvas-wrapper"><canvas id="floor-canvas" width="900" height="600"></canvas></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
            <button type="button" class="btn-secondary" id="newImageBtn">üì∑ New Image</button>
            <button type="button" class="btn-secondary" id="exportPng">üíæ Export PNG</button>
            <button type="button" class="btn-secondary" id="addKeyBtn">üîë Add Key to Plan</button>
        </div>
        <div class="legend"><h4>Common Symbols</h4><div class="legend-items">
            <span>üî¥ FACP ‚Äî Alarm Panel</span><span>üî¥ FDC ‚Äî Fire Dept Conn</span>
            <span>üîµ SR ‚Äî Sprinkler Riser</span><span>üîµ SP ‚Äî Standpipe</span>
            <span>üî¥ FE ‚Äî Extinguisher</span><span>üî¥ PS ‚Äî Pull Station</span>
            <span>üü† ELEC ‚Äî Electrical</span><span>üü† KNOX ‚Äî Knox Box</span>
            <span>üü° G ‚Äî Gas Shutoff</span><span>üîµ W ‚Äî Water Shutoff</span>
        </div></div>
    </div>
    <form id="floor-plan-form"><input type="hidden" name="floor_plan_data" id="floor-plan-data">
        <div class="form-actions">
            <button type="button" id="prev-btn" class="btn-secondary">‚Üê Previous</button>
            <button type="button" id="next-btn" class="btn-primary">Next ‚Üí Review & Submit</button>
        </div>
    </form>
</div>
</div>
<footer><img src="images/city-logo.png" alt="City" class="city-logo"><p>¬© 2026 City of Centerville Fire Department</p></footer>

<!-- NFPA MODAL -->
<div class="nfpa-modal" id="nfpaModal"><div class="nfpa-form">
    <h3>NFPA 704 Diamond</h3>
    <label>Health (Blue, 0-4)</label><input type="number" id="nfpaH" min="0" max="4" value="0">
    <label>Fire (Red, 0-4)</label><input type="number" id="nfpaF" min="0" max="4" value="0">
    <label>Reactivity (Yellow, 0-4)</label><input type="number" id="nfpaR" min="0" max="4" value="0">
    <label>Special</label><input type="text" id="nfpaS" placeholder="W, OX, etc." maxlength="3">
    <div class="nfpa-actions"><button type="button" class="btn-primary" onclick="placeNFPA()">Place</button><button type="button" class="btn-secondary" onclick="document.getElementById('nfpaModal').classList.remove('show')">Cancel</button></div>
</div></div>

<!-- BOX/ROOM MODAL -->
<div class="box-modal" id="boxModal"><div class="box-form">
    <h3>‚¨ú Add Room / Box</h3>
    <label>Width (feet)</label><input type="number" id="boxW" min="1" value="10" step="1">
    <label>Height / Depth (feet)</label><input type="number" id="boxH" min="1" value="10" step="1">
    <label>Label (optional)</label><input type="text" id="boxLabel" placeholder="e.g., Office, Storage">
    <div class="box-actions">
        <button type="button" class="btn-primary" onclick="placeBox()">Place</button>
        <button type="button" class="btn-secondary" onclick="document.getElementById('boxModal').classList.remove('show')">Cancel</button>
    </div>
</div></div>

<div id="toast"></div>
<script>
/* ========================================================
   STATE
   ======================================================== */
let canvas, currentTool='select', currentFloor=1, floorCount=1, floorData={},
    history=[], historyIdx=-1, wallPoints=[], wallPreviewLine=null, isDrawingWall=false;
const colorPicker=document.getElementById('colorPicker'),
      wallThickness=document.getElementById('wallThickness'),
      unitSelect=document.getElementById('unitSelect'),
      scaleSelect=document.getElementById('scaleSelect');
function getColor(){return colorPicker.value}
function getWall(){return parseInt(wallThickness.value)}
function getScale(){return parseInt(scaleSelect.value)}
function getUnit(){return unitSelect.value}

/* ========================================================
   BACK TO UPLOAD
   ======================================================== */
function goBackToUpload() {
    if (canvas && canvas.getObjects().length > 1) {
        if (!confirm('Go back? Your drawing will be preserved.')) return;
    }
    document.getElementById('annotSection').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
}

/* ========================================================
   SWITCH TO SELECT TOOL
   ======================================================== */
function switchToSelect() {
    currentTool = 'select';
    wallPoints = [];
    isDrawingWall = false;
    // Clean up measure previews
    if (canvas && window._measurePreview) { canvas.remove(window._measurePreview); window._measurePreview = null; }
    if (canvas && window._measureLabel) { canvas.remove(window._measureLabel); window._measureLabel = null; }
    if (canvas && window._measureDot) { canvas.remove(window._measureDot); window._measureDot = null; }
    window._measureStart = null;
    if (canvas) {
        canvas.isDrawingMode = false;
        canvas.selection = true;
        canvas.defaultCursor = 'default';
    }
    document.querySelectorAll('.tool-btn[data-tool]').forEach(function(b) {
        b.classList.toggle('active', b.dataset.tool === 'select');
    });
}

/* ========================================================
   SYMBOL FACTORIES (same as before)
   ======================================================== */
/* ========================================================
   VISUAL SYMBOL FACTORIES ‚Äî Architectural Top-Down Views
   ======================================================== */
function box(w,h,lbl,fill,tf){tf=tf||'white';var c=getColor(),il=fill===c;return new fabric.Group([new fabric.Rect({width:w,height:h,fill:il?'transparent':fill,stroke:il?fill:'#333',strokeWidth:il?2:1,rx:2,ry:2,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:Math.min(11,w/Math.max(lbl.length,1)*1.3),fill:il?fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}
function circ(r,lbl,fill,tf){tf=tf||'white';return new fabric.Group([new fabric.Circle({radius:r,fill:fill,stroke:'#333',strokeWidth:1,originX:'center',originY:'center'}),new fabric.Text(lbl,{fontSize:r*0.75,fill:tf,originX:'center',originY:'center',fontFamily:'Arial',fontWeight:'bold'})],{originX:'center',originY:'center'})}
function makeChair(s){var p=[];p.push(new fabric.Circle({radius:s*0.45,fill:'#f5f0e8',stroke:'#666',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:-s*0.15,radius:s*0.5,fill:'transparent',stroke:'#666',strokeWidth:2.5,startAngle:Math.PI*0.8,endAngle:Math.PI*1.2,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeRollingChair(s){var p=[];p.push(new fabric.Circle({radius:s*0.52,fill:'transparent',stroke:'#999',strokeWidth:0.75,strokeDashArray:[3,3],originX:'center',originY:'center'}));for(var i=0;i<5;i++){var a=Math.PI*2*i/5-Math.PI/2;p.push(new fabric.Circle({left:s*0.48*Math.cos(a),top:s*0.48*Math.sin(a),radius:2,fill:'#888',stroke:'#555',strokeWidth:0.5,originX:'center',originY:'center'}))}p.push(new fabric.Circle({radius:s*0.35,fill:'#e8e0d4',stroke:'#666',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:-s*0.1,radius:s*0.4,fill:'transparent',stroke:'#555',strokeWidth:2.5,startAngle:Math.PI*0.75,endAngle:Math.PI*1.25,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeBed(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#f0ebe3',stroke:'#888',strokeWidth:1.5,rx:3,ry:3,originX:'center',originY:'center'}));var pw=w*0.35,ph=h*0.12;p.push(new fabric.Rect({left:-w*0.16,top:-h/2+ph+4,width:pw,height:ph,fill:'white',stroke:'#aaa',strokeWidth:1,rx:4,ry:4,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:w*0.16,top:-h/2+ph+4,width:pw,height:ph,fill:'white',stroke:'#aaa',strokeWidth:1,rx:4,ry:4,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:0,top:-h/2-2,width:w+4,height:4,fill:'#8B7355',stroke:'#6B5335',strokeWidth:1,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Line([-w/2+4,-h*0.1,w/2-4,-h*0.1],{stroke:'#ccc',strokeWidth:0.75}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeSofa(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#ddd6c8',stroke:'#888',strokeWidth:1.5,rx:4,ry:4,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:0,top:-h/2+h*0.18,width:w-4,height:h*0.25,fill:'#c8bfaf',stroke:'#999',strokeWidth:0.75,rx:3,ry:3,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:-w/2+h*0.2,top:0,width:h*0.35,height:h-2,fill:'#c8bfaf',stroke:'#999',strokeWidth:0.75,rx:3,ry:3,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:w/2-h*0.2,top:0,width:h*0.35,height:h-2,fill:'#c8bfaf',stroke:'#999',strokeWidth:0.75,rx:3,ry:3,originX:'center',originY:'center'}));var cw=(w-h*0.7)/3;for(var i=1;i<3;i++){p.push(new fabric.Line([-w/2+h*0.35+cw*i,h*0.05,-w/2+h*0.35+cw*i,h/2-3],{stroke:'#b0a898',strokeWidth:0.75}))}return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeDesk(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#e8dfd0',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));var dw=w*0.4,dh=h*0.7;p.push(new fabric.Rect({left:w/2-dw/2-3,top:h*0.05,width:dw,height:dh,fill:'transparent',stroke:'#aaa',strokeWidth:1,rx:1,ry:1,originX:'center',originY:'center'}));for(var i=1;i<3;i++){var dy=h*0.05-dh/2+dh*i/3;p.push(new fabric.Line([w/2-dw-3,dy,w/2-3,dy],{stroke:'#bbb',strokeWidth:0.75}))}for(var i=0;i<3;i++){var dy=h*0.05-dh/2+dh*i/3+dh/6;p.push(new fabric.Line([w/4,dy,w/4+5,dy],{stroke:'#999',strokeWidth:1.5,strokeLineCap:'round'}))}return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeLDesk(s){var w=6*s,h=4*s,leg=2.2*s;var p=[];p.push(new fabric.Rect({left:0,top:-h/2+leg/2,width:w,height:leg,fill:'#e8dfd0',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Rect({left:w/2-leg/2,top:0,width:leg,height:h,fill:'#e8dfd0',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeConfTable(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#ddd6c8',stroke:'#888',strokeWidth:1.5,rx:h/2,ry:h/2,originX:'center',originY:'center'}));p.push(new fabric.Line([-w/3,0,w/3,0],{stroke:'#c0b8a8',strokeWidth:0.75}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeFileCabinet(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#d0d0d0',stroke:'#888',strokeWidth:1.5,rx:1,ry:1,originX:'center',originY:'center'}));var rows=h>w*1.5?4:2;for(var i=0;i<rows;i++){var dy=-h/2+h*i/rows+h/(rows*2);p.push(new fabric.Rect({left:0,top:dy,width:w-4,height:h/rows-3,fill:'transparent',stroke:'#aaa',strokeWidth:0.75,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Line([-3,dy,3,dy],{stroke:'#888',strokeWidth:2,strokeLineCap:'round'}))}return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeBookshelf(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#d4c4a8',stroke:'#888',strokeWidth:1.5,originX:'center',originY:'center'}));for(var i=1;i<4;i++){p.push(new fabric.Line([-w/2+2,-h/2+h*i/4,w/2-2,-h/2+h*i/4],{stroke:'#a89878',strokeWidth:1}))}for(var i=0;i<6;i++){var x=-w/2+4+i*(w-8)/6;p.push(new fabric.Line([x,-h/2+2,x,h/2-2],{stroke:'#c0b090',strokeWidth:0.5}))}return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeTV(w){var p=[];p.push(new fabric.Rect({width:w,height:4,fill:'#333',stroke:'#111',strokeWidth:1,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Line([-w/2+2,2,w/2-2,2],{stroke:'#0ea5e9',strokeWidth:0.75}));p.push(new fabric.Text('TV',{top:-8,fontSize:8,fill:'#555',fontFamily:'Arial',fontWeight:'bold',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeRoundTable(r){var p=[];p.push(new fabric.Circle({radius:r,fill:'#e8dfd0',stroke:'#888',strokeWidth:1.5,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeCubicle(s){var p=[];p.push(new fabric.Line([-s/2,-s/2,s/2,-s/2],{stroke:'#777',strokeWidth:4}));p.push(new fabric.Line([-s/2,-s/2,-s/2,s/2],{stroke:'#777',strokeWidth:4}));p.push(new fabric.Line([s/2,-s/2,s/2,s/2],{stroke:'#777',strokeWidth:4}));p.push(new fabric.Rect({left:0,top:-s*0.15,width:s*0.7,height:s*0.35,fill:'#e8dfd0',stroke:'#aaa',strokeWidth:1,rx:1,ry:1,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeFridge(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#eee',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Line([0,-h/2+3,0,h/2-3],{stroke:'#bbb',strokeWidth:1}));p.push(new fabric.Line([3,-h*0.15,3,h*0.15],{stroke:'#999',strokeWidth:2,strokeLineCap:'round'}));p.push(new fabric.Line([-3,-h*0.15,-3,h*0.15],{stroke:'#999',strokeWidth:2,strokeLineCap:'round'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeDishwasher(s){var p=[];p.push(new fabric.Rect({width:s,height:s,fill:'#e8e8e8',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Rect({top:-s/2+s*0.12,width:s-4,height:s*0.15,fill:'#d0d0d0',stroke:'#aaa',strokeWidth:0.75,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Line([-s*0.2,-s*0.15,s*0.2,-s*0.15],{stroke:'#999',strokeWidth:2,strokeLineCap:'round'}));p.push(new fabric.Text('DW',{top:s*0.12,fontSize:7,fill:'#888',fontFamily:'Arial',fontWeight:'bold',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeToilet(s){var p=[];p.push(new fabric.Rect({left:0,top:-s*0.55,width:s*0.7,height:s*0.35,fill:'white',stroke:'#888',strokeWidth:1.5,rx:3,ry:3,originX:'center',originY:'center'}));p.push(new fabric.Ellipse({rx:s*0.4,ry:s*0.45,top:s*0.1,fill:'white',stroke:'#888',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Ellipse({rx:s*0.25,ry:s*0.3,top:s*0.12,fill:'transparent',stroke:'#bbb',strokeWidth:0.75,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeBathtub(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#f0f8ff',stroke:'#888',strokeWidth:2,rx:h*0.4,ry:h*0.4,originX:'center',originY:'center'}));p.push(new fabric.Rect({width:w-8,height:h-8,fill:'#e0f0ff',stroke:'#aac8e8',strokeWidth:1,rx:h*0.35,ry:h*0.35,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:h/2-14,radius:3,fill:'#999',originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:-h/2+10,radius:4,fill:'#ccc',stroke:'#999',strokeWidth:0.75,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeShower(s){var p=[];p.push(new fabric.Rect({width:s,height:s,fill:'#e8f4fd',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:-s/2+8,top:-s/2+8,radius:5,fill:'#ddd',stroke:'#999',strokeWidth:1,originX:'center',originY:'center'}));for(var i=0;i<3;i++)for(var j=0;j<3;j++){p.push(new fabric.Circle({left:-s*0.2+i*s*0.2,top:-s*0.2+j*s*0.2,radius:1,fill:'#a0d0f0',originX:'center',originY:'center'}))}p.push(new fabric.Circle({radius:3,fill:'#999',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeHydrant(){var p=[];p.push(new fabric.Circle({radius:10,fill:'#dc2626',stroke:'#991b1b',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:-11,radius:4,fill:'#ef4444',stroke:'#991b1b',strokeWidth:1,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:-10,top:5,radius:4,fill:'#ef4444',stroke:'#991b1b',strokeWidth:1,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:10,top:5,radius:4,fill:'#ef4444',stroke:'#991b1b',strokeWidth:1,originX:'center',originY:'center'}));p.push(new fabric.Circle({radius:4,fill:'#fca5a5',stroke:'#991b1b',strokeWidth:0.75,originX:'center',originY:'center'}));p.push(new fabric.Text('H',{fontSize:7,fill:'white',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeFACP(){var p=[];p.push(new fabric.Rect({width:40,height:30,fill:'#dc2626',stroke:'#991b1b',strokeWidth:1.5,rx:3,ry:3,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:-10,top:-6,radius:2.5,fill:'#fca5a5',stroke:'#fff',strokeWidth:0.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:0,top:-6,radius:2.5,fill:'#86efac',stroke:'#fff',strokeWidth:0.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:10,top:-6,radius:2.5,fill:'#fde047',stroke:'#fff',strokeWidth:0.5,originX:'center',originY:'center'}));p.push(new fabric.Text('FACP',{top:4,fontSize:9,fill:'white',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeExtinguisher(){var p=[];p.push(new fabric.Rect({width:10,height:18,fill:'#dc2626',stroke:'#991b1b',strokeWidth:1.5,rx:4,ry:4,originX:'center',originY:'center'}));p.push(new fabric.Rect({width:6,height:4,top:-11,fill:'#888',stroke:'#666',strokeWidth:0.75,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:6,top:-4,radius:2,fill:'#333',originX:'center',originY:'center'}));p.push(new fabric.Text('FE',{fontSize:6,fill:'white',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makePullStation(){var p=[];p.push(new fabric.Rect({width:14,height:18,fill:'#dc2626',stroke:'#991b1b',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Rect({width:8,height:5,top:2,fill:'#fff',stroke:'#dc2626',strokeWidth:0.75,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Text('PS',{top:-5,fontSize:6,fill:'white',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeSmokeDetector(){var p=[];p.push(new fabric.Circle({radius:9,fill:'white',stroke:'#888',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({radius:4,fill:'transparent',stroke:'#bbb',strokeWidth:0.75,originX:'center',originY:'center'}));p.push(new fabric.Circle({radius:1.5,fill:'#dc2626',originX:'center',originY:'center'}));p.push(new fabric.Text('SD',{top:14,fontSize:7,fill:'#888',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeSprinkler(){var p=[];p.push(new fabric.Circle({radius:8,fill:'#dbeafe',stroke:'#2563eb',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Line([0,-5,0,5],{stroke:'#2563eb',strokeWidth:1}));p.push(new fabric.Line([-5,0,5,0],{stroke:'#2563eb',strokeWidth:1}));p.push(new fabric.Circle({radius:2,fill:'#2563eb',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeKnox(){var p=[];p.push(new fabric.Rect({width:18,height:14,fill:'#f97316',stroke:'#c2410c',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Circle({top:-1,radius:2.5,fill:'#333',originX:'center',originY:'center'}));p.push(new fabric.Rect({top:2,width:2,height:4,fill:'#333',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeRegister(s){var p=[];p.push(new fabric.Rect({width:s,height:s,fill:'#d0d0d0',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Rect({top:-s*0.15,width:s*0.7,height:s*0.3,fill:'#333',stroke:'#555',strokeWidth:0.75,rx:1,ry:1,originX:'center',originY:'center'}));p.push(new fabric.Rect({top:s*0.2,width:s*0.8,height:s*0.25,fill:'#bbb',stroke:'#999',strokeWidth:0.75,originX:'center',originY:'center'}));p.push(new fabric.Text('REG',{top:s*0.2,fontSize:6,fill:'#666',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeDumpster(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#888',stroke:'#555',strokeWidth:2,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Line([-w/2+3,-h*0.2,w/2-3,-h*0.2],{stroke:'#666',strokeWidth:1.5}));p.push(new fabric.Text('DUMP',{top:h*0.1,fontSize:8,fill:'white',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeElevator(s){var p=[];p.push(new fabric.Rect({width:s,height:s,fill:'#f0f0f0',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));p.push(new fabric.Line([0,-s/2+3,0,s/2-3],{stroke:'#aaa',strokeWidth:1}));p.push(new fabric.Line([-s/2+3,-s/2+3,s/2-3,s/2-3],{stroke:'#bbb',strokeWidth:0.75}));p.push(new fabric.Line([s/2-3,-s/2+3,-s/2+3,s/2-3],{stroke:'#bbb',strokeWidth:0.75}));p.push(new fabric.Text('ELEV',{fontSize:8,fill:'#666',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeDoor(w,dir){
    var th=getWall(),c=getColor(),p=[];
    // Wall gap: white rect that clears through any wall
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    var hx=dir==='L'?-w/2:w/2;
    // Filled wedge (pie slice)
    var pts=[],steps=24;
    if(dir==='L'){
        pts.push({x:-w/2,y:0});pts.push({x:-w/2,y:-w});
        for(var i=0;i<=steps;i++){var a=-Math.PI/2+i*(Math.PI/2)/steps;pts.push({x:-w/2+w*Math.cos(a),y:w*Math.sin(a)})}
    }else{
        pts.push({x:w/2,y:0});pts.push({x:w/2,y:-w});
        for(var i=0;i<=steps;i++){var a=-Math.PI+i*(Math.PI/2)/steps;pts.push({x:w/2+w*Math.cos(a),y:w*Math.sin(a)})}
    }
    p.push(new fabric.Polygon(pts,{fill:'rgba(0,0,0,0.08)',stroke:'transparent',strokeWidth:0}));
    // Door panel line
    p.push(new fabric.Line([hx,0,hx,-w],{stroke:c,strokeWidth:2.5,strokeLineCap:'round'}));
    // Solid arc
    if(dir==='L'){
        p.push(new fabric.Circle({left:-w/2-w,top:-w,radius:w,startAngle:0,endAngle:Math.PI/2,fill:'transparent',stroke:c,strokeWidth:1.5}));
    }else{
        p.push(new fabric.Circle({left:-w/2,top:-w,radius:w,startAngle:Math.PI/2,endAngle:Math.PI,fill:'transparent',stroke:c,strokeWidth:1.5}));
    }
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makeDblDoor(w){
    var hw=w/2,th=getWall(),c=getColor(),p=[];
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    var ptsL=[],ptsR=[],steps=24;
    ptsL.push({x:-hw,y:0});ptsL.push({x:-hw,y:-hw});
    for(var i=0;i<=steps;i++){var a=-Math.PI/2+i*(Math.PI/2)/steps;ptsL.push({x:-hw+hw*Math.cos(a),y:hw*Math.sin(a)})}
    p.push(new fabric.Polygon(ptsL,{fill:'rgba(0,0,0,0.08)',stroke:'transparent',strokeWidth:0}));
    ptsR.push({x:hw,y:0});ptsR.push({x:hw,y:-hw});
    for(var i=0;i<=steps;i++){var a=-Math.PI+i*(Math.PI/2)/steps;ptsR.push({x:hw+hw*Math.cos(a),y:hw*Math.sin(a)})}
    p.push(new fabric.Polygon(ptsR,{fill:'rgba(0,0,0,0.08)',stroke:'transparent',strokeWidth:0}));
    p.push(new fabric.Line([-hw,0,-hw,-hw],{stroke:c,strokeWidth:2.5,strokeLineCap:'round'}));
    p.push(new fabric.Circle({left:-hw-hw,top:-hw,radius:hw,startAngle:0,endAngle:Math.PI/2,fill:'transparent',stroke:c,strokeWidth:1.5}));
    p.push(new fabric.Line([hw,0,hw,-hw],{stroke:c,strokeWidth:2.5,strokeLineCap:'round'}));
    p.push(new fabric.Circle({left:0,top:-hw,radius:hw,startAngle:Math.PI/2,endAngle:Math.PI,fill:'transparent',stroke:c,strokeWidth:1.5}));
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makeRollup(w){
    var th=getWall(),c=getColor(),p=[];
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    var h=10;
    p.push(new fabric.Rect({left:-w/2,top:-h/2,width:w,height:h,fill:'transparent',stroke:c,strokeWidth:1.5}));
    var sections=6;
    for(var i=1;i<sections;i++) p.push(new fabric.Line([-w/2+w*i/sections,-h/2,-w/2+w*i/sections,h/2],{stroke:c,strokeWidth:0.75}));
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makeSlider(w){
    var th=getWall(),c=getColor(),p=[];
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    p.push(new fabric.Line([-w/2,-2,w/6,-2],{stroke:c,strokeWidth:3,strokeLineCap:'round'}));
    p.push(new fabric.Line([-w/6,2,w/2,2],{stroke:c,strokeWidth:3,strokeLineCap:'round'}));
    p.push(new fabric.Triangle({left:w/6+4,top:-2,width:5,height:4,fill:c,angle:90,originX:'center',originY:'center'}));
    p.push(new fabric.Triangle({left:-w/6-4,top:2,width:5,height:4,fill:c,angle:270,originX:'center',originY:'center'}));
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makePocket(w){
    var th=getWall(),c=getColor(),p=[];
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    p.push(new fabric.Line([-w/2,0,w/6,0],{stroke:c,strokeWidth:3,strokeLineCap:'round'}));
    p.push(new fabric.Rect({left:w/6+2,top:-th/2,width:w/3,height:th,fill:'transparent',stroke:'#999',strokeWidth:0.75,strokeDashArray:[4,3]}));
    p.push(new fabric.Triangle({left:w/6+w/6+2,top:0,width:5,height:4,fill:c,angle:90,originX:'center',originY:'center'}));
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makeBifold(w){
    var th=getWall(),c=getColor(),p=[];
    p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));
    var panels=4,pw=w/panels,depth=w*0.25;
    for(var i=0;i<panels;i++){
        var x1=-w/2+i*pw,y1=(i%2===0)?-depth/2:depth/2;
        var x2=-w/2+(i+1)*pw,y2=(i%2===0)?depth/2:-depth/2;
        p.push(new fabric.Line([x1,y1,x2,y2],{stroke:c,strokeWidth:2.5,strokeLineCap:'round'}));
    }
    return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true});
}
function makeRevolving(w){
    var c=getColor(),p=[];
    p.push(new fabric.Circle({radius:w/2,fill:'transparent',stroke:c,strokeWidth:1.5,originX:'center',originY:'center'}));
    p.push(new fabric.Line([0,-w/2,0,w/2],{stroke:c,strokeWidth:2,originX:'center',originY:'center'}));
    p.push(new fabric.Line([-w/2,0,w/2,0],{stroke:c,strokeWidth:2,originX:'center',originY:'center'}));
    return new fabric.Group(p,{originX:'center',originY:'center'});
}
function makeWindow(w){var th=getWall(),p=[];p.push(new fabric.Rect({left:-w/2-4,top:-th/2-4,width:w+8,height:th+8,fill:'white',stroke:'white',strokeWidth:2}));p.push(new fabric.Line([-w/2,-th/4,w/2,-th/4],{stroke:'#0ea5e9',strokeWidth:2}));p.push(new fabric.Line([-w/2,th/4,w/2,th/4],{stroke:'#0ea5e9',strokeWidth:2}));return new fabric.Group(p,{originX:'center',originY:'center',isOpening:true})}
function makeStairs(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#f5f5f5',stroke:'#888',strokeWidth:1.5,originX:'center',originY:'center'}));var steps=7;for(var i=1;i<steps;i++){p.push(new fabric.Line([-w/2+2,-h/2+h*i/steps,w/2-2,-h/2+h*i/steps],{stroke:'#999',strokeWidth:1}))}p.push(new fabric.Triangle({top:h*0.15,width:8,height:10,fill:'#888',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeStove(s){var p=[];p.push(new fabric.Rect({width:s,height:s,fill:'#e8e8e8',stroke:'#888',strokeWidth:1.5,rx:2,ry:2,originX:'center',originY:'center'}));var off=s*0.22;[[-off,-off],[off,-off],[-off,off],[off,off]].forEach(function(xy){p.push(new fabric.Circle({left:xy[0],top:xy[1],radius:s*0.13,fill:'transparent',stroke:'#555',strokeWidth:1.5,originX:'center',originY:'center'}));p.push(new fabric.Circle({left:xy[0],top:xy[1],radius:s*0.04,fill:'#888',originX:'center',originY:'center'}))});return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeSink(w,h){var p=[];p.push(new fabric.Rect({width:w,height:h,fill:'#e0f2fe',stroke:'#888',strokeWidth:1.5,rx:4,ry:4,originX:'center',originY:'center'}));p.push(new fabric.Ellipse({rx:w*0.3,ry:h*0.3,fill:'#cce7f5',stroke:'#0ea5e9',strokeWidth:1,originX:'center',originY:'center'}));p.push(new fabric.Circle({radius:2,fill:'#888',originX:'center',originY:'center'}));p.push(new fabric.Circle({top:-h*0.3,radius:3,fill:'#ccc',stroke:'#999',strokeWidth:0.75,originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeCompassRose(){var sz=50,p=[];p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#dc2626',left:0,top:-sz/2,angle:0,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:0,top:sz/2,angle:180,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:sz/2,top:0,angle:90,originX:'center',originY:'bottom'}));p.push(new fabric.Triangle({width:14,height:sz/2,fill:'#666',left:-sz/2,top:0,angle:270,originX:'center',originY:'bottom'}));['N','S','E','W'].forEach(function(d,i){var pos=[{x:0,y:-sz/2-8},{x:0,y:sz/2+8},{x:sz/2+8,y:0},{x:-sz/2-8,y:0}][i];p.push(new fabric.Text(d,{left:pos.x,top:pos.y,fontSize:10,fontWeight:'bold',fill:d==='N'?'#dc2626':'#333',originX:'center',originY:'center'}))});p.push(new fabric.Circle({radius:4,fill:'#333',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})}
function makeNorthArrow(){return new fabric.Group([new fabric.Triangle({width:20,height:40,fill:'#dc2626',originX:'center',originY:'center'}),new fabric.Text('N',{top:-28,fontSize:12,fontWeight:'bold',fill:'#dc2626',originX:'center',originY:'center'})],{originX:'center',originY:'center'})}
function placeNFPA(){var h=parseInt(document.getElementById('nfpaH').value)||0,f=parseInt(document.getElementById('nfpaF').value)||0,r=parseInt(document.getElementById('nfpaR').value)||0,s=document.getElementById('nfpaS').value||'';var sz=40,hs=sz/2,p=[];
p.push(new fabric.Polygon([{x:-hs,y:0},{x:0,y:-hs},{x:0,y:hs}],{fill:'#2563eb',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:0,y:-hs},{x:hs,y:0},{x:0,y:0}],{fill:'#dc2626',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:0,y:-hs},{x:0,y:0},{x:-hs+hs,y:0}],{fill:'#dc2626',stroke:'#000',strokeWidth:0}));
p.push(new fabric.Polygon([{x:hs,y:0},{x:0,y:-hs},{x:0,y:hs}],{fill:'#eab308',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Polygon([{x:-hs,y:0},{x:0,y:hs},{x:hs,y:0}],{fill:'#fff',stroke:'#000',strokeWidth:1}));
p.push(new fabric.Text(String(h),{left:-hs/2,top:-2,fontSize:14,fontWeight:'bold',fill:'#fff',originX:'center',originY:'center'}));
p.push(new fabric.Text(String(f),{left:0,top:-hs/2+2,fontSize:14,fontWeight:'bold',fill:'#fff',originX:'center',originY:'center'}));
p.push(new fabric.Text(String(r),{left:hs/2,top:-2,fontSize:14,fontWeight:'bold',fill:'#000',originX:'center',originY:'center'}));
if(s)p.push(new fabric.Text(s,{left:0,top:hs/2-2,fontSize:10,fontWeight:'bold',fill:'#000',originX:'center',originY:'center'}));
var g=new fabric.Group(p,{left:canvas.width/2,top:canvas.height/2,originX:'center',originY:'center',nfpaData:{h:h,f:f,r:r,s:s}});
canvas.add(g).setActiveObject(g).renderAll();document.getElementById('nfpaModal').classList.remove('show');saveHistory();saveData();switchToSelect()}

/* ========================================================
   BOX / ROOM TOOL
   ======================================================== */
function placeBox() {
    var w = parseFloat(document.getElementById('boxW').value) || 10;
    var h = parseFloat(document.getElementById('boxH').value) || 10;
    var lbl = document.getElementById('boxLabel').value || '';
    var sc = getScale();
    var pw = w * sc, ph = h * sc;

    var parts = [];
    // Walls as individual lines for the box
    parts.push(new fabric.Rect({
        width: pw, height: ph,
        fill: 'transparent', stroke: getColor(), strokeWidth: getWall(),
        originX: 'center', originY: 'center'
    }));

    // Dimension labels
    var unit = getUnit();
    var wLabel = unit === 'ft' ? w + "'" : (w * 12) + '"';
    var hLabel = unit === 'ft' ? h + "'" : (h * 12) + '"';
    parts.push(new fabric.Text(wLabel, {
        top: -ph/2 - 12, fontSize: 10, fill: '#555',
        backgroundColor: 'rgba(255,255,255,0.8)',
        originX: 'center', originY: 'center'
    }));
    parts.push(new fabric.Text(hLabel, {
        left: pw/2 + 14, fontSize: 10, fill: '#555',
        backgroundColor: 'rgba(255,255,255,0.8)',
        originX: 'center', originY: 'center', angle: 90
    }));

    if (lbl) {
        parts.push(new fabric.Text(lbl, {
            fontSize: Math.min(14, pw * 0.15), fill: '#555',
            originX: 'center', originY: 'center',
            fontFamily: 'Arial', fontWeight: 'bold'
        }));
    }

    var grp = new fabric.Group(parts, {
        left: canvas.width/2, top: canvas.height/2,
        originX: 'center', originY: 'center'
    });
    canvas.add(grp).setActiveObject(grp).renderAll();
    document.getElementById('boxModal').classList.remove('show');
    saveHistory(); saveData(); switchToSelect();
}

function getSymbol(type){var c=getColor(),s=getScale();var m={
// Fire Protection (visual)
'facp':function(){return makeFACP()},'annunciator':function(){return box(32,24,'ANN','#dc2626')},'fdc':function(){return circ(14,'FDC','#dc2626')},'sprinkler':function(){return makeSprinkler()},'standpipe':function(){return box(20,28,'SP','#2563eb')},'extinguisher':function(){return makeExtinguisher()},'hydrant':function(){return makeHydrant()},'pull':function(){return makePullStation()},'smoke':function(){return makeSmokeDetector()},
// Doors & Openings
'door-l':function(){return makeDoor(3*s,'L')},'door-r':function(){return makeDoor(3*s,'R')},'door-d':function(){return makeDblDoor(5*s)},'door-roll':function(){return makeRollup(8*s)},'door-slide':function(){return makeSlider(6*s)},'door-pocket':function(){return makePocket(4*s)},'door-bifold':function(){return makeBifold(6*s)},'door-revolve':function(){return makeRevolving(3*s)},'win-3':function(){return makeWindow(3*s)},'win-4':function(){return makeWindow(4*s)},'win-6':function(){return makeWindow(6*s)},'exit':function(){return box(32,14,'EXIT','#22c55e')},
// Building
'stairs':function(){return makeStairs(4*s,7*s)},'elevator':function(){return makeElevator(4*s)},'roof':function(){return box(28,28,'ROOF','#f97316')},'knox':function(){return makeKnox()},
// Utilities
'elec':function(){return box(24,36,'ELEC','#f97316')},'elec-off':function(){return circ(11,'E','#f97316')},'gas-off':function(){return circ(11,'G','#eab308','#000')},'water-off':function(){return circ(11,'W','#2563eb')},'hvac':function(){return box(45,45,'HVAC','#666')},'gen':function(){return box(55,38,'GEN','#f97316')},
// Furniture (visual)
'bed':function(){return makeBed(5*s,6*s)},'sofa':function(){return makeSofa(7*s,2.5*s)},'desk':function(){return makeDesk(5*s,2.5*s)},'l-desk':function(){return makeLDesk(s)},'table':function(){return makeDesk(4*s,2.5*s)},'round-table':function(){return makeRoundTable(2*s)},'conf-table':function(){return makeConfTable(10*s,3*s)},'chair':function(){return makeChair(1.5*s)},'rolling-chair':function(){return makeRollingChair(1.5*s)},'bookshelf':function(){return makeBookshelf(6*s,1.5*s)},'cubicle':function(){return makeCubicle(4*s)},'file-cab':function(){return makeFileCabinet(1.5*s,2.5*s)},'file-lateral':function(){return makeFileCabinet(3*s,1.5*s)},'tv':function(){return makeTV(4*s)},
// Kitchen (visual)
'fridge':function(){return makeFridge(2.5*s,2.5*s)},'stove':function(){return makeStove(2.5*s)},'sink':function(){return makeSink(2.5*s,1.8*s)},'dw':function(){return makeDishwasher(2*s)},
// Bathroom (visual)
'toilet':function(){return makeToilet(1.5*s)},'tub':function(){return makeBathtub(5*s,2.5*s)},'shower':function(){return makeShower(3*s)},'bath-sink':function(){return makeSink(2*s,1.5*s)},
// Retail/Commercial
'clothes-rack':function(){return box(6*s,1.5*s,'RACK',c)},'display-case':function(){return box(5*s,2*s,'DISPLAY',c)},'shelf-aisle':function(){return box(8*s,2*s,'AISLE',c)},'checkout':function(){return box(6*s,2*s,'CHECKOUT',c)},'register':function(){return makeRegister(2*s)},'cart-corral':function(){return box(4*s,3*s,'CARTS',c)},'freezer':function(){return box(6*s,3*s,'FREEZER','#bfdbfe','#000')},'cooler':function(){return box(5*s,5*s,'COOLER','#bfdbfe','#000')},'storage':function(){return box(5*s,4*s,'STORAGE',c)},
// ADA
'handicap':function(){return circ(14,'‚ôø','#2563eb')},'ada-park':function(){return box(3*s,5*s,'‚ôø P','#2563eb')},'ada-ramp':function(){return box(5*s,2*s,'RAMP','#2563eb')},'ada-restroom':function(){return box(3*s,3*s,'‚ôøWC','#2563eb')},'ada-elev':function(){return box(4*s,4*s,'‚ôøEL','#2563eb')},'auto-door':function(){return box(3*s,2*s,'AUTO','#2563eb')},
// Site
'tree':function(){return circ(14,'üå≤','#22c55e')},'shrub':function(){return circ(10,'üåø','#22c55e')},'powerline':function(){return box(6*s,1*s,'‚ö°POWER','#f97316')},'gas-line':function(){return box(6*s,1*s,'GAS LINE','#eab308','#000')},'water-line':function(){return box(6*s,1*s,'WATER','#2563eb')},'fence':function(){return box(6*s,0.8*s,'FENCE','#666')},'bollard':function(){return circ(6,'B','#f97316')},'limited':function(){return box(3*s,2*s,'LTD','#f97316')},'no-access':function(){return box(3*s,2*s,'NO','#dc2626')},'overhead':function(){return box(4*s,2*s,'OVHD','#f97316')},
// Industrial
'vehicle-lift':function(){return box(8*s,4*s,'LIFT',c)},'tool-bench':function(){return box(6*s,2*s,'BENCH',c)},'compressor':function(){return box(3*s,3*s,'COMP',c)},'welder':function(){return box(3*s,3*s,'WELD',c)},'paint-booth':function(){return box(6*s,6*s,'PAINT',c)},'oil-pit':function(){return box(8*s,3*s,'PIT',c)},'conveyor':function(){return box(10*s,2*s,'CONVEYOR',c)},'forklift':function(){return box(4*s,2*s,'FORK',c)},'crane':function(){return box(10*s,3*s,'CRANE',c)},'machine':function(){return box(4*s,4*s,'MACH',c)},'pallet':function(){return box(8*s,3*s,'PALLET',c)},'loading':function(){return box(8*s,4*s,'DOCK',c)},
// Assembly
'pew':function(){return box(8*s,1.5*s,'PEW',c)},'altar':function(){return box(6*s,3*s,'ALTAR',c)},'pulpit':function(){return box(3*s,3*s,'PULPIT',c)},'baptistry':function(){return circ(2*s,'BAPT','#bfdbfe','#000')},'choir':function(){return box(6*s,3*s,'CHOIR',c)},'organ':function(){return box(5*s,3*s,'ORGAN',c)},'seat-row':function(){return box(10*s,1.5*s,'SEATS',c)},'stage':function(){return box(10*s,5*s,'STAGE',c)},'bleachers':function(){return box(8*s,4*s,'BLEACH',c)},'concession':function(){return box(5*s,3*s,'FOOD',c)},'ticket':function(){return box(3*s,3*s,'TICKET',c)},
// Hazmat (visual)
'hazmat-store':function(){return box(4*s,4*s,'HAZ','#eab308','#000')},'fuel-tank':function(){var p=[];p.push(new fabric.Circle({radius:2*s,fill:'#fed7aa',stroke:'#f97316',strokeWidth:2,originX:'center',originY:'center'}));p.push(new fabric.Text('FUEL',{fontSize:s,fill:'#c2410c',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})},'propane':function(){var p=[];p.push(new fabric.Rect({width:3*s,height:2*s,fill:'#e8e8e8',stroke:'#f97316',strokeWidth:2,rx:s,ry:s,originX:'center',originY:'center'}));p.push(new fabric.Text('LP',{fontSize:s*0.8,fill:'#c2410c',fontWeight:'bold',fontFamily:'Arial',originX:'center',originY:'center'}));return new fabric.Group(p,{originX:'center',originY:'center'})},
// Orientation
'compass-rose':function(){return makeCompassRose()},'north-arrow':function(){return makeNorthArrow()},'north-simple':function(){return new fabric.Text('N‚Üë',{fontSize:24,fontWeight:'bold',fill:'#dc2626',originX:'center',originY:'center'})},
// General
'dumpster':function(){return makeDumpster(4*s,3*s)},'restroom':function(){return box(3*s,3*s,'WC',c)},'office':function(){return box(5*s,4*s,'OFFICE',c)},'breakroom':function(){return box(5*s,4*s,'BREAK',c)},'server-room':function(){return box(4*s,4*s,'SERVER',c)},'mech-room':function(){return box(5*s,4*s,'MECH',c)},'pool':function(){return box(8*s,5*s,'POOL','#bfdbfe','#000')}
};if(type==='nfpa704'){document.getElementById('nfpaModal').classList.add('show');return null}return m[type]?m[type]():box(30,30,type.toUpperCase().slice(0,4),c)}

/* ========================================================
   CANVAS INIT WITH IMPROVED CONTROLS
   ======================================================== */
function initCanvas(bgUrl) {
    canvas = new fabric.Canvas('floor-canvas', {
        preserveObjectStacking: true,
        backgroundColor: 'transparent',
        allowTouchScrolling: false,
        enablePointerEvents: true
    });

    // BETTER SELECTION CONTROLS
    fabric.Object.prototype.set({
        cornerSize: 16,           // Bigger handles for touch
        cornerColor: '#1e3a5f',
        cornerStrokeColor: '#fff',
        cornerStyle: 'circle',
        transparentCorners: false,
        borderColor: '#1e3a5f',
        borderScaleFactor: 2,
        padding: 8,
        rotatingPointOffset: 30   // Rotation handle further out
    });

    if (bgUrl) {
        fabric.Image.fromURL(bgUrl, function(img) {
            img.scaleToWidth(canvas.width);
            img.set({selectable:false, evented:false, isBg:true});
            canvas.add(img); canvas.sendToBack(img); canvas.renderAll();
        });
    }
    setupEvents();
    saveHistory();
}

/* ========================================================
   WALL DRAWING (pen-draw continuous line)
   ======================================================== */
var SNAP_DIST = 10; // px snap to existing wall endpoints

function findSnapPoint(x, y) {
    var best = null, bestDist = SNAP_DIST;
    canvas.getObjects('line').forEach(function(ln) {
        [[ln.x1+ln.left, ln.y1+ln.top],[ln.x2+ln.left, ln.y2+ln.top]].forEach(function(pt) {
            // For lines stored with absolute coords
            var pts = [
                {x: ln.get('x1'), y: ln.get('y1')},
                {x: ln.get('x2'), y: ln.get('y2')}
            ];
        });
        // Use path coords
        var coords = ln.calcLinePoints();
        var mx = ln.left + (ln.width/2 || 0);
        var my = ln.top + (ln.height/2 || 0);
        // Start and end points
        [
            {x: coords.x1 + mx, y: coords.y1 + my},
            {x: coords.x2 + mx, y: coords.y2 + my}
        ].forEach(function(pt) {
            var d = Math.sqrt((pt.x-x)*(pt.x-x) + (pt.y-y)*(pt.y-y));
            if (d < bestDist) { bestDist = d; best = pt; }
        });
    });
    // Also snap to recent wallPoints
    wallPoints.forEach(function(pt) {
        var d = Math.sqrt((pt.x-x)*(pt.x-x) + (pt.y-y)*(pt.y-y));
        if (d < bestDist) { bestDist = d; best = pt; }
    });
    return best;
}

function addWallSegment(from, to) {
    var line = new fabric.Line([from.x, from.y, to.x, to.y], {
        stroke: getColor(),
        strokeWidth: getWall(),
        strokeLineCap: 'round',
        selectable: true,
        isWall: true
    });
    canvas.add(line);

    // Joint dot at connection point (fills corner gaps)
    var th = getWall();
    canvas.add(new fabric.Circle({
        left: from.x, top: from.y, radius: th/2,
        fill: getColor(), stroke: 'transparent',
        originX: 'center', originY: 'center',
        selectable: false, evented: false, isWall: true
    }));
    canvas.add(new fabric.Circle({
        left: to.x, top: to.y, radius: th/2,
        fill: getColor(), stroke: 'transparent',
        originX: 'center', originY: 'center',
        selectable: false, evented: false, isWall: true
    }));

    // Dimension label
    var dx = to.x - from.x, dy = to.y - from.y;
    var len = Math.sqrt(dx*dx + dy*dy) / getScale();
    var unit = getUnit();
    var dim = unit === 'ft' ? len.toFixed(1) + "'" : (len*12).toFixed(0) + '"';
    var mid = {x: (from.x + to.x)/2, y: (from.y + to.y)/2};
    canvas.add(new fabric.Text(dim, {
        left: mid.x, top: mid.y - 12,
        fontSize: 10, fill: '#555',
        backgroundColor: 'rgba(255,255,255,0.8)',
        originX: 'center', selectable: true
    }));
}

/* ========================================================
   EVENT SETUP
   ======================================================== */
// Ensure doors/windows (openings) always render above walls so white gap shows
// Legend key stays on top of everything
function bringOpeningsToFront() {
    if (!canvas) return;
    canvas.getObjects().forEach(function(obj) {
        if (obj.isOpening) canvas.bringToFront(obj);
    });
    canvas.getObjects().forEach(function(obj) {
        if (obj.isLegendKey) canvas.bringToFront(obj);
    });
    canvas.renderAll();
}

function setupEvents() {
    canvas.on('object:modified', function() { bringOpeningsToFront(); saveHistory(); saveData(); });

    canvas.on('mouse:down', function(o) {
        if (!o.pointer) return;
        var px = o.pointer.x, py = o.pointer.y;

        if (currentTool === 'wall') {
            // Snap to nearby endpoints
            var snap = findSnapPoint(px, py);
            if (snap) { px = snap.x; py = snap.y; }

            if (!isDrawingWall) {
                // Start wall
                isDrawingWall = true;
                wallPoints = [{x: px, y: py}];
            } else {
                // Continue wall - add segment
                var last = wallPoints[wallPoints.length - 1];
                // Constrain to H/V if close to axis
                var dx = Math.abs(px - last.x), dy = Math.abs(py - last.y);
                if (dx < 15 && dy > 15) px = last.x; // snap vertical
                if (dy < 15 && dx > 15) py = last.y; // snap horizontal

                snap = findSnapPoint(px, py);
                if (snap) { px = snap.x; py = snap.y; }

                addWallSegment(last, {x: px, y: py});
                wallPoints.push({x: px, y: py});
            }
        }

        if (currentTool === 'text' && o.pointer) {
            var txt = prompt('Enter text:');
            if (txt) {
                canvas.add(new fabric.IText(txt, {
                    left: o.pointer.x, top: o.pointer.y,
                    fontSize: 14, fill: getColor(), fontFamily: 'Arial'
                }));
                saveHistory(); saveData(); switchToSelect();
            }
        }

        if (currentTool === 'measure' && o.pointer) {
            if (!window._measureStart) {
                window._measureStart = {x: o.pointer.x, y: o.pointer.y};
                // Place start marker
                window._measureDot = new fabric.Circle({left:o.pointer.x,top:o.pointer.y,radius:3,fill:'#dc2626',originX:'center',originY:'center',selectable:false,evented:false});
                canvas.add(window._measureDot);
            } else {
                var sx=window._measureStart.x,sy=window._measureStart.y,ex=o.pointer.x,ey=o.pointer.y;
                var dx=ex-sx,dy=ey-sy,dist=Math.sqrt(dx*dx+dy*dy);
                var scale=getScale(),unit=getUnit();
                var len=dist/scale;
                var dim=unit==='ft'?len.toFixed(1)+"'":((len*12).toFixed(0)+'"');
                // Draw measurement line
                var mid={x:(sx+ex)/2,y:(sy+ey)/2};
                var ang=Math.atan2(dy,dx)*180/Math.PI;
                canvas.add(new fabric.Line([sx,sy,ex,ey],{stroke:'#dc2626',strokeWidth:1.5,strokeDashArray:[6,4],selectable:true,evented:true}));
                // End dots
                canvas.add(new fabric.Circle({left:ex,top:ey,radius:3,fill:'#dc2626',originX:'center',originY:'center',selectable:false,evented:false}));
                // Dimension label
                canvas.add(new fabric.Text(dim,{left:mid.x,top:mid.y-12,fontSize:12,fill:'#dc2626',fontWeight:'bold',backgroundColor:'rgba(255,255,255,0.85)',originX:'center',selectable:true,fontFamily:'Arial'}));
                if(window._measureDot){canvas.remove(window._measureDot)}
                window._measureStart=null;window._measureDot=null;
                canvas.renderAll();saveHistory();saveData();switchToSelect();
                toast('Distance: '+dim);
            }
        }
    });

    canvas.on('mouse:move', function(o) {
        // Wall preview line
        if (currentTool === 'wall' && isDrawingWall && wallPoints.length > 0 && o.pointer) {
            if (wallPreviewLine) canvas.remove(wallPreviewLine);
            var last = wallPoints[wallPoints.length - 1];
            var px = o.pointer.x, py = o.pointer.y;
            var dx = Math.abs(px - last.x), dy = Math.abs(py - last.y);
            if (dx < 15 && dy > 15) px = last.x;
            if (dy < 15 && dx > 15) py = last.y;
            wallPreviewLine = new fabric.Line([last.x, last.y, px, py], {
                stroke: getColor(), strokeWidth: getWall(),
                strokeDashArray: [6, 4], selectable: false, evented: false,
                opacity: 0.5
            });
            canvas.add(wallPreviewLine);
            canvas.renderAll();
        }
        // Measure preview line
        if (currentTool === 'measure' && window._measureStart && o.pointer) {
            if (window._measurePreview) canvas.remove(window._measurePreview);
            if (window._measureLabel) canvas.remove(window._measureLabel);
            var s=window._measureStart,ex=o.pointer.x,ey=o.pointer.y;
            var dist=Math.sqrt((ex-s.x)*(ex-s.x)+(ey-s.y)*(ey-s.y));
            var sc=getScale(),u=getUnit(),len=dist/sc;
            var dim=u==='ft'?len.toFixed(1)+"'":((len*12).toFixed(0)+'"');
            window._measurePreview = new fabric.Line([s.x,s.y,ex,ey],{stroke:'#dc2626',strokeWidth:1,strokeDashArray:[4,4],selectable:false,evented:false,opacity:0.6});
            window._measureLabel = new fabric.Text(dim,{left:(s.x+ex)/2,top:(s.y+ey)/2-14,fontSize:11,fill:'#dc2626',fontWeight:'bold',backgroundColor:'rgba(255,255,255,0.8)',originX:'center',selectable:false,evented:false,fontFamily:'Arial'});
            canvas.add(window._measurePreview);canvas.add(window._measureLabel);
            canvas.renderAll();
        }
    });

    // Double-tap/click to finish wall
    canvas.on('mouse:dblclick', function() {
        if (currentTool === 'wall' && isDrawingWall) {
            finishWall();
        }
    });

    canvas.on('path:created', function() { saveHistory(); saveData(); switchToSelect(); });

    // Mouse wheel zoom
    canvas.on('mouse:wheel', function(opt) {
        var delta = opt.e.deltaY;
        var zoom = canvas.getZoom();
        zoom *= 0.999 ** delta;
        if (zoom > 10) zoom = 10;
        if (zoom < 0.1) zoom = 0.1;
        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
        opt.e.preventDefault();
        opt.e.stopPropagation();
        updateZoomLabel();
    });

    // Alt+drag or middle-mouse to pan
    var _isPanning = false, _lastPanX = 0, _lastPanY = 0;
    canvas.on('mouse:down', function(opt) {
        if (opt.e.altKey || opt.e.button === 1) {
            _isPanning = true;
            _lastPanX = opt.e.clientX;
            _lastPanY = opt.e.clientY;
            canvas.selection = false;
            canvas.defaultCursor = 'grabbing';
        }
    });
    canvas.on('mouse:move', function(opt) {
        if (!_isPanning) return;
        var vpt = canvas.viewportTransform;
        vpt[4] += opt.e.clientX - _lastPanX;
        vpt[5] += opt.e.clientY - _lastPanY;
        _lastPanX = opt.e.clientX;
        _lastPanY = opt.e.clientY;
        canvas.requestRenderAll();
    });
    canvas.on('mouse:up', function() {
        if (_isPanning) {
            _isPanning = false;
            canvas.defaultCursor = 'default';
            if (currentTool === 'select') canvas.selection = true;
        }
    });

    // Pinch-to-zoom (touch)
    var _lastPinchDist = 0, _pinchCenter = null;
    var upperEl = canvas.upperCanvasEl;
    if (upperEl) {
        upperEl.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                e.preventDefault();
                var dx = e.touches[0].clientX - e.touches[1].clientX;
                var dy = e.touches[0].clientY - e.touches[1].clientY;
                _lastPinchDist = Math.sqrt(dx * dx + dy * dy);
                var rect = upperEl.getBoundingClientRect();
                _pinchCenter = {
                    x: (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left,
                    y: (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top
                };
            }
        }, { passive: false });
        upperEl.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2 && _lastPinchDist > 0) {
                e.preventDefault();
                var dx = e.touches[0].clientX - e.touches[1].clientX;
                var dy = e.touches[0].clientY - e.touches[1].clientY;
                var dist = Math.sqrt(dx * dx + dy * dy);
                var zoom = canvas.getZoom() * (dist / _lastPinchDist);
                if (zoom > 10) zoom = 10;
                if (zoom < 0.1) zoom = 0.1;
                canvas.zoomToPoint(_pinchCenter, zoom);
                _lastPinchDist = dist;
                updateZoomLabel();
            }
        }, { passive: false });
        upperEl.addEventListener('touchend', function(e) {
            if (e.touches.length < 2) { _lastPinchDist = 0; _pinchCenter = null; }
        }, { passive: true });
    }

    // Apple Pencil / stylus pressure support
    var upperCanvas = canvas.upperCanvasEl;
    if (upperCanvas) {
        upperCanvas.addEventListener('pointerdown', function(e) {
            if (e.pointerType === 'pen' && canvas.isDrawingMode && canvas.freeDrawingBrush) {
                canvas.freeDrawingBrush.width = Math.max(1, (e.pressure || 0.5) * 6);
            }
        }, {passive: true});
        upperCanvas.addEventListener('pointermove', function(e) {
            if (e.pointerType === 'pen' && canvas.isDrawingMode && canvas.freeDrawingBrush) {
                canvas.freeDrawingBrush.width = Math.max(1, (e.pressure || 0.5) * 6);
            }
        }, {passive: true});
    }
}

function finishWall() {
    if (wallPreviewLine) { canvas.remove(wallPreviewLine); wallPreviewLine = null; }
    isDrawingWall = false;
    wallPoints = [];
    bringOpeningsToFront();
    saveHistory(); saveData();
    canvas.renderAll();
    switchToSelect();
}

/* ========================================================
   HISTORY / SAVE / LOAD
   ======================================================== */
function saveHistory(){historyIdx++;history=history.slice(0,historyIdx);history.push(JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData','isWall','isLegendKey'])));if(history.length>50){history.shift();historyIdx--}}
function undo(){if(historyIdx<=0)return;historyIdx--;canvas.loadFromJSON(history[historyIdx],function(){canvas.renderAll();bringOpeningsToFront()})}
function redo(){if(historyIdx>=history.length-1)return;historyIdx++;canvas.loadFromJSON(history[historyIdx],function(){canvas.renderAll();bringOpeningsToFront()})}
function saveData(){if(!canvas)return;floorData[currentFloor]=JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData','isWall','isLegendKey']));var all={};for(var f in floorData)all[f]=floorData[f];try{var saved=JSON.parse(localStorage.getItem('preFirePlan')||'{}');saved.floor_plan_data=JSON.stringify(all);localStorage.setItem('preFirePlan',JSON.stringify(saved))}catch(e){}}
function loadSavedData(){try{var saved=JSON.parse(localStorage.getItem('preFirePlan')||'{}');if(saved.floor_plan_data){var all=JSON.parse(saved.floor_plan_data);for(var f in all)floorData[f]=all[f];floorCount=Math.max(1,Math.max.apply(null,Object.keys(floorData).map(Number)));renderFloorTabs();if(floorData[1]){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');canvas=new fabric.Canvas('floor-canvas',{preserveObjectStacking:true,backgroundColor:'transparent',allowTouchScrolling:false,enablePointerEvents:true});
fabric.Object.prototype.set({cornerSize:16,cornerColor:'#1e3a5f',cornerStrokeColor:'#fff',cornerStyle:'circle',transparentCorners:false,borderColor:'#1e3a5f',borderScaleFactor:2,padding:8,rotatingPointOffset:30});
setupEvents();canvas.loadFromJSON(floorData[1],function(){canvas.renderAll();bringOpeningsToFront();saveHistory()})}}}catch(e){console.error(e)}}
function renderFloorTabs(){var tabs=document.getElementById('floorTabs'),html='';for(var i=1;i<=floorCount;i++)html+='<button class="floor-tab'+(i===currentFloor?' active':'')+'" data-floor="'+i+'">Floor '+i+'</button>';html+='<button class="add-floor-btn" id="addFloorBtn">+ Add Floor</button>';tabs.innerHTML=html;tabs.querySelectorAll('.floor-tab').forEach(function(b){b.onclick=function(){switchFloor(parseInt(b.dataset.floor))}});document.getElementById('addFloorBtn').onclick=addFloor}
function switchFloor(f){if(canvas)floorData[currentFloor]=JSON.stringify(canvas.toJSON(['isBg','isOpening','nfpaData','isWall','isLegendKey']));currentFloor=f;renderFloorTabs();if(floorData[f]){canvas.loadFromJSON(floorData[f],function(){canvas.renderAll();bringOpeningsToFront()})}else{canvas.clear();canvas.backgroundColor='transparent';canvas.renderAll()}saveHistory()}
function addFloor(){floorCount++;switchFloor(floorCount);toast('Floor '+floorCount+' added')}

/* ========================================================
   TOOL BUTTONS (with auto-return to select)
   ======================================================== */
document.querySelectorAll('.tool-btn[data-tool]').forEach(function(b) {
    b.onclick = function() {
        // Finish any in-progress wall
        if (isDrawingWall) finishWall();

        document.querySelectorAll('.tool-btn[data-tool]').forEach(function(x) { x.classList.remove('active'); });
        b.classList.add('active');
        currentTool = b.dataset.tool;
        wallPoints = [];
        isDrawingWall = false;

        if (currentTool === 'box') {
            document.getElementById('boxModal').classList.add('show');
            return;
        }

        canvas.isDrawingMode = currentTool === 'draw';
        if (canvas.isDrawingMode) {
            canvas.freeDrawingBrush.color = getColor();
            canvas.freeDrawingBrush.width = 2;
        }
        canvas.selection = currentTool === 'select';
        canvas.defaultCursor = currentTool === 'wall' ? 'crosshair' :
                               currentTool === 'measure' ? 'crosshair' :
                               currentTool === 'text' ? 'text' : 'default';
    };
});

colorPicker.onchange = function() { if (canvas && canvas.isDrawingMode) canvas.freeDrawingBrush.color = getColor(); };

// SYMBOL PLACEMENT (auto-return to select after placing)
document.querySelectorAll('.symbol-item').forEach(function(b) {
    b.onclick = function(e) {
        e.stopPropagation();
        var type = b.dataset.symbol, obj = getSymbol(type);
        if (!obj) return;
        obj.set({
            left: canvas.width/2 + Math.random()*40 - 20,
            top: canvas.height/2 + Math.random()*40 - 20
        });
        canvas.add(obj).setActiveObject(obj).renderAll();
        // Bring doors/windows above walls so the gap shows
        bringOpeningsToFront();
        saveHistory(); saveData();
        switchToSelect();
    };
});

document.getElementById('undoBtn').onclick = undo;
document.getElementById('redoBtn').onclick = redo;
document.getElementById('deleteBtn').onclick = function() {
    var sel = canvas.getActiveObjects();
    if (sel.length) {
        sel.forEach(function(o) { if (!o.isBg) canvas.remove(o); });
        canvas.discardActiveObject(); canvas.renderAll();
        saveHistory(); saveData();
    }
};
document.getElementById('clearBtn').onclick = function() {
    if (!confirm('Clear all objects?')) return;
    var bg = canvas.getObjects().find(function(o) { return o.isBg; });
    canvas.clear(); canvas.backgroundColor = 'transparent';
    if (bg) canvas.add(bg);
    canvas.renderAll(); saveHistory(); saveData();
};

document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); }
    if ((e.ctrlKey || e.metaKey) && (e.key === '=' || e.key === '+')) { e.preventDefault(); zoomCanvas(1.2); }
    if ((e.ctrlKey || e.metaKey) && e.key === '-') { e.preventDefault(); zoomCanvas(0.8); }
    if ((e.ctrlKey || e.metaKey) && e.key === '0') { e.preventDefault(); resetZoom(); }
    if (e.key === 'Escape') { if (isDrawingWall) finishWall(); switchToSelect(); }
    if (e.key === 'Delete' || e.key === 'Backspace') {
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
        document.getElementById('deleteBtn').click();
    }
});

/* ========================================================
   ZOOM CONTROLS
   ======================================================== */
function updateZoomLabel() {
    var el = document.getElementById('zoomLevel');
    if (el && canvas) el.textContent = Math.round(canvas.getZoom() * 100) + '%';
}
function zoomCanvas(factor) {
    if (!canvas) return;
    var zoom = canvas.getZoom() * factor;
    if (zoom > 10) zoom = 10;
    if (zoom < 0.1) zoom = 0.1;
    canvas.zoomToPoint({ x: canvas.width / 2, y: canvas.height / 2 }, zoom);
    updateZoomLabel();
}
function resetZoom() {
    if (!canvas) return;
    canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
    updateZoomLabel();
}
document.getElementById('zoomInBtn').onclick = function() { zoomCanvas(1.2); };
document.getElementById('zoomOutBtn').onclick = function() { zoomCanvas(0.8); };
document.getElementById('zoomResetBtn').onclick = resetZoom;

/* ========================================================
   UPLOAD / IMPORT
   ======================================================== */
document.getElementById('uploadArea').onclick = function() { document.getElementById('bgFile').click(); };
document.getElementById('bgFile').onchange = function() {
    if (this.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('annotSection').classList.remove('hidden');
            initCanvas(e.target.result);
        };
        reader.readAsDataURL(this.files[0]);
    }
};
function startBlank() {
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('annotSection').classList.remove('hidden');
    initCanvas(null);
}
document.getElementById('newImageBtn').onclick = function() {
    var fi = document.createElement('input');
    fi.type = 'file'; fi.accept = 'image/*';
    fi.onchange = function() {
        if (this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var bg = canvas.getObjects().find(function(o) { return o.isBg; });
                if (bg) canvas.remove(bg);
                fabric.Image.fromURL(e.target.result, function(img) {
                    img.scaleToWidth(canvas.width);
                    img.set({selectable:false, evented:false, isBg:true});
                    canvas.add(img); canvas.sendToBack(img);
                    canvas.renderAll(); saveHistory(); saveData();
                });
            };
            reader.readAsDataURL(this.files[0]);
        }
    };
    fi.click();
};
document.getElementById('exportPng').onclick = function() {
    var a = document.createElement('a');
    a.download = 'floor-plan-' + currentFloor + '.png';
    a.href = canvas.toDataURL({format:'png', quality:1});
    a.click(); toast('PNG exported');
};

/* ========================================================
   SYMBOL KEY / LEGEND
   ======================================================== */
var SYMBOL_KEY = {
    // Fire Protection
    'FACP':'Fire Alarm Control Panel','ANN':'Annunciator Panel','FDC':'Fire Dept Connection',
    'SR':'Sprinkler Riser','SP':'Standpipe','FE':'Fire Extinguisher','H':'Hydrant',
    'PS':'Pull Station','SD':'Smoke Detector',
    // Utilities
    'ELEC':'Electrical Panel','E':'Electrical Shutoff','G':'Gas Shutoff','W':'Water Shutoff',
    'HVAC':'HVAC System','GEN':'Generator','KNOX':'Knox Box',
    // Furniture
    'BED':'Bed','SOFA':'Sofa/Couch','DESK':'Desk','TABLE':'Table','SHELF':'Bookshelf','CUB':'Cubicle',
    'TV':'Television/Monitor','REG':'Cash Register','CONF':'Conference Table',
    // Kitchen
    'REF':'Refrigerator','DW':'Dishwasher',
    // Bathroom
    'WC':'Restroom/Toilet','TUB':'Bathtub','SHW':'Shower',
    // Retail/Commercial
    'RACK':'Clothes Rack','DISPLAY':'Display Case','AISLE':'Shelf Aisle','CHECKOUT':'Checkout Counter',
    'REG':'Cash Register','CARTS':'Cart Corral','FREEZER':'Walk-in Freezer','COOLER':'Walk-in Cooler',
    'STORAGE':'Storage Room',
    // Access
    'RAMP':'ADA Ramp','AUTO':'Auto Door Opener','LTD':'Limited Access','NO':'No Access','OVHD':'Overhead Obstruction',
    // Building
    'ELEV':'Elevator','ROOF':'Roof Access','EXIT':'Exit','OFFICE':'Office','BREAK':'Break Room',
    'SERVER':'Server Room','MECH':'Mechanical Room','POOL':'Swimming Pool',
    // Assembly
    'PEW':'Pew/Bench','ALTAR':'Altar','PULPIT':'Pulpit','BAPT':'Baptistry','CHOIR':'Choir Area',
    'ORGAN':'Organ','SEATS':'Seating Row','STAGE':'Stage','BLEACH':'Bleachers',
    'FOOD':'Concession Stand','TICKET':'Ticket Booth',
    // Hazmat
    'HAZ':'Hazmat Storage','FUEL':'Fuel Tank','LP':'Propane Tank',
    // Industrial
    'LIFT':'Vehicle Lift','BENCH':'Tool/Work Bench','COMP':'Compressor','WELD':'Welder',
    'PAINT':'Paint Booth','PIT':'Oil/Service Pit','CONVEYOR':'Conveyor','FORK':'Forklift Area',
    'CRANE':'Crane','MACH':'Machine','PALLET':'Pallet Storage','DOCK':'Loading Dock',
    // Site
    'DUMP':'Dumpster','B':'Bollard'
};

document.getElementById('addKeyBtn').onclick = function() {
    if (!canvas) return;

    // Remove existing key if present
    canvas.getObjects().forEach(function(obj) {
        if (obj.isLegendKey) canvas.remove(obj);
    });

    // Scan canvas for text labels that match our key
    var found = {};
    canvas.getObjects().forEach(function(obj) {
        if (obj.isLegendKey || obj.isBg) return;
        // Check group objects (most symbols are groups)
        if (obj._objects) {
            obj._objects.forEach(function(child) {
                if (child.type === 'text' || child.type === 'i-text') {
                    var t = (child.text || '').trim().replace('‚ôø ','').replace('‚ôø','').replace('‚ö°','');
                    if (t && SYMBOL_KEY[t]) {
                        found[t] = { label: SYMBOL_KEY[t], fill: child.fill || '#333' };
                    }
                }
            });
        }
    });

    var keys = Object.keys(found);
    if (keys.length === 0) {
        toast('No symbols found on canvas');
        return;
    }

    // Sort alphabetically by full name
    keys.sort(function(a,b){ return found[a].label.localeCompare(found[b].label); });

    // Build legend group
    var lineH = 18, padX = 12, padY = 10;
    var titleH = 22;
    var legendH = titleH + padY + keys.length * lineH + padY;
    var legendW = 200;
    var parts = [];

    // Background
    parts.push(new fabric.Rect({
        left: 0, top: 0, width: legendW, height: legendH,
        fill: 'white', stroke: '#333', strokeWidth: 1.5, rx: 4, ry: 4
    }));

    // Title bar
    parts.push(new fabric.Rect({
        left: 0, top: 0, width: legendW, height: titleH,
        fill: '#1e3a5f', stroke: 'transparent', rx: 4, ry: 4
    }));
    // Cover bottom corners of title
    parts.push(new fabric.Rect({
        left: 0, top: titleH - 6, width: legendW, height: 6,
        fill: '#1e3a5f', stroke: 'transparent'
    }));
    parts.push(new fabric.Text('SYMBOL KEY', {
        left: legendW / 2, top: titleH / 2,
        fontSize: 12, fontWeight: 'bold', fill: 'white',
        fontFamily: 'Arial', originX: 'center', originY: 'center'
    }));

    // Entries
    keys.forEach(function(abbr, i) {
        var y = titleH + padY + i * lineH;
        var info = found[abbr];

        // Colored dot
        parts.push(new fabric.Circle({
            left: padX, top: y + lineH / 2,
            radius: 4, fill: info.fill, stroke: '#555', strokeWidth: 0.5,
            originX: 'center', originY: 'center'
        }));

        // Abbreviation (bold)
        parts.push(new fabric.Text(abbr, {
            left: padX + 10, top: y + lineH / 2,
            fontSize: 10, fontWeight: 'bold', fill: '#333',
            fontFamily: 'Arial', originY: 'center'
        }));

        // Full name
        parts.push(new fabric.Text('‚Äî ' + info.label, {
            left: padX + 10 + abbr.length * 7 + 2, top: y + lineH / 2,
            fontSize: 10, fill: '#666',
            fontFamily: 'Arial', originY: 'center'
        }));

        // Separator line
        if (i < keys.length - 1) {
            parts.push(new fabric.Line([padX, y + lineH, legendW - padX, y + lineH], {
                stroke: '#e8e8e8', strokeWidth: 0.5
            }));
        }
    });

    var group = new fabric.Group(parts, {
        left: canvas.width - legendW - 15,
        top: 15,
        isLegendKey: true,
        selectable: true
    });

    canvas.add(group).setActiveObject(group).renderAll();
    bringOpeningsToFront();
    // Keep legend on top of openings
    canvas.bringToFront(group);
    canvas.renderAll();
    saveHistory(); saveData();
    switchToSelect();
    toast('Symbol key added ‚Äî drag to reposition');
};

/* DivisionScan import */
document.getElementById('dsFile').onchange = function() {
    if (this.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var d = JSON.parse(e.target.result);
                if (d.scan) renderDivisionScan(d.scan, [], []);
                else renderDivisionScan(d, [], []);
            } catch(err) { toast('Invalid JSON file'); }
        };
        reader.readAsText(this.files[0]);
    }
};

function importFromServer() {
    var serverUrl = 'https://fdtraining.org';
    toast('Connecting to DivisionScan server...');
    fetch(serverUrl + '/api/divisionscan/plans').then(function(r){return r.json()}).then(function(d){
    if(!d.plans||!d.plans.length){toast('No scans found on server');return}
    if(d.plans.length===1){loadScanById(d.plans[0].id, serverUrl);return}
    var modal=document.createElement('div');modal.id='scanPickerModal';
    modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:2000;display:flex;justify-content:center;align-items:center';
    var bx='<div style="background:#fff;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">';
    bx+='<h3 style="margin:0 0 4px;color:#1e3a5f">Import from DivisionScan</h3>';
    bx+='<p style="color:#888;font-size:12px;margin:0 0 16px">'+d.plans.length+' scans found ‚Äî select one to import</p>';
    d.plans.forEach(function(p){
    var dt=p.scan_date?new Date(p.scan_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
    var area=p.total_area?Math.round(p.total_area)+' ft¬≤':'';
    var dept=p.department?' ¬∑ '+p.department:'';
    bx+='<div onclick="loadScanById(\''+p.id+'\',\''+serverUrl+'\');document.getElementById(\'scanPickerModal\').remove()" style="padding:12px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:8px;cursor:pointer" onmouseover="this.style.borderColor=\'#1e3a5f\'" onmouseout="this.style.borderColor=\'#e2e8f0\'">';
    bx+='<div style="font-weight:600;color:#1e3a5f">'+escH(p.building_name||'Unnamed')+'</div>';
    if(p.building_address)bx+='<div style="font-size:12px;color:#666">'+escH(p.building_address)+'</div>';
    bx+='<div style="font-size:11px;color:#999;margin-top:4px">Floor '+escH(p.floor||'1')+' ¬∑ '+area+dept+' ¬∑ '+dt+'</div></div>';
    });
    bx+='<div style="text-align:center;margin-top:12px"><button onclick="document.getElementById(\'scanPickerModal\').remove()" style="padding:8px 20px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer">Cancel</button></div></div>';
    modal.innerHTML=bx;modal.onclick=function(e){if(e.target===modal)modal.remove()};
    document.body.appendChild(modal);
    }).catch(function(err){toast('Could not connect to server: ' + (err.message || 'Network error'))});
}
function escH(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function loadScanById(id, serverUrl){
toast('Loading scan...');
if(!serverUrl) serverUrl = 'https://fdtraining.org';
fetch(serverUrl + '/api/divisionscan/plan/'+id).then(function(r){return r.json()}).then(function(p){
if(p.success&&p.scan&&p.scan.scan_json){renderDivisionScan(JSON.parse(p.scan.scan_json),p.markers||[],p.annotations||[])}
else{toast('No scan data found')}
}).catch(function(){toast('Failed to load scan')})
}
function renderDivisionScan(data,markers,annotations){document.getElementById('uploadSection').classList.add('hidden');document.getElementById('annotSection').classList.remove('hidden');initCanvas(null);var walls=data.walls||[],doors=data.doors||[],wins=data.windows||[],objs=data.objects||[],rooms=data.rooms||[];var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;walls.forEach(function(w){minX=Math.min(minX,w.startX,w.endX);minY=Math.min(minY,w.startY,w.endY);maxX=Math.max(maxX,w.startX,w.endX);maxY=Math.max(maxY,w.startY,w.endY)});if(!walls.length){minX=0;minY=0;maxX=100;maxY=100}var bw=maxX-minX||1,bh=maxY-minY||1,sc=Math.min((canvas.width-80)/bw,(canvas.height-80)/bh),ox=40-minX*sc,oy=40-minY*sc;
rooms.forEach(function(r){if(!r.name||!r.centerX)return;var tx=r.centerX*sc+ox,ty=r.centerY*sc+oy;canvas.add(new fabric.Text(r.name+(r.area>10?'\n'+Math.round(r.area)+' ft¬≤':''),{left:tx,top:ty,fontSize:11,fill:'rgba(52,152,219,0.5)',fontFamily:'-apple-system,sans-serif',textAlign:'center',originX:'center',originY:'center',selectable:true}))});
walls.forEach(function(w){canvas.add(new fabric.Line([w.startX*sc+ox,w.startY*sc+oy,w.endX*sc+ox,w.endY*sc+oy],{stroke:'#333',strokeWidth:getWall(),selectable:true,isWall:true}))});
doors.forEach(function(d){var x=(d.x||0)*sc+ox,y=(d.y||0)*sc+oy,obj=makeDoor((d.width||3)*sc,'L');obj.set({left:x,top:y});canvas.add(obj)});
wins.forEach(function(w){var x=(w.x||0)*sc+ox,y=(w.y||0)*sc+oy,obj=makeWindow((w.width||3)*sc);obj.set({left:x,top:y});canvas.add(obj)});
objs.forEach(function(o){var x=(o.x||0)*sc+ox,y=(o.y||0)*sc+oy,w=(o.widthFt||o.width||3)*sc,h=(o.depthFt||o.depth||3)*sc;var catColors={'toilet':'#4ECDC4','bathtub':'#4ECDC4','sink':'#4ECDC4','stove':'#FF6B6B','oven':'#FF6B6B','refrigerator':'#45B7D1','bed':'#DDA0DD','sofa':'#F4A460','table':'#D2B48C','chair':'#D2B48C','television':'#708090','washerDryer':'#87CEEB','dishwasher':'#45B7D1','storage':'#BDB76B','fireplace':'#CD853F','stairs':'#A9A9A9'};
var col=catColors[o.category]||'#999';var lbl=o.label||o.category||'?';
var ang=o.angle||o.rotation||0;
var grp=new fabric.Group([new fabric.Rect({width:w,height:h,fill:col+'33',stroke:col,strokeWidth:1,rx:2,ry:2}),new fabric.Text(lbl,{fontSize:Math.min(10,w*0.3),fill:col,fontFamily:'-apple-system,sans-serif',textAlign:'center',originX:'center',originY:'center'})],{left:x-w/2,top:y-h/2,selectable:true,angle:ang?ang*180/Math.PI:0});
canvas.add(grp)});
if(markers&&markers.length){markers.forEach(function(m){var x=m.x*sc+ox,y=m.y*sc+oy;canvas.add(new fabric.Text('üìç'+(m.marker_name||''),{left:x,top:y,fontSize:10,fill:'#c0392b',originX:'center',originY:'center',selectable:true}))})}
if(annotations&&annotations.length){annotations.forEach(function(a){if(!a.points_json)return;try{var pts=JSON.parse(a.points_json);if(pts.length<2)return;var pathStr='M '+pts[0].x*sc+ox+' '+pts[0].y*sc+oy;for(var i=1;i<pts.length;i++)pathStr+=' L '+pts[i].x*sc+ox+' '+pts[i].y*sc+oy;canvas.add(new fabric.Path(pathStr,{fill:'',stroke:a.color_hex||'#FF0000',strokeWidth:a.line_width||2,selectable:true}))}catch(e){}})}
canvas.renderAll();saveHistory();saveData();toast('DivisionScan imported!')}

function toast(msg){var t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(window._tt);window._tt=setTimeout(function(){t.style.display='none'},2500)}
document.getElementById('prev-btn').onclick=function(){saveData();window.location.href='page10-site-plan.html'};
document.getElementById('next-btn').onclick=function(){saveData();toast('Saved');setTimeout(function(){window.location.href='page12-submit.html'},500)};
window.addEventListener('load', loadSavedData);
</script>

<!-- Pre-Plan Save/Resume Toolbar -->
<style>
.pp-toolbar{position:fixed;bottom:0;left:0;right:0;background:#1a1a1e;border-top:2px solid #c0392b;padding:8px 12px;display:flex;align-items:center;justify-content:center;gap:8px;z-index:9999;flex-wrap:wrap}
.pp-toolbar .pp-btn{padding:8px 14px;border-radius:6px;border:none;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap}
.pp-btn-save{background:#27ae60;color:#fff}.pp-btn-save:hover{background:#2ecc71}
.pp-btn-file{background:#2980b9;color:#fff}.pp-btn-file:hover{background:#3498db}
.pp-btn-load{background:#8e44ad;color:#fff}.pp-btn-load:hover{background:#9b59b6}
.pp-btn-link{background:#e67e22;color:#fff}.pp-btn-link:hover{background:#f39c12}
.pp-modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10000;display:none;justify-content:center;align-items:center}
.pp-modal-bg.show{display:flex}
.pp-modal{background:#24242a;border-radius:12px;padding:24px;max-width:420px;width:90%;color:#fff;border:1px solid #444;position:relative}
.pp-modal h3{color:#e67e22;margin-bottom:12px;font-size:16px}
.pp-modal p{color:#aaa;font-size:13px;margin-bottom:12px;line-height:1.5}
.pp-modal .pp-code{background:#1a1a1e;border:2px solid #e67e22;border-radius:8px;padding:14px;text-align:center;font-size:28px;letter-spacing:6px;font-weight:700;color:#e67e22;font-family:monospace;margin:12px 0;user-select:all}
.pp-modal .pp-link{background:#1a1a1e;border:1px solid #555;border-radius:6px;padding:10px;font-size:12px;color:#3498db;word-break:break-all;margin:8px 0;cursor:pointer;user-select:all}
.pp-modal-actions{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.pp-modal .pp-close{position:absolute;top:10px;right:14px;background:none;border:none;color:#888;font-size:20px;cursor:pointer}
.pp-modal input[type=text]{background:#1a1a1e;border:1px solid #555;border-radius:6px;padding:10px;color:#fff;font-size:14px;width:100%;margin:8px 0}
.pp-modal input[type=file]{display:none}
.pp-toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);padding:8px 20px;border-radius:6px;font-size:12px;font-weight:600;z-index:10001;display:none;box-shadow:0 2px 12px rgba(0,0,0,0.4)}
.pp-toast.success{background:#27ae60;color:#fff}.pp-toast.error{background:#c0392b;color:#fff}
.pp-saved-indicator{color:#27ae60;font-size:11px;display:none;align-items:center;gap:4px}
@media(max-width:480px){.pp-toolbar{gap:4px;padding:6px 8px}.pp-toolbar .pp-btn{padding:6px 10px;font-size:11px}}
</style>
<div class="pp-toolbar" id="ppToolbar">
  <span class="pp-saved-indicator" id="ppSaved">‚úì Auto-saved</span>
  <button class="pp-btn pp-btn-save" onclick="ppSaveCloud()" title="Save to cloud">‚òÅÔ∏è Save to Cloud</button>
  <button class="pp-btn pp-btn-file" onclick="ppExportFile()" title="Download file">üì• Export File</button>
  <button class="pp-btn pp-btn-load" onclick="ppShowLoadModal()" title="Load / Resume">üìÇ Load / Resume</button>
</div>
<div class="pp-modal-bg" id="ppModalBg" onclick="if(event.target===this)ppCloseModal()">
  <div class="pp-modal" id="ppModal"></div>
</div>
<div class="pp-toast" id="ppToast"></div>
<script>
(function(){
  var params=new URLSearchParams(window.location.search);
  var resumeCode=params.get('resume');
  if(resumeCode){fetch('/api/load-draft?code='+resumeCode.toUpperCase()).then(function(r){return r.json()}).then(function(d){if(d.success&&d.data){localStorage.setItem('preFirePlan',JSON.stringify(d.data));ppToast('Progress loaded!','success');history.replaceState(null,'',window.location.pathname);setTimeout(function(){location.reload()},800)}}).catch(function(){})}
  var lastData=localStorage.getItem('preFirePlan');
  setInterval(function(){var cur=localStorage.getItem('preFirePlan');if(cur!==lastData){lastData=cur;var el=document.getElementById('ppSaved');el.style.display='flex';clearTimeout(window._ppST);window._ppST=setTimeout(function(){el.style.display='none'},2000)}},1000);
})();
function ppGetData(){try{return JSON.parse(localStorage.getItem('preFirePlan')||'{}')}catch(e){return{}}}
function ppSaveCloud(){var data=ppGetData();if(!data||Object.keys(data).length===0){ppToast('No data to save','error');return}var existing=localStorage.getItem('ppCloudCode')||undefined;var modal=document.getElementById('ppModal');modal.innerHTML='<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚òÅÔ∏è Saving...</h3><p>Please wait...</p>';document.getElementById('ppModalBg').classList.add('show');fetch('/api/save-draft',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:data,code:existing})}).then(function(r){return r.json()}).then(function(d){if(d.success){localStorage.setItem('ppCloudCode',d.code);var link=window.location.origin+'/index.html?resume='+d.code;modal.innerHTML='<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚úÖ Saved!</h3><p>Resume code (7 days):</p><div class="pp-code">'+d.code+'</div><div class="pp-link" onclick="ppCopyLink(this)">'+link+'</div><div class="pp-modal-actions"><button class="pp-btn pp-btn-link" onclick="ppCopyLink(document.querySelector(\'.pp-link\'))">üìã Copy Link</button><button class="pp-btn pp-btn-save" onclick="ppCloseModal()">Done</button></div>'}else{modal.innerHTML='<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚ùå Failed</h3><p>'+(d.error||'Unknown error')+'</p>'}}).catch(function(err){modal.innerHTML='<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>‚ùå Failed</h3><p>'+err.message+'</p>'})}
function ppCopyLink(el){var text=el&&el.textContent||'';navigator.clipboard.writeText(text).then(function(){ppToast('Copied!','success')}).catch(function(){var ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();ppToast('Copied!','success')})}
function ppExportFile(){var data=ppGetData();if(!data||Object.keys(data).length===0){ppToast('No data','error');return}var name=(data.business_name||'preplan').replace(/[^a-zA-Z0-9]/g,'-').substring(0,30);var blob=new Blob([JSON.stringify({_type:'centerville-preplan-draft',_exported:new Date().toISOString(),data:data},null,2)],{type:'application/json'});var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name+'-draft-'+new Date().toISOString().slice(0,10)+'.json';a.click();ppToast('Exported!','success')}
function ppShowLoadModal(){var modal=document.getElementById('ppModal');modal.innerHTML='<button class="pp-close" onclick="ppCloseModal()">&times;</button><h3>üìÇ Load / Resume</h3><p><strong>Option 1:</strong> Enter resume code</p><input type="text" id="ppResumeCode" placeholder="6-char code" maxlength="6" style="text-transform:uppercase;text-align:center;letter-spacing:4px;font-size:18px"><button class="pp-btn pp-btn-link" onclick="ppLoadFromCode()" style="width:100%;justify-content:center;margin-bottom:16px">Load from Code</button><p><strong>Option 2:</strong> Load from file</p><button class="pp-btn pp-btn-file" onclick="document.getElementById(\'ppFileInput\').click()" style="width:100%;justify-content:center">üìÅ Choose File</button><input type="file" id="ppFileInput" accept=".json" onchange="ppLoadFromFile(this)">';document.getElementById('ppModalBg').classList.add('show');setTimeout(function(){var el=document.getElementById('ppResumeCode');if(el)el.focus()},100)}
function ppLoadFromCode(){var code=(document.getElementById('ppResumeCode')||{}).value;if(!code)code='';code=code.trim().toUpperCase();if(code.length<4){ppToast('Enter a valid code','error');return}fetch('/api/load-draft?code='+code).then(function(r){return r.json()}).then(function(d){if(d.success&&d.data){localStorage.setItem('preFirePlan',JSON.stringify(d.data));localStorage.setItem('ppCloudCode',code);ppToast('Loaded! Refreshing...','success');ppCloseModal();setTimeout(function(){location.reload()},800)}else{ppToast(d.error||'Not found','error')}}).catch(function(err){ppToast('Failed: '+err.message,'error')})}
function ppLoadFromFile(input){var file=input&&input.files&&input.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(e){try{var obj=JSON.parse(e.target.result);var data=obj.data||obj;if(typeof data!=='object')throw new Error('Invalid');localStorage.setItem('preFirePlan',JSON.stringify(data));ppToast('Loaded! Refreshing...','success');ppCloseModal();setTimeout(function(){location.reload()},800)}catch(err){ppToast('Invalid file','error')}};reader.readAsText(file)}
function ppCloseModal(){document.getElementById('ppModalBg').classList.remove('show')}
function ppToast(msg,type){var t=document.getElementById('ppToast');t.textContent=msg;t.className='pp-toast '+(type||'success');t.style.display='block';clearTimeout(window._ppTT);window._ppTT=setTimeout(function(){t.style.display='none'},3000)}
</script>
</body>
</html>
