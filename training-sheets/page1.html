<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centerville FD Training Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #000;
            line-height: 1.6;
            font-size: 16px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
            text-align: center;
        }
        header img {
            width: 140px;
            height: auto;
            margin-bottom: 20px;
        }
        .header-text h1 {
            font-size: 2.8rem;
            color: #000;
            margin-bottom: 8px;
        }
        .header-text p {
            font-size: 1.4rem;
            color: #d32f2f;
        }
        .section {
            margin-bottom: 50px;
        }
        .section h2 {
            font-size: 1.5rem;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        #training-details .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .time-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .time-input {
            width: 70px;
            text-align: center;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }
        .colon {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 0 5px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        #description, #objectives {
            color: #0000ff !important;
        }
        .copy-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        .copy-btn {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #1d4ed8;
        }
        .copy-feedback {
            margin-left: 10px;
            padding: 8px 16px;
            background: #16a34a;
            color: white;
            border-radius: 6px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th, .table td {
            padding: 12px;
            border: 1px solid #ccc;
            text-align: left;
            vertical-align: top;
        }
        .table th {
            background: #f1f5f9;
            font-weight: 600;
        }
        #instructors-table td, #students-centerville-table td {
            font-size: 0.85rem;
        }
        /* Column widths */
        #instructors-table th:nth-child(1), #instructors-table td:nth-child(1),
        #students-centerville-table th:nth-child(1), #students-centerville-table td:nth-child(1),
        #students-outside-table th:nth-child(1), #students-outside-table td:nth-child(1) { width: 300px; }
        #instructors-table th:nth-child(2), #instructors-table td:nth-child(2),
        #students-centerville-table th:nth-child(2), #students-centerville-table td:nth-child(2) { width: 200px; }
        #instructors-table th:nth-child(3), #instructors-table td:nth-child(3),
        #students-centerville-table th:nth-child(3), #students-centerville-table td:nth-child(3) { width: 160px; }
        #instructors-table th:nth-child(4), #instructors-table td:nth-child(4),
        #students-centerville-table th:nth-child(4), #students-centerville-table td:nth-child(4),
        #students-outside-table th:nth-child(4), #students-outside-table td:nth-child(4) { width: 340px; }
        #students-outside-table th:nth-child(2), #students-outside-table td:nth-child(2),
        #students-outside-table th:nth-child(3), #students-outside-table td:nth-child(3) { width: 180px; }
        /* Grading Points & Equipment tables */
        #grading-points-table th:nth-child(1), #grading-points-table td:nth-child(1),
        #facility-equipment-table th:nth-child(1), #facility-equipment-table td:nth-child(1) { width: 380px; }
        #grading-points-table th:nth-child(2), #grading-points-table td:nth-child(2),
        #facility-equipment-table th:nth-child(2), #facility-equipment-table td:nth-child(2) { width: 180px; }
        #grading-points-table th:nth-child(3), #grading-points-table td:nth-child(3),
        #facility-equipment-table th:nth-child(3), #facility-equipment-table td:nth-child(3) { width: 440px; }
        #drivers-training-section .drivers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        #drivers-training-section .form-group {
            margin-bottom: 0;
        }
        #drivers-training-section select {
            width: 100%;
            min-width: 220px;
        }
        .miles-line {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        .shift-under-date {
            margin-top: 20px;
        }
        .time-and-total {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .time-row {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin-bottom: 15px;
        }
        .total-hours-in-between {
            width: 180px;
            text-align: center;
        }
        .shift-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        .shift-btn {
            padding: 10px 16px;
            border: 2px solid #000;
            border-radius: 8px;
            background: white;
            color: #000;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
            text-align: center;
        }
        .shift-btn:hover {
            opacity: 0.8;
        }
        .shift-btn.selected {
            color: white;
        }
        #shift-days.selected { background: #fbbf24; border-color: #fbbf24; }
        #shift-1.selected { background: #16a34a; border-color: #16a34a; }
        #shift-2.selected { background: #2563eb; border-color: #2563eb; }
        #shift-3.selected { background: #dc2626; border-color: #dc2626; }
        #shift-pt.selected { background: #f97316; border-color: #f97316; }
        .damaged-buttons {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        .damaged-btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 80px;
            text-align: center;
            background: white;
            color: #000;
            transition: all 0.2s;
        }
        .damaged-yes.selected {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        .damaged-no.selected {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .damaged-btn:hover {
            opacity: 0.9;
        }
        .remove-btn, .remove-grading-btn, .remove-equipment-btn {
            display: block;
            margin-top: 10px;
            padding: 6px 12px;
            font-size: 0.85rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .remove-btn:hover, .remove-grading-btn:hover, .remove-equipment-btn:hover {
            background: #b91c1c;
        }
        .signature-display {
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            width: 100%;
            height: 120px;
            object-fit: contain;
        }
        .sign-btn {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .sign-btn:hover {
            background: #1d4ed8;
        }
        #other-personnel-toggle {
            padding: 12px 24px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            display: block;
        }
        #other-personnel-toggle:hover {
            background: #b91c1c;
        }
        #other-personnel-toggle.active {
            background: #16a34a;
        }
        #other-personnel-toggle.active:hover {
            background: #15803d;
        }
        #other-personnel {
            display: none;
        }
        .signature-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
        }
        .modal-canvas {
            border: 2px solid #ccc;
            background: #fff;
            cursor: crosshair;
            touch-action: none;
        }
        .modal-buttons {
            margin-top: 15px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        .clear-btn {
            background: #dc2626;
            color: white;
        }
        .clear-btn:hover {
            background: #b91c1c;
        }
        .done-btn {
            background: #2563eb;
            color: white;
        }
        .done-btn:hover {
            background: #1d4ed8;
        }
        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0 20px;
        }
        .submit-btn, .print-btn {
            padding: 18px 30px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 1.4rem;
        }
        .print-btn {
            background: #16a34a;
        }
        .print-btn:hover {
            background: #15803d;
        }
        .city-logo {
            width: 300px;
            height: auto;
            margin: 40px auto;
            display: block;
        }
        #add-instructor, #add-student-centerville, #add-student-outside, #add-grading-point, #add-equipment {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            display: block;
        }
        #add-instructor:hover, #add-student-centerville:hover, #add-student-outside:hover, #add-grading-point:hover, #add-equipment:hover {
            background: #1d4ed8;
        }
        @media (max-width: 768px) {
            .container { padding: 20px; }
            header img { width: 120px; }
            h1 { font-size: 2.2rem; }
            .city-logo { width: 250px; }
            .buttons-row { flex-direction: column; }
            .submit-btn, .print-btn { width: 100%; margin: 10px 0; }
            .form-row { grid-template-columns: 1fr; }
            .table th, .table td { font-size: 0.8rem; padding: 8px; }
            .shift-group { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="patch.png" alt="Centerville FD Patch">
            <div class="header-text">
                <h1>Centerville Fire Department</h1>
                <p>Training Report</p>
            </div>
        </header>

        <form id="trainingForm">
            <div class="section" id="training-details">
                <h2>Training Details</h2>
                <div class="form-group">
                    <label for="training-title">Training Course Title:</label>
                    <input type="text" id="training-title" name="training_title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Date:</label>
                        <input type="date" id="date" name="date" required>
                        <div class="shift-under-date">
                            <label>Shift (select all that apply):</label>
                            <div class="shift-group">
                                <button type="button" class="shift-btn" id="shift-days">Days</button>
                                <button type="button" class="shift-btn" id="shift-1">Shift 1</button>
                                <button type="button" class="shift-btn" id="shift-2">Shift 2</button>
                                <button type="button" class="shift-btn" id="shift-3">Shift 3</button>
                                <button type="button" class="shift-btn" id="shift-pt">PT</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="time-and-total">
                            <div class="time-row">
                                <div>
                                    <label>Start Time (24-hour):</label>
                                    <div class="time-group">
                                        <input type="text" id="start-hour" maxlength="2" placeholder="HH" class="time-input" required>
                                        <span class="colon">:</span>
                                        <input type="text" id="start-minute" maxlength="2" placeholder="MM" class="time-input" required>
                                    </div>
                                </div>
                                <div>
                                    <label>End Time (24-hour):</label>
                                    <div class="time-group">
                                        <input type="text" id="end-hour" maxlength="2" placeholder="HH" class="time-input" required>
                                        <span class="colon">:</span>
                                        <input type="text" id="end-minute" maxlength="2" placeholder="MM" class="time-input" required>
                                    </div>
                                </div>
                            </div>
                            <div class="total-hours-in-between">
                                <label for="total-hours">Total Hours:</label>
                                <input type="number" id="total-hours" name="total_hours" step="0.5" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selected-shifts" name="selected_shifts">
                <div class="form-group">
                    <label for="location">Location:</label>
                    <input type="text" id="location" name="location" required>
                </div>
                <div class="form-group">
                    <label for="iso-category">ISO Category:</label>
                    <select id="iso-category" name="iso_category" required>
                        <option value="">-- Select ISO Category --</option>
                        <option value="Company">Company</option>
                        <option value="Facility">Facility</option>
                        <option value="Officer">Officer</option>
                        <option value="Hazmat">Hazmat</option>
                        <option value="Driver (Roadway)">Driver (Roadway)</option>
                        <option value="Driver (Area Familiarization)">Driver (Area Familiarization)</option>
                        <option value="Driver (Pumper Training)">Driver (Pumper Training)</option>
                        <option value="Driver (Aerial Training)">Driver (Aerial Training)</option>
                        <option value="Recruit">Recruit</option>
                        <option value="EMS">EMS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description of Training:</label>
                    <textarea id="description" name="description" required></textarea>
                    <div class="copy-wrapper">
                        <button type="button" class="copy-btn">Copy Description</button>
                        <span class="copy-feedback" id="description-feedback">Copied!</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="objectives">Training Objectives:</label>
                    <textarea id="objectives" name="objectives" required></textarea>
                    <div class="copy-wrapper">
                        <button type="button" class="copy-btn">Copy Objectives</button>
                        <span class="copy-feedback" id="objectives-feedback">Copied!</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Instructors</h2>
                <table class="table" id="instructors-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Rank</th>
                            <th>GFSTC #</th>
                            <th>Signature</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-instructor">Add Instructor</button>
            </div>

            <div class="section">
                <h2>Students (Centerville)</h2>
                <table class="table" id="students-centerville-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Rank</th>
                            <th>GFSTC #</th>
                            <th>Signature</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-student-centerville">Add Student</button>
                <button type="button" id="other-personnel-toggle">Other Personnel</button>
            </div>

            <div class="section" id="outside-students-section" style="display:none;">
                <h2>Students (Outside Dept.)</h2>
                <table class="table" id="students-outside-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Rank</th>
                            <th>GFSTC #</th>
                            <th>Signature</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-student-outside">Add Student</button>
            </div>

            <div class="section" id="drivers-training-section" style="display:none;">
                <h2>Drivers Training Report</h2>
                <div class="drivers-grid">
                    <div class="form-group">
                        <label for="apparatus-type">Apparatus Type:</label>
                        <select id="apparatus-type" name="apparatus_type">
                            <option value="">-- Select --</option>
                            <option value="Rescue">Rescue</option>
                            <option value="Pumper">Pumper</option>
                            <option value="Aerial">Aerial</option>
                            <option value="Brush">Brush</option>
                            <option value="Command Car">Command Car</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="road-conditions">Road Conditions:</label>
                        <select id="road-conditions" name="road_conditions">
                            <option value="">-- Select --</option>
                            <option value="Dry">Dry</option>
                            <option value="Wet">Wet</option>
                            <option value="Icey">Icey</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="weather-conditions">Weather Conditions:</label>
                        <select id="weather-conditions" name="weather_conditions">
                            <option value="">-- Select --</option>
                            <option value="Clear">Clear</option>
                            <option value="Cloudy">Cloudy</option>
                            <option value="Mist">Mist</option>
                            <option value="Rain">Rain</option>
                            <option value="Thunderstorm">Thunderstorm</option>
                            <option value="Foggy">Foggy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="traffic-conditions">Traffic Conditions:</label>
                        <select id="traffic-conditions" name="traffic_conditions">
                            <option value="">-- Select --</option>
                            <option value="Light">Light</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Heavy">Heavy</option>
                        </select>
                    </div>
                </div>

                <div class="miles-line">
                    <div class="form-group">
                        <label for="apparatus-miles">Apparatus Miles:</label>
                        <input type="number" id="apparatus-miles" name="apparatus_miles">
                    </div>
                    <div class="form-group">
                        <label for="apparatus-hours">Apparatus Hours:</label>
                        <input type="number" id="apparatus-hours" name="apparatus_hours" step="0.5">
                    </div>
                    <div class="form-group">
                        <label for="actual-miles">Actual Miles Driven:</label>
                        <input type="number" id="actual-miles" name="actual_miles">
                    </div>
                </div>

                <table class="table" id="grading-points-table">
                    <thead>
                        <tr>
                            <th>Grading Points</th>
                            <th>Proficiency</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-grading-point">Add Grading Point</button>
            </div>

            <div class="section">
                <h2>Facility Equipment Used</h2>
                <table class="table" id="facility-equipment-table">
                    <thead>
                        <tr>
                            <th>Equipment Used</th>
                            <th>Damaged</th>
                            <th>Equipment Use Comments</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-equipment">Add Equipment</button>
            </div>

            <div class="buttons-row">
                <button type="submit" class="submit-btn">Submit Training Report</button>
                <button type="button" class="print-btn" onclick="window.print()">Print / Save as PDF</button>
            </div>
        </form>

        <img src="city-logo.png" alt="City of Centerville Logo" class="city-logo">
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="signature-modal">
        <div class="modal-content">
            <h3>Sign Here</h3>
            <canvas id="modalCanvas" class="modal-canvas" width="700" height="300"></canvas>
            <div class="modal-buttons">
                <button class="clear-signature-btn" id="clearSignature">Clear</button>
                <button class="done-btn" id="doneSignature">Done</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <script>
        (function () {
            try { emailjs.init('0149jkoCQjJZn6JwD'); } catch (e) {}
        })();

        const SERVICE_ID = 'service_2gdxvws';
        const TEMPLATE_ID = 'template_wj80wlx';

        // TIME INPUT VALIDATION & AUTO-TAB
        const timeInputs = ['start-hour', 'start-minute', 'end-hour', 'end-minute'];
        timeInputs.forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            input.addEventListener('blur', function() {
                let val = parseInt(this.value) || 0;
                if (this.id.includes('hour')) val = Math.min(23, val);
                if (this.id.includes('minute')) val = Math.min(59, val);
                this.value = val.toString().padStart(2, '0');
                calculateTotalHours();
            });
            input.addEventListener('input', function() {
                if (this.value.length === 2) {
                    const nextIndex = timeInputs.indexOf(this.id) + 1;
                    if (nextIndex < timeInputs.length) {
                        document.getElementById(timeInputs[nextIndex]).focus();
                    }
                }
                calculateTotalHours();
            });
        });

        function calculateTotalHours() {
            const sh = parseInt(document.getElementById('start-hour').value) || 0;
            const sm = parseInt(document.getElementById('start-minute').value) || 0;
            const eh = parseInt(document.getElementById('end-hour').value) || 0;
            const em = parseInt(document.getElementById('end-minute').value) || 0;

            let h = eh - sh;
            let m = em - sm;
            if (m < 0) { m += 60; h--; }
            if (h < 0) h += 24;

            document.getElementById('total-hours').value = (h + m / 60).toFixed(2);
        }

        // SHIFT BUTTONS
        ['shift-days','shift-1','shift-2','shift-3','shift-pt'].forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.addEventListener('click', () => {
                btn.classList.toggle('selected');
                updateSelectedShifts();
            });
        });

        function updateSelectedShifts() {
            const selected = ['shift-days','shift-1','shift-2','shift-3','shift-pt']
                .filter(id => document.getElementById(id).classList.contains('selected'))
                .map(id => document.getElementById(id).textContent.trim());
            document.getElementById('selected-shifts').value = selected.join(', ') || 'None';
        }

        // COPY BUTTONS
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const textarea = btn.closest('.form-group').querySelector('textarea');
                if (!textarea) return;
                try {
                    await navigator.clipboard.writeText(textarea.value);
                } catch (e) {
                    textarea.select();
                    document.execCommand('copy');
                }
                const feedback = btn.closest('.form-group').querySelector('.copy-feedback');
                feedback.style.opacity = 1;
                setTimeout(() => feedback.style.opacity = 0, 1500);
            });
        });

        // OTHER PERSONNEL TOGGLE
        document.getElementById('other-personnel-toggle').addEventListener('click', () => {
            const section = document.getElementById('outside-students-section');
            const toggle = document.getElementById('other-personnel-toggle');
            section.style.display = (section.style.display === 'none' || section.style.display === '') ? 'block' : 'none';
            toggle.classList.toggle('active');
        });

        // ISO CATEGORY AUTO-FILL
        document.getElementById('iso-category').addEventListener('change', function () {
            const val = this.value;
            const drivers = document.getElementById('drivers-training-section');
            drivers.style.display = ['Driver (Roadway)','Driver (Pumper Training)','Driver (Aerial Training)'].includes(val) ? 'block' : 'none';

            if (val === 'Driver (Roadway)') {
                document.getElementById('description').value = "Firefighter driver training is a comprehensive program designed to equip emergency personnel with the knowledge, skills, and judgment to operate large, heavy fire apparatus safely and efficiently in emergency and non-emergency situations. This training emphasizes safety through accident avoidance and adherence to legal requirements.";
                document.getElementById('objectives').value = `- Maneuvering large vehicles, including backing up and parallel parking with limited visibility\n- Negotiating narrow streets, sharp turns, and intersections safely\n- Defensive driving techniques and collision avoidance\n- Operating the vehicle under various weather and road conditions`;
            } else if (val === 'Driver (Area Familiarization)') {
                document.getElementById('description').value = "Area familiarization training for firefighters is a continuous and proactive process designed to ensure that crews possess intimate knowledge of their first-due response area and the specific structures within it. This knowledge enhances situational awareness, improves response times, and is critical for both public and firefighter safety during emergencies.";
                document.getElementById('objectives').value = `- Ensuring knowledge of street locations and optimal response routes\n- Locating water sources\n- Identifying target hazards\n- Understanding building construction types\n- Familiarization with a building's fire suppression and alarm system\n- Locating critical access points`;
            } else {
                document.getElementById('description').value = '';
                document.getElementById('objectives').value = '';
            }
        });

        // SIGNATURE MODAL (your original code - unchanged)
        let currentSignatureCell = null;
        const modal = document.getElementById('signatureModal');
        const canvas = document.getElementById('modalCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        document.getElementById('clearSignature').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        document.getElementById('doneSignature').onclick = () => {
            if (currentSignatureCell) {
                const img = document.createElement('img');
                img.className = 'signature-display';
                img.src = canvas.toDataURL();
                currentSignatureCell.innerHTML = '';
                currentSignatureCell.appendChild(img);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => {
                    currentSignatureCell.innerHTML = '<button type="button" class="sign-btn">Sign</button>';
                    addSignatureListener(currentSignatureCell);
                };
                currentSignatureCell.appendChild(removeBtn);
            }
            modal.style.display = 'none';
        };

        modal.addEventListener('click', e => {
            if (e.target === modal) modal.style.display = 'none';
        });

        function addSignatureListener(cell) {
            const signBtn = cell.querySelector('.sign-btn');
            if (signBtn) {
                signBtn.addEventListener('click', () => {
                    currentSignatureCell = cell;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = '#0000ff';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    modal.style.display = 'flex';
                });
            }
        }

        // ADD ROWS (your original code - unchanged)
        document.getElementById('add-instructor').addEventListener('click', () => {
            const tbody = document.querySelector('#instructors-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><select><option>-- Select Instructor --</option>
                    <option>Jones, Jason</option><option>Bostick, David</option><option>Kahley, Chad</option>
                    <option>Dorman, David</option><option>Talley, Dustin</option><option>Redd, Allen</option>
                    <option>Traxler, Clint</option></select></td>
                <td><select><option>-- Select Rank --</option>
                    <option>Fire Chief</option><option>Assistant Chief</option><option>Captain</option>
                    <option>Sergeant</option><option>Engineer</option><option>Firefighter</option></select></td>
                <td><select><option>-- Select GFSTC # --</option>
                    <option>4472-9279</option><option>7615-2424</option><option>5486-6025</option>
                    <option>3081-2978</option><option>3887-0449</option><option>7135-8934</option>
                    <option>3623-4177</option></select></td>
                <td><button type="button" class="sign-btn">Sign</button></td>
            `;
            addSignatureListener(row.cells[3]);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => row.remove();
            row.cells[3].appendChild(removeBtn);
        });

        document.getElementById('add-student-centerville').addEventListener('click', () => {
            const tbody = document.querySelector('#students-centerville-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><select><option>-- Select Student --</option>
                    <option>Barr, Harvey</option><option>Bennett, Kyle</option><option>Bostick, David</option>
                    <option>Cannon, James</option><option>Carroll, James</option><option>Dorman, David</option>
                    <option>Dunn, Pierson</option><option>Jones, Jason</option><option>Kahley, Chad</option>
                    <option>Laimana, Joe</option><option>Leatherwood, Jonathan</option><option>Lightning, Larry</option>
                    <option>McNeil, Drew</option><option>Mixon, Joshua</option><option>Mooney, William</option>
                    <option>Orona, Adam</option><option>Redd, Allen</option><option>Rice, Aaron</option>
                    <option>Schuler, Andrew</option><option>Smith, Mikayla</option><option>Stockholm, Jacob</option>
                    <option>Talley, Dustin</option><option>Thornton, Ethan</option><option>Traxler, Clint</option>
                    <option>Wall, Kaleb</option></select></td>
                <td><select><option>-- Select Rank --</option>
                    <option>Fire Chief</option><option>Assistant Chief</option><option>Captain</option>
                    <option>Sergeant</option><option>Engineer</option><option>Firefighter</option></select></td>
                <td><select><option>-- Select GFSTC # --</option>
                    <option>3353-4774</option><option>0869-5796</option><option>7615-2424</option>
                    <option>7905-1906</option><option>7560-2340</option><option>3081-2978</option>
                    <option>6345-7684</option><option>4472-9279</option><option>5486-6025</option>
                    <option>9183-2797</option><option>9823-3446</option><option>0711-8310</option>
                    <option>2676-9943</option><option>4670-9305</option><option>9213-3048</option>
                    <option>4438-5982</option><option>7135-8934</option><option>9228-1494</option>
                    <option>6748-5231</option><option>1159-4178</option><option>5655-4571</option>
                    <option>3887-0449</option><option>4221-3437</option><option>3623-4177</option>
                    <option>0701-7229</option></select></td>
                <td><button type="button" class="sign-btn">Sign</button></td>
            `;
            addSignatureListener(row.cells[3]);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => row.remove();
            row.cells[3].appendChild(removeBtn);
        });

        document.getElementById('add-student-outside').addEventListener('click', () => {
            const tbody = document.querySelector('#students-outside-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" placeholder="Enter Name"></td>
                <td><input type="text" placeholder="Enter Rank"></td>
                <td><input type="text" maxlength="9" placeholder="Enter GFSTC #"></td>
                <td><button type="button" class="sign-btn">Sign</button></td>
            `;
            addSignatureListener(row.cells[3]);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => row.remove();
            row.cells[3].appendChild(removeBtn);
        });

        document.getElementById('add-grading-point').addEventListener('click', () => {
            const tbody = document.querySelector('#grading-points-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><select><option>-- Select Grading Point --</option>
                    <option>Street Familiarization</option><option>Acceleration</option><option>Speed Consistency</option>
                    <option>Braking</option><option>Downgrade Braking</option><option>Left Turns</option>
                    <option>Right Turns</option><option>Intersections</option><option>Lane Changing</option>
                    <option>Low Clearance</option><option>Use of Lighting (Non-Emergent)</option>
                    <option>Use of Lighting (Emergent)</option><option>Cone Course</option>
                    <option>Pump Operations Training</option><option>Aerial Operations Training</option></select></td>
                <td><select><option>-- Select --</option>
                    <option>Meets the Standard</option><option>Exceeds the Standard</option>
                    <option>Needs Improvement</option><option>Unsatisfactory</option></select></td>
                <td><textarea></textarea><button type="button" class="remove-grading-btn">Remove</button></td>
            `;
            row.querySelector('.remove-grading-btn').onclick = () => row.remove();
        });

        let equipmentCount = 0;
        document.getElementById('add-equipment').addEventListener('click', () => {
            const tbody = document.querySelector('#facility-equipment-table tbody');
            const row = tbody.insertRow();
            equipmentCount++;
            const rowId = equipmentCount;

            row.innerHTML = `
                <td><select><option>-- Select Equipment --</option>
                    <option>Apparatus</option><option>Suppression Equipment</option><option>PPE</option>
                    <option>EMS Equipment</option><option>Office Equipment</option>
                    <option>Training Facility Equipment</option><option>Equipment from another organization</option></select></td>
                <td>
                    <div class="damaged-buttons">
                        <button type="button" class="damaged-btn damaged-yes" data-row="${rowId}" data-value="Yes">Yes</button>
                        <button type="button" class="damaged-btn damaged-no" data-row="${rowId}" data-value="No">No</button>
                    </div>
                    <input type="hidden" id="damaged-${rowId}" value="No">
                </td>
                <td><textarea></textarea><button type="button" class="remove-equipment-btn">Remove</button></td>
            `;

            row.querySelector('.damaged-no').classList.add('selected');
            row.querySelectorAll('.damaged-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    row.querySelectorAll('.damaged-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById(`damaged-${rowId}`).value = btn.getAttribute('data-value');
                });
            });

            row.querySelector('.remove-equipment-btn').onclick = () => row.remove();
        });

        // COLLECT PARTICIPANTS INTO DESCRIPTION
        function collectParticipants() {
            let desc = document.getElementById('description');
            let extra = '';

            // Instructors
            let instructors = [];
            document.querySelectorAll('#instructors-table tbody tr').forEach(row => {
                const name = row.cells[0].querySelector('select')?.value || '';
                if (name && name !== '-- Select Instructor --') instructors.push(name);
            });
            if (instructors.length) extra += `\n\nInstructors: ${instructors.join(', ')}`;

            // Centerville Students
            let centerville = [];
            document.querySelectorAll('#students-centerville-table tbody tr').forEach(row => {
                const name = row.cells[0].querySelector('select')?.value || '';
                if (name && name !== '-- Select Student --') centerville.push(name);
            });
            if (centerville.length) extra += `\n\nCenterville Students: ${centerville.join(', ')}`;

            // Outside Students
            if (document.getElementById('outside-students-section').style.display !== 'none') {
                let outside = [];
                document.querySelectorAll('#students-outside-table tbody tr').forEach(row => {
                    const name = row.cells[0].querySelector('input')?.value || '';
                    if (name) outside.push(name);
                });
                if (outside.length) extra += `\n\nOutside Students: ${outside.join(', ')}`;
            }

            if (extra) desc.value += extra;
        }

        // FIXED SUBMISSION
        document.getElementById('trainingForm').addEventListener('submit', async e => {
            e.preventDefault();

            collectParticipants();

            const btn = document.querySelector('.submit-btn');
            btn.textContent = 'Sending...';
            btn.disabled = true;

            try {
                // Generate and save PDF locally
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(document.querySelector('.container'), {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const width = pdf.internal.pageSize.getWidth();
                let height = canvas.height * width / canvas.width;
                let position = 0;
                pdf.addImage(imgData, 'PNG', 0, position, width, height);
                while (height > 297) {
                    pdf.addPage();
                    position -= 297;
                    pdf.addImage(imgData, 'PNG', 0, position, width, height);
                    height -= 297;
                }
                pdf.save('Centerville_Training_Report.pdf');

                // Send email
                await emailjs.sendForm(SERVICE_ID, TEMPLATE_ID, e.target);

                alert('Success! Report emailed and PDF saved locally.');
            } catch (err) {
                console.error(err);
                alert('Failed. Run via http://localhost (not file://). Check console.');
            } finally {
                btn.textContent = 'Submit Training Report';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>
