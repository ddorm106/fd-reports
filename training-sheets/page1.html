<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centerville FD Training Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #000;
            line-height: 1.6;
            font-size: 16px;
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            text-align: center;
        }
        .header-text h1 {
            font-size: 2.4rem;
            color: #000;
            margin-bottom: 8px;
        }
        .header-text p {
            font-size: 1.3rem;
            color: #d32f2f;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h2 {
            font-size: 1.4rem;
            border-bottom: 2px solid #d32f2f;
            padding-bottom: 8px;
            margin-bottom: 16px;
            color: #d32f2f;
            font-weight: 700;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        #description, #objectives {
            color: #0000ff !important;
        }
        .copy-wrapper {
            display: flex;
            justify-content: flex-end;
            margin-top: 6px;
        }
        .copy-btn {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #1d4ed8;
        }
        .copy-feedback {
            margin-left: 8px;
            padding: 8px 16px;
            background: #16a34a;
            color: white;
            border-radius: 6px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th, .table td {
            padding: 12px;
            border: 1px solid #ccc;
            text-align: left;
            vertical-align: top;
            font-size: 0.95rem;
        }
        .table th {
            background: #f1f5f9;
            font-weight: 600;
        }
        .shift-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        .shift-btn {
            padding: 12px 16px;
            border: 2px solid #000;
            border-radius: 8px;
            background: white;
            color: #000;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
            text-align: center;
        }
        .shift-btn:hover {
            opacity: 0.8;
        }
        .shift-btn.selected {
            color: white;
        }
        #shift-days.selected { background: #fbbf24; border-color: #fbbf24; }
        #shift-1.selected { background: #16a34a; border-color: #16a34a; }
        #shift-2.selected { background: #2563eb; border-color: #2563eb; }
        #shift-3.selected { background: #dc2626; border-color: #dc2626; }
        #shift-pt.selected { background: #f97316; border-color: #f97316; }
        .damaged-buttons {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .damaged-btn {
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            text-align: center;
            background: white;
            color: #000;
        }
        .damaged-yes.selected { background: #dc2626; color: white; border-color: #dc2626; }
        .damaged-no.selected { background: #2563eb; color: white; border-color: #2563eb; }
        .remove-btn {
            display: block;
            margin-top: 10px;
            padding: 8px;
            font-size: 0.9rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
        }
        .remove-btn:hover {
            background: #b91c1c;
        }
        .signature-display {
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fff;
            width: 100%;
            height: 120px;
            object-fit: contain;
        }
        .sign-btn {
            padding: 10px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            margin-top: 8px;
        }
        .sign-btn:hover {
            background: #1d4ed8;
        }
        #other-personnel-toggle {
            padding: 14px 24px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            width: 100%;
        }
        #other-personnel-toggle:hover {
            background: #b91c1c;
        }
        #other-personnel-toggle.active {
            background: #16a34a;
        }
        #other-personnel-toggle.active:hover {
            background: #15803d;
        }
        .buttons-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 50px 0 30px;
        }
        .main-btn {
            padding: 20px 24px;
            font-size: 1.5rem;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            color: white;
            width: 100%;
        }
        #save-report-btn { background: #2563eb; }
        #save-report-btn:hover { background: #1d4ed8; transform: translateY(-3px); }
        #send-email-btn { background: #16a34a; }
        #send-email-btn:hover { background: #15803d; transform: translateY(-3px); }
        #print-preview-btn { background: #f97316; }
        #print-preview-btn:hover { background: #ea580c; transform: translateY(-3px); }
        #clear-form-btn { background: #dc2626; }
        #clear-form-btn:hover { background: #b91c1c; transform: translateY(-3px); }
        .add-row-btn {
            padding: 14px 24px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            width: 100%;
        }
        .add-row-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .time-input {
            width: 80px;
            text-align: center;
        }
        .time-colon {
            font-size: 1.5rem;
            font-weight: bold;
        }
        #total-hours {
            background: #f1f5f9;
            font-weight: bold;
        }
        .signature-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
        }
        .modal-canvas {
            border: 2px solid #ccc;
            background: #fff;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
            height: 300px;
        }
        .modal-buttons {
            margin-top: 15px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        .clear-btn { background: #dc2626; color: white; }
        .clear-btn:hover { background: #b91c1c; }
        .done-btn { background: #2563eb; color: white; }
        .done-btn:hover { background: #1d4ed8; }
        @media (max-width: 1024px) {
            .container { padding: 20px; margin: 10px; }
            .header-text h1 { font-size: 2.2rem; }
            .form-row { grid-template-columns: 1fr; gap: 15px; }
        }
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 15px; margin: 5px; border-radius: 10px; }
            .header-text h1 { font-size: 2rem; }
            .header-text p { font-size: 1.2rem; }
            .section h2 { font-size: 1.3rem; }
            .shift-group { justify-content: center; }
            .main-btn { font-size: 1.5rem; min-height: 70px; padding: 24px; }
            .add-row-btn { font-size: 1.1rem; padding: 16px 24px; }
            .time-input-group { flex-direction: column; align-items: center; }
            .time-colon { margin: 10px 0; }
        }
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; margin: 0; max-width: none; padding: 30px; }
            .no-print, .sign-btn, .remove-btn, .copy-wrapper, #other-personnel-toggle, button { display: none !important; }
            .signature-display { height: 80px; }
            .section h2 { color: #000 !important; border-bottom: 2px solid #000 !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-text">
                <h1>Centerville Fire Department</h1>
                <p>Training Report</p>
            </div>
        </header>
        <form id="trainingForm">
            <div class="section" id="training-details">
                <h2>Training Details</h2>
                <div class="form-group">
                    <label for="training-title">Training Course Title:</label>
                    <input type="text" id="training-title" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="start-date">Start Date:</label>
                        <input type="date" id="start-date" required>
                       
                        <label for="end-date" style="margin-top: 15px; display: block;">End Date (Optional):</label>
                        <input type="date" id="end-date">
                       
                        <div style="margin-top: 20px;">
                            <label>Shift (select all that apply):</label>
                            <div class="shift-group">
                                <button type="button" class="shift-btn" id="shift-days">Days</button>
                                <button type="button" class="shift-btn" id="shift-1">Shift 1</button>
                                <button type="button" class="shift-btn" id="shift-2">Shift 2</button>
                                <button type="button" class="shift-btn" id="shift-3">Shift 3</button>
                                <button type="button" class="shift-btn" id="shift-pt">PT</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Start Time (24-hour):</label>
                        <div class="time-input-group">
                            <input type="text" id="start-hour" maxlength="2" placeholder="HH" class="time-input" required>
                            <span class="time-colon">:</span>
                            <input type="text" id="start-minute" maxlength="2" placeholder="MM" class="time-input" required>
                        </div>
                       
                        <label style="margin-top: 15px;">End Time (24-hour):</label>
                        <div class="time-input-group">
                            <input type="text" id="end-hour" maxlength="2" placeholder="HH" class="time-input" required>
                            <span class="time-colon">:</span>
                            <input type="text" id="end-minute" maxlength="2" placeholder="MM" class="time-input" required>
                        </div>
                       
                        <div style="margin-top: 15px;">
                            <label for="total-hours">Total Hours (editable):</label>
                            <input type="number" id="total-hours" step="0.25" min="0">
                            <small style="color: #666; font-size: 0.85rem;">Auto-calculated, but you can edit manually</small>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="selected-shifts">
                <div class="form-group">
                    <label for="location">Location:</label>
                    <input type="text" id="location" required>
                </div>
                <div class="form-group">
                    <label for="iso-category">ISO Category:</label>
                    <select id="iso-category" required>
                        <option value="">-- Select ISO Category --</option>
                        <option value="Company">Company</option>
                        <option value="Facility">Facility</option>
                        <option value="Officer">Officer</option>
                        <option value="Hazmat">Hazmat</option>
                        <option value="Driver (Roadway)">Driver (Roadway)</option>
                        <option value="Driver (Area Familiarization)">Driver (Area Familiarization)</option>
                        <option value="Driver (Pumper Training)">Driver (Pumper Training)</option>
                        <option value="Driver (Aerial Training)">Driver (Aerial Training)</option>
                        <option value="Recruit">Recruit</option>
                        <option value="EMS">EMS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description of Training:</label>
                    <textarea id="description" required></textarea>
                    <div class="copy-wrapper">
                        <button type="button" class="copy-btn">Copy Description</button>
                        <span class="copy-feedback">Copied!</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="objectives">Training Objectives:</label>
                    <textarea id="objectives" required></textarea>
                    <div class="copy-wrapper">
                        <button type="button" class="copy-btn">Copy Objectives</button>
                        <span class="copy-feedback">Copied!</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Instructors</h2>
                <table class="table" id="instructors-table">
                    <thead><tr><th>Name</th><th>Rank</th><th>GFSTC #</th><th>Signature</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-instructor" class="add-row-btn no-print">Add Instructor</button>
            </div>

            <div class="section">
                <h2>Students (Centerville)</h2>
                <table class="table" id="students-centerville-table">
                    <thead><tr><th>Name</th><th>Rank</th><th>GFSTC #</th><th>Signature</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-student-centerville" class="add-row-btn no-print">Add Student</button>
                <button type="button" id="other-personnel-toggle" class="no-print">Other Personnel</button>
            </div>

            <div class="section" id="outside-students-section" style="display:none;">
                <h2>Students (Outside Dept.)</h2>
                <table class="table" id="students-outside-table">
                    <thead><tr><th>Name</th><th>Rank</th><th>GFSTC #</th><th>Signature</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-student-outside" class="add-row-btn no-print">Add Student</button>
            </div>

            <div class="section" id="drivers-training-section" style="display:none;">
                <h2>Drivers Training Report</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group"><label for="apparatus-type">Apparatus Type:</label><select id="apparatus-type"><option value="">-- Select --</option><option>Rescue</option><option>Pumper</option><option>Aerial</option><option>Brush</option><option>Command Car</option></select></div>
                    <div class="form-group"><label for="road-conditions">Road Conditions:</label><select id="road-conditions"><option value="">-- Select --</option><option>Dry</option><option>Wet</option><option>Icey</option></select></div>
                    <div class="form-group"><label for="weather-conditions">Weather Conditions:</label><select id="weather-conditions"><option value="">-- Select --</option><option>Clear</option><option>Cloudy</option><option>Mist</option><option>Rain</option><option>Thunderstorm</option><option>Foggy</option></select></div>
                    <div class="form-group"><label for="traffic-conditions">Traffic Conditions:</label><select id="traffic-conditions"><option value="">-- Select --</option><option>Light</option><option>Moderate</option><option>Heavy</option></select></div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div class="form-group"><label for="apparatus-miles">Apparatus Miles:</label><input type="number" id="apparatus-miles"></div>
                    <div class="form-group"><label for="apparatus-hours">Apparatus Hours:</label><input type="number" id="apparatus-hours" step="0.5"></div>
                    <div class="form-group"><label for="actual-miles">Actual Miles Driven:</label><input type="number" id="actual-miles"></div>
                </div>
                <table class="table" id="grading-points-table" style="margin-top: 20px;">
                    <thead><tr><th>Grading Points</th><th>Proficiency</th><th>Comments</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-grading-point" class="add-row-btn no-print">Add Grading Point</button>
            </div>

            <div class="section">
                <h2>Facility Equipment Used</h2>
                <table class="table" id="facility-equipment-table">
                    <thead><tr><th>Equipment Used</th><th>Damaged</th><th>Equipment Use Comments</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" id="add-equipment" class="add-row-btn no-print">Add Equipment</button>
            </div>

            <div class="buttons-row">
                <button type="button" class="main-btn" id="save-report-btn">
                    <span class="btn-text">Save Report</span>
                    <span class="btn-loading" style="display:none;">Saving...</span>
                </button>
                <button type="button" class="main-btn" id="send-email-btn">Send via Email</button>
                <button type="button" class="main-btn" id="print-preview-btn">Print Preview</button>
                <button type="button" class="main-btn" id="clear-form-btn">Clear Form</button>
            </div>
        </form>
    </div>

    <div id="signatureModal" class="signature-modal">
        <div class="modal-content">
            <h3>Sign Here</h3>
            <canvas id="modalCanvas" class="modal-canvas" width="700" height="300"></canvas>
            <div class="modal-buttons">
                <button id="clearSignature" class="clear-btn">Clear</button>
                <button id="doneSignature" class="done-btn">Done</button>
            </div>
        </div>
    </div>

    <script>
        emailjs.init("0149jkoCQjJZn6JwD");

        const centervilleStaff = [
            { name: "Barr, Harvey", rank: "Firefighter", gfstc: "3353-4774" },
            { name: "Bennett, Kyle", rank: "Firefighter", gfstc: "0869-5796" },
            { name: "Bostick, David", rank: "Assistant Chief", gfstc: "7615-2424" },
            { name: "Cannon, James", rank: "Firefighter", gfstc: "7905-1906" },
            { name: "Carroll, James", rank: "Firefighter", gfstc: "7560-2340" },
            { name: "Dorman, David", rank: "Sergeant", gfstc: "3081-2978" },
            { name: "Dunn, Pierson", rank: "Firefighter", gfstc: "6345-7684" },
            { name: "Jones, Jason", rank: "Fire Chief", gfstc: "4472-9279" },
            { name: "Kahley, Chad", rank: "Captain", gfstc: "5486-6025" },
            { name: "Laimana, Joe", rank: "Firefighter", gfstc: "9183-2797" },
            { name: "Leatherwood, Jonathan", rank: "Firefighter", gfstc: "9823-3446" },
            { name: "Lightning, Larry", rank: "Firefighter", gfstc: "0711-8310" },
            { name: "McNeil, Drew", rank: "Firefighter", gfstc: "2676-9943" },
            { name: "Mixon, Joshua", rank: "Firefighter", gfstc: "4670-9305" },
            { name: "Mooney, William", rank: "Firefighter", gfstc: "9213-3048" },
            { name: "Orona, Adam", rank: "Firefighter", gfstc: "4438-5982" },
            { name: "Redd, Allen", rank: "Sergeant", gfstc: "7135-8934" },
            { name: "Rice, Aaron", rank: "Firefighter", gfstc: "9228-1494" },
            { name: "Schuler, Andrew", rank: "Firefighter", gfstc: "6748-5231" },
            { name: "Smith, Mikayla", rank: "Firefighter", gfstc: "1159-4178" },
            { name: "Stockholm, Jacob", rank: "Firefighter", gfstc: "5655-4571" },
            { name: "Talley, Dustin", rank: "Sergeant", gfstc: "3887-0449" },
            { name: "Thornton, Ethan", rank: "Firefighter", gfstc: "4221-3437" },
            { name: "Traxler, Clint", rank: "Engineer", gfstc: "3623-4177" },
            { name: "Wall, Kaleb", rank: "Firefighter", gfstc: "0701-7229" }
        ];

        const commonDescriptions = {
            "Company": "Company-level training focused on effective teamwork, communication, and task execution during fireground operations.",
            "Facility": "Training Conducted at the Centerville Training Facility located at 1111 Dunbar Road or an approved facility deemed by the Fire Chief or Georgia Firefighters Standards and Training. Facility Training Must be at least 3 hours and be considered fire suppression, victim rescue and other related fire task with PPE to be considered facility training.",
            "Officer": "Officer development training emphasizing leadership, decision-making, incident command, and crew supervision.",
            "Hazmat": "Hazardous materials awareness, operations, or technician-level training covering recognition, identification, and mitigation strategies.",
            "Driver (Roadway)": "Firefighter driver training is a comprehensive program designed to equip emergency personnel with the knowledge, skills, and judgment to operate large, heavy fire apparatus safely and efficiently in emergency and non-emergency situations. This training emphasizes safety through accident avoidance and adherence to legal requirements.",
            "Driver (Area Familiarization)": "Area familiarization training for firefighters is a continuous and proactive process designed to ensure that crews possess intimate knowledge of their first-due response area and the specific structures within it. This knowledge enhances situational awareness, improves response times, and is critical for both public and firefighter safety during emergencies.",
            "Driver (Pumper Training)": "Pumper operations training focusing on safe apparatus positioning, pump operation, water supply management, and hose deployment techniques.",
            "Driver (Aerial Training)": "Aerial operations training covering safe setup, stabilization, aerial device operation, and rescue/evacuation techniques from elevated positions.",
            "Recruit": "Recruit academy training covering foundational firefighting skills, safety, equipment use, and department policies and procedures.",
            "EMS": "Emergency medical services training focusing on patient assessment, treatment protocols, and safe patient handling and transport."
        };

        const commonObjectives = {
            "Company": "- Demonstrate effective fireground communication\n- Perform assigned tasks efficiently\n- Work as a cohesive team unit",
            "Facility": "- Training conducted at approved facility with minimum 3 hours duration\n- Focus on fire suppression, victim rescue, and related tasks while wearing full PPE",
            "Officer": "- Apply incident command principles\n- Make effective tactical decisions\n- Supervise personnel safely",
            "Hazmat": "- Recognize and identify hazardous materials\n- Implement initial protective actions\n- Initiate proper notification procedures",
            "Driver (Roadway)": "- Maneuvering large vehicles, including backing up and parallel parking with limited visibility\n- Negotiating narrow streets, sharp turns, and intersections safely\n- Defensive driving techniques and collision avoidance\n- Operating the vehicle under various weather and road conditions",
            "Driver (Area Familiarization)": "- Ensuring knowledge of street locations and optimal response routes\n- Locating water sources\n- Identifying target hazards\n- Understanding building construction types\n- Familiarization with a building's fire suppression and alarm system\n- Locating critical access points",
            "Driver (Pumper Training)": "- Correctly position apparatus for effective water supply\n- Operate pump controls accurately\n- Establish and maintain water supply\n- Deploy attack and supply lines efficiently",
            "Driver (Aerial Training)": "- Properly stabilize and set up aerial device\n- Safely operate aerial controls\n- Perform elevated rescues\n- Maintain safe working distances and angles",
            "Recruit": "- Demonstrate basic firefighting skills\n- Use personal protective equipment correctly\n- Follow department safety policies",
            "EMS": "- Perform accurate patient assessments\n- Administer appropriate treatments\n- Document patient care accurately"
        };

        let currentSignatureCell = null;
        const modal = document.getElementById('signatureModal');
        const canvas = document.getElementById('modalCanvas');
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#0000ff';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        let drawing = false;

        function startDrawing(e) {
            drawing = true;
            ctx.beginPath();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!drawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            drawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        document.getElementById('clearSignature').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

        document.getElementById('doneSignature').onclick = () => {
            if (!currentSignatureCell) return;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(canvas, 0, 0);
            const dataURL = tempCanvas.toDataURL('image/jpeg', 0.95);
            const img = document.createElement('img');
            img.className = 'signature-display';
            img.src = dataURL;
            currentSignatureCell.innerHTML = '';
            currentSignatureCell.appendChild(img);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove Signature';
            removeBtn.onclick = () => {
                currentSignatureCell.innerHTML = '<button type="button" class="sign-btn">Sign</button>';
                addSignatureListener(currentSignatureCell);
            };
            currentSignatureCell.appendChild(removeBtn);
            modal.style.display = 'none';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        function addSignatureListener(cell) {
            const signBtn = cell.querySelector('.sign-btn');
            if (signBtn) {
                signBtn.onclick = () => {
                    currentSignatureCell = cell;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    modal.style.display = 'flex';
                };
            }
        }

        let manualTotalHours = false;

        const timeInputs = ['start-hour', 'start-minute', 'end-hour', 'end-minute'];

        function calculateTotalHours() {
            const sh = parseInt(document.getElementById('start-hour').value) || 0;
            const sm = parseInt(document.getElementById('start-minute').value) || 0;
            const eh = parseInt(document.getElementById('end-hour').value) || 0;
            const em = parseInt(document.getElementById('end-minute').value) || 0;

            if (isNaN(sh) || isNaN(sm) || isNaN(eh) || isNaN(em)) {
                return;
            }

            let hours = eh - sh;
            let mins = em - sm;
            if (mins < 0) { mins += 60; hours--; }
            if (hours < 0) hours += 24;

            document.getElementById('total-hours').value = (hours + mins / 60).toFixed(2);
        }

        function addPersonRow(tableId, isCenterville) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const row = tbody.insertRow();
            if (isCenterville) {
                let options = '<option value="">-- Select Name --</option>';
                centervilleStaff.forEach(p => options += `<option value="${p.name}">${p.name}</option>`);
                row.innerHTML = `<td><select class="person-name">${options}</select></td><td><input type="text" class="person-rank" readonly></td><td><input type="text" class="person-gfstc" readonly></td><td><button type="button" class="sign-btn">Sign</button></td>`;
                row.querySelector('.person-name').addEventListener('change', function () {
                    const person = centervilleStaff.find(p => p.name === this.value);
                    row.querySelector('.person-rank').value = person ? person.rank : '';
                    row.querySelector('.person-gfstc').value = person ? person.gfstc : '';
                });
            } else {
                row.innerHTML = `<td><input type="text" placeholder="Name"></td><td><input type="text" placeholder="Rank"></td><td><input type="text" placeholder="GFSTC #"></td><td><button type="button" class="sign-btn">Sign</button></td>`;
            }
            addSignatureListener(row.cells[3]);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove Row';
            removeBtn.onclick = () => row.remove();
            row.cells[3].appendChild(removeBtn);
        }

        function addGradingRow() {
            const tbody = document.querySelector('#grading-points-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `<td><input type="text" placeholder="Grading Point"></td><td><select><option>-- Proficiency --</option><option>Proficient</option><option>Needs Improvement</option></select></td><td><input type="text" placeholder="Comments"></td>`;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => row.remove();
            row.insertCell().appendChild(removeBtn);
        }

        function addEquipmentRow() {
            const tbody = document.querySelector('#facility-equipment-table tbody');
            const row = tbody.insertRow();
            row.innerHTML = `<td><input type="text" placeholder="Equipment Used"></td><td><div class="damaged-buttons"><button type="button" class="damaged-btn damaged-no">No</button><button type="button" class="damaged-btn damaged-yes">Yes</button></div></td><td><input type="text" placeholder="Comments"></td><td></td>`;
            const noBtn = row.querySelector('.damaged-no');
            const yesBtn = row.querySelector('.damaged-yes');
            noBtn.classList.add('selected');
            noBtn.onclick = () => { noBtn.classList.add('selected'); yesBtn.classList.remove('selected'); };
            yesBtn.onclick = () => { yesBtn.classList.add('selected'); noBtn.classList.remove('selected'); };
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => row.remove();
            row.cells[3].appendChild(removeBtn);
        }

        const FORM_STORAGE_KEY = 'centervilleTrainingReportDraft';

        function collectFormData() {
            const data = {
                trainingTitle: document.getElementById('training-title').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value || document.getElementById('start-date').value,
                selectedShifts: document.getElementById('selected-shifts').value,
                startHour: document.getElementById('start-hour').value,
                startMinute: document.getElementById('start-minute').value,
                endHour: document.getElementById('end-hour').value,
                endMinute: document.getElementById('end-minute').value,
                totalHours: document.getElementById('total-hours').value,
                location: document.getElementById('location').value,
                isoCategory: document.getElementById('iso-category').value,
                description: document.getElementById('description').value,
                objectives: document.getElementById('objectives').value,
                instructors: [],
                studentsCenterville: [],
                studentsOutside: [],
                gradingPoints: [],
                equipment: []
            };

            if (document.getElementById('drivers-training-section').style.display !== 'none') {
                data.drivers = {
                    apparatusType: document.getElementById('apparatus-type').value || '',
                    roadConditions: document.getElementById('road-conditions').value || '',
                    weatherConditions: document.getElementById('weather-conditions').value || '',
                    trafficConditions: document.getElementById('traffic-conditions').value || '',
                    apparatusMiles: document.getElementById('apparatus-miles').value || '',
                    apparatusHours: document.getElementById('apparatus-hours').value || '',
                    actualMiles: document.getElementById('actual-miles').value || ''
                };
            }

            const collectTable = (tableId, isPerson = false) => {
                const rows = [];
                document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
                    const cells = row.cells;
                    const rowData = {};
                    if (isPerson) {
                        rowData.name = cells[0].querySelector('input, select')?.value || '';
                        rowData.rank = cells[1].querySelector('input')?.value || '';
                        rowData.gfstc = cells[2].querySelector('input')?.value || '';
                        rowData.signature = cells[3].querySelector('img')?.src || '';
                    } else if (tableId.includes('equipment')) {
                        rowData.equipment = cells[0].querySelector('input')?.value || '';
                        rowData.damaged = row.querySelector('.damaged-btn.selected')?.textContent.trim() || 'No';
                        rowData.comments = cells[2].querySelector('input')?.value || '';
                    } else {
                        rowData.point = cells[0].querySelector('input')?.value || '';
                        rowData.proficiency = cells[1].querySelector('select')?.value || '';
                        rowData.comments = cells[2].querySelector('input')?.value || '';
                    }
                    if (Object.values(rowData).some(v => v)) rows.push(rowData);
                });
                return rows;
            };

            data.instructors = collectTable('instructors-table', true);
            data.studentsCenterville = collectTable('students-centerville-table', true);
            data.studentsOutside = collectTable('students-outside-table', true);
            data.gradingPoints = collectTable('grading-points-table');
            data.equipment = collectTable('facility-equipment-table');
            return data;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            const options = { year: 'numeric', month: 'long', day: '2-digit' };
            return date.toLocaleDateString('en-US', options);
        }

        async function generateTrainingReportPDF() {
            const data = collectFormData();
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true });
            const RED = [220, 38, 38];
            const BLACK = [0, 0, 0];
            const pageW = pdf.internal.pageSize.getWidth();
            const pageH = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const headerH = 28;
            let y = margin + headerH;
            let pageCount = 1;
            const maxPages = 5;
            let truncated = false;

            function drawHeader() {
                pdf.setFont('times', 'bold');
                pdf.setFontSize(20);
                pdf.setTextColor(...BLACK);
                pdf.text('Centerville Fire Department', pageW / 2, margin + 8, { align: 'center' });
                pdf.setFontSize(16);
                pdf.text('Training Report', pageW / 2, margin + 16, { align: 'center' });
                pdf.setFontSize(14);
                pdf.text(data.trainingTitle || 'Untitled Training', pageW / 2, margin + 24, { align: 'center' });
                pdf.setDrawColor(...RED);
                pdf.setLineWidth(0.8);
                pdf.line(margin, margin + 30, pageW - margin, margin + 30);
            }

            function addNewPage() {
                if (pageCount >= maxPages) {
                    truncated = true;
                    return false;
                }
                pdf.addPage();
                pageCount++;
                drawHeader();
                y = margin + headerH;
                return true;
            }

            function sectionTitle(title) {
                pdf.setFontSize(14);
                pdf.setTextColor(...RED);
                pdf.text(title, margin, y);
                y += 8;
                pdf.setDrawColor(...RED);
                pdf.setLineWidth(0.5);
                pdf.line(margin, y - 2, margin + pdf.getTextWidth(title), y - 2);
                y += 6;
            }

            function renderPerson(person, centerX, startY) {
                let currY = startY;
                pdf.setFontSize(11);
                pdf.setFont('times', 'bold');
                pdf.setTextColor(...BLACK);
                const nameLine = `${person.name || 'N/A'}${person.gfstc ? ` (GFSTC: ${person.gfstc})` : ''}`;
                pdf.text(nameLine, centerX, currY, { align: 'center' });
                currY += 2;
                if (person.signature) {
                    pdf.addImage(person.signature, 'JPEG', centerX - 35, currY, 60, 20, undefined, 'FAST');
                    currY += 25;
                } else {
                    currY += 25;
                }
                pdf.setFont('times', 'bold');
                pdf.setFontSize(10);
                pdf.text(`Rank: ${person.rank || 'N/A'}`, centerX, currY, { align: 'center' });
                return currY + 10;
            }

            function renderFourStudents(students, startIdx) {
                const positions = [pageW * 0.25, pageW * 0.75, pageW * 0.25, pageW * 0.75];
                let row1H = 0, row2H = 0, currY = y;
                for (let i = 0; i < 2 && startIdx + i < students.length; i++) {
                    const h = renderPerson(students[startIdx + i], positions[i], currY) - currY;
                    row1H = Math.max(row1H, h);
                }
                currY += row1H;
                for (let i = 0; i < 2 && startIdx + 2 + i < students.length; i++) {
                    const h = renderPerson(students[startIdx + 2 + i], positions[i + 2], currY) - currY;
                    row2H = Math.max(row2H, h);
                }
                y = currY + row2H + 10;
                return Math.min(4, students.length - startIdx);
            }

            function renderTwoInstructors(instructors, startIdx) {
                const positions = [pageW * 0.35, pageW * 0.75];
                let rowH = 0;
                let currY = y;
                for (let i = 0; i < 2 && startIdx + i < instructors.length; i++) {
                    const h = renderPerson(instructors[startIdx + i], positions[i], currY) - currY;
                    rowH = Math.max(rowH, h);
                }
                y = currY + rowH + 10;
                return Math.min(2, instructors.length - startIdx);
            }

            function drawPage1Content() {
                y += 10;
                pdf.setFontSize(11);
                pdf.setTextColor(...BLACK);
                const startFormatted = formatDate(data.startDate);
                const endFormatted = formatDate(data.endDate);
                const dateDisplay = (data.endDate && data.endDate !== data.startDate) ? `${startFormatted} – ${endFormatted}` : startFormatted;

                const meta = [
                    `Dates: ${dateDisplay}`,
                    `Shift(s): ${data.selectedShifts || 'None'}`,
                    `Time: ${data.startHour || '??'}:${data.startMinute || '??'} – ${data.endHour || '??'}:${data.endMinute || '??'} (${data.totalHours || '0'} hours)`,
                    `Location: ${data.location || 'N/A'}`,
                    `ISO Category: ${data.isoCategory || 'N/A'}`
                ];
                meta.forEach((line, i) => pdf.text(line, margin, y + i * 6));

                if (data.instructors.length > 0) {
                    const instructorX = pageW - margin - 80;
                    pdf.setFontSize(11);
                    pdf.setFont('times', 'bold');
                    pdf.text('Primary Instructor:', instructorX, y);
                    y += 12;
                    renderPerson(data.instructors[0], instructorX + 40, y - 7);
                }

                y += 40;
                sectionTitle('Description of Training');
                pdf.setFont('times', 'normal');
                pdf.setFontSize(11);
                pdf.setTextColor(...BLACK);
                const descLines = pdf.splitTextToSize(data.description || 'No description provided', pageW - 25);
                pdf.text(descLines, margin, y);
                y += descLines.length * 5 + 2;

                sectionTitle('Training Objectives');
                pdf.setFont('times', 'normal');
                pdf.setFontSize(11);
                pdf.setTextColor(...BLACK);
                const objLines = pdf.splitTextToSize(data.objectives || 'No objectives provided', pageW - 25);
                pdf.text(objLines, margin, y);
                y += objLines.length * 5.5 + 5;
            }

            drawHeader();
            drawPage1Content();

            const allStudents = [...data.studentsCenterville, ...data.studentsOutside];
            let studentIdx = 0;
            if (allStudents.length > 0) {
                sectionTitle('Students');
                while (studentIdx < allStudents.length) {
                    const added = renderFourStudents(allStudents, studentIdx);
                    studentIdx += added;
                    if (studentIdx < allStudents.length) {
                        if (!addNewPage()) break;
                        drawPage1Content();
                        sectionTitle('Students (Continued)');
                    }
                }
            }

            const extraInstructors = data.instructors.slice(1);
            const hasSupplemental = data.drivers || data.equipment.length > 0 || extraInstructors.length > 0;
            if (hasSupplemental && pageCount < maxPages) {
                addNewPage();
                pdf.setFontSize(16);
                pdf.setTextColor(...RED);
                pdf.text('Supplemental Training Form', pageW / 2, margin + headerH - 30, { align: 'center' });
                y = margin + headerH + 10;

                if (data.drivers) {
                    sectionTitle('Drivers Training Report');
                    pdf.setFontSize(11);
                    pdf.setTextColor(...BLACK);
                    pdf.text(`Apparatus Type: ${data.drivers.apparatusType || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Road Conditions: ${data.drivers.roadConditions || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Weather Conditions: ${data.drivers.weatherConditions || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Traffic Conditions: ${data.drivers.trafficConditions || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Apparatus Miles: ${data.drivers.apparatusMiles || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Apparatus Hours: ${data.drivers.apparatusHours || 'N/A'}`, margin, y); y += 6;
                    pdf.text(`Actual Miles Driven: ${data.drivers.actualMiles || 'N/A'}`, margin, y); y += 10;

                    if (data.gradingPoints.length > 0) {
                        sectionTitle('Driver Grading Points');
                        pdf.setFontSize(11);
                        pdf.setTextColor(...BLACK);
                        data.gradingPoints.forEach(gp => {
                            pdf.text(`Grading Point: ${gp.point || 'Not specified'}`, margin, y); y += 6;
                            pdf.text(`  Proficiency: ${gp.proficiency || 'Not assessed'}`, margin, y); y += 6;
                            if (gp.comments) {
                                pdf.text(`  Comment: ${gp.comments}`, margin, y); y += 6;
                            }
                            y += 4;
                        });
                    }
                    y += 10;
                }

                if (data.equipment.length > 0) {
                    sectionTitle('Facility Equipment Used');
                    pdf.setFontSize(11);
                    pdf.setTextColor(...BLACK);
                    data.equipment.forEach(eq => {
                        pdf.text(`Equipment: ${eq.equipment || 'Unknown'}`, margin, y); y += 6;
                        pdf.text(`  Damaged: ${eq.damaged || 'No'}`, margin, y); y += 6;
                        if (eq.comments) {
                            pdf.text(`  Comment: ${eq.comments}`, margin, y); y += 6;
                        }
                        y += 4;
                    });
                    y += 10;
                }

                if (extraInstructors.length > 0) {
                    sectionTitle('Additional Instructors');
                    let instIdx = 0;
                    while (instIdx < extraInstructors.length) {
                        const added = renderTwoInstructors(extraInstructors, instIdx);
                        instIdx += added;
                        if (instIdx < extraInstructors.length) {
                            if (!addNewPage()) break;
                            sectionTitle('Additional Instructors (Continued)');
                        }
                    }
                }
            }

            if (truncated) {
                pdf.setFontSize(10);
                pdf.setTextColor(...BLACK);
                pdf.text('Content truncated to fit 5-page limit.', margin, y);
            }

            const safeTitle = (data.trainingTitle || 'Training_Report').replace(/[^a-z0-9]/gi, '_').substring(0, 50);
            const filename = `Centerville_Training_${safeTitle}_${new Date().toISOString().slice(0,10)}_Signed.pdf`;
            const pdfBase64 = pdf.output('datauristring').split(',')[1];
            return { pdfBase64, filename };
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('start-date').value) {
                document.getElementById('start-date').value = '2026-01-04';
            }

            document.getElementById('iso-category').addEventListener('change', function () {
                const val = this.value;
                const driversSection = document.getElementById('drivers-training-section');
                const isDriver = ['Driver (Roadway)', 'Driver (Pumper Training)', 'Driver (Aerial Training)'].includes(val);
                driversSection.style.display = isDriver ? 'block' : 'none';
                document.getElementById('description').value = commonDescriptions[val] || '';
                document.getElementById('objectives').value = commonObjectives[val] || '';
            });

            timeInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', function () {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length === 2) {
                        const next = timeInputs.indexOf(id) + 1;
                        if (next < timeInputs.length) document.getElementById(timeInputs[next]).focus();
                    }
                    if (!manualTotalHours) calculateTotalHours();
                });
                input.addEventListener('blur', function () {
                    let val = parseInt(this.value) || 0;
                    if (id.includes('hour')) val = Math.min(23, val);
                    if (id.includes('minute')) val = Math.min(59, val);
                    this.value = val.toString().padStart(2, '0');
                    if (!manualTotalHours) calculateTotalHours();
                });
            });

            document.getElementById('total-hours').addEventListener('input', () => {
                manualTotalHours = true;
            });

            ['shift-days', 'shift-1', 'shift-2', 'shift-3', 'shift-pt'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        updateSelectedShifts();
                    });
                }
            });

            function updateSelectedShifts() {
                const selected = Array.from(document.querySelectorAll('.shift-btn.selected')).map(btn => btn.textContent.trim());
                document.getElementById('selected-shifts').value = selected.join(', ') || 'None';
            }

            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const textarea = btn.closest('.form-group').querySelector('textarea');
                    if (textarea) {
                        try {
                            await navigator.clipboard.writeText(textarea.value);
                        } catch {
                            textarea.select();
                            document.execCommand('copy');
                        }
                        const feedback = btn.closest('.form-group').querySelector('.copy-feedback');
                        feedback.style.opacity = 1;
                        setTimeout(() => feedback.style.opacity = 0, 1500);
                    }
                });
            });

            document.getElementById('other-personnel-toggle').addEventListener('click', () => {
                const section = document.getElementById('outside-students-section');
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
                document.getElementById('other-personnel-toggle').classList.toggle('active');
            });

            document.getElementById('add-instructor').addEventListener('click', () => addPersonRow('instructors-table', true));
            document.getElementById('add-student-centerville').addEventListener('click', () => addPersonRow('students-centerville-table', true));
            document.getElementById('add-student-outside').addEventListener('click', () => addPersonRow('students-outside-table', false));
            document.getElementById('add-grading-point').addEventListener('click', addGradingRow);
            document.getElementById('add-equipment').addEventListener('click', addEquipmentRow);

            document.getElementById('save-report-btn').addEventListener('click', () => {
                const btn = document.getElementById('save-report-btn');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.btn-loading');
                text.style.display = 'none';
                loading.style.display = 'inline';
                btn.disabled = true;
                const data = collectFormData();
                localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
                setTimeout(() => {
                    text.textContent = 'Saved!';
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.style.background = '#16a34a';
                    setTimeout(() => {
                        text.textContent = 'Save Report';
                        btn.style.background = '#2563eb';
                        btn.disabled = false;
                    }, 1500);
                }, 500);
            });

            document.getElementById('send-email-btn').addEventListener('click', async () => {
                const btn = document.getElementById('send-email-btn');
                btn.disabled = true;
                btn.textContent = 'Sending...';
                try {
                    const { pdfBase64, filename } = await generateTrainingReportPDF();
                    const formData = collectFormData();
                    await emailjs.send('service_2gdxvws', 'template_wj80wlx', {
                        training_title: formData.trainingTitle || 'Centerville Training Report',
                        training_date: formatDate(formData.startDate) + (formData.endDate && formData.endDate !== formData.startDate ? ' to ' + formatDate(formData.endDate) : ''),
                        attachment_pdf: pdfBase64,
                        attachment_filename: filename
                    });
                    alert('Training report emailed successfully!');
                    if (confirm('Clear saved draft? (Only OK if all shifts have signed)')) {
                        localStorage.removeItem(FORM_STORAGE_KEY);
                    }
                } catch (err) {
                    console.error('Email error:', err);
                    alert('Send failed. Please check internet and console.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Send via Email';
                }
            });

            document.getElementById('print-preview-btn').addEventListener('click', async () => {
                const btn = document.getElementById('print-preview-btn');
                btn.disabled = true;
                btn.textContent = 'Generating...';
                try {
                    const { pdfBase64 } = await generateTrainingReportPDF();
                    const blob = new Blob([Uint8Array.from(atob(pdfBase64), c => c.charCodeAt(0))], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const printWindow = window.open(url, '_blank');
                    if (printWindow) {
                        printWindow.onload = () => printWindow.print();
                    } else {
                        alert('Please allow popups for Print Preview.');
                    }
                    setTimeout(() => URL.revokeObjectURL(url), 30000);
                } catch (err) {
                    console.error(err);
                    alert('Preview failed');
                }
                btn.textContent = 'Print Preview';
                btn.disabled = false;
            });

            document.getElementById('clear-form-btn').addEventListener('click', () => {
                if (confirm('Clear everything and delete saved draft?')) {
                    document.getElementById('trainingForm').reset();
                    localStorage.removeItem(FORM_STORAGE_KEY);
                    location.reload();
                }
            });
        });

        window.addEventListener('load', () => {
            const saved = localStorage.getItem(FORM_STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('training-title').value = data.trainingTitle || '';
                    document.getElementById('start-date').value = data.startDate || '';
                    document.getElementById('end-date').value = data.endDate || '';
                    document.getElementById('selected-shifts').value = data.selectedShifts || '';
                    document.getElementById('start-hour').value = data.startHour || '';
                    document.getElementById('start-minute').value = data.startMinute || '';
                    document.getElementById('end-hour').value = data.endHour || '';
                    document.getElementById('end-minute').value = data.endMinute || '';
                    document.getElementById('total-hours').value = data.totalHours || '';
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('iso-category').value = data.isoCategory || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('objectives').value = data.objectives || '';

                    const shifts = (data.selectedShifts || '').split(', ');
                    document.querySelectorAll('.shift-btn').forEach(btn => {
                        btn.classList.toggle('selected', shifts.includes(btn.textContent.trim()));
                    });

                    document.getElementById('iso-category').dispatchEvent(new Event('change'));
                } catch (e) {
                    console.error(e);
                }
            }
        });
    </script>
</body>
</html>
